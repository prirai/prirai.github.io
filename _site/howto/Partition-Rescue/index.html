<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML
><HEAD
><TITLE
>Partition-Rescue</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"><link rel="stylesheet" href="../bookstyle.css"></HEAD
><BODY
CLASS="article"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="title"
><A
NAME="AEN2"
></A
>Partition-Rescue</H1
><DIV
CLASS="revhistory"
><TABLE
WIDTH="100%"
BORDER="0"
><TR
><TH
ALIGN="LEFT"
VALIGN="TOP"
COLSPAN="3"
><B
>Revision History</B
></TH
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1</TD
><TD
ALIGN="LEFT"
>2008-11-24 09:27:50</TD
><TD
ALIGN="LEFT"
>Revised by: jdd</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>mainly title change in the wiki</TD
></TR
></TABLE
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
>1. <A
HREF="#AEN12"
>Revision History</A
></DT
><DT
>2. <A
HREF="#AEN39"
>Beginning</A
></DT
><DD
><DL
><DT
>2.1. <A
HREF="#AEN41"
>What's in</A
></DT
><DT
>2.2. <A
HREF="#AEN57"
>What to do right now?</A
></DT
><DT
>2.3. <A
HREF="#AEN73"
>Legal stuff</A
></DT
><DT
>2.4. <A
HREF="#AEN78"
>What do I need to know right now?</A
></DT
></DL
></DD
><DT
>3. <A
HREF="#AEN88"
>Technical info</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="#AEN90"
>Disks</A
></DT
><DT
>3.2. <A
HREF="#AEN100"
>Partitions</A
></DT
><DT
>3.3. <A
HREF="#AEN118"
>Why is there a problem?</A
></DT
></DL
></DD
><DT
>4. <A
HREF="#AEN122"
>Solving the problem</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="#AEN125"
>The simpler case</A
></DT
><DT
>4.2. <A
HREF="#AEN161"
>A not-so-simple case</A
></DT
><DT
>4.3. <A
HREF="#AEN321"
>The rich man's case</A
></DT
><DT
>4.4. <A
HREF="#AEN325"
>PMagic</A
></DT
></DL
></DD
><DT
>5. <A
HREF="#AEN329"
>References</A
></DT
><DD
><DL
><DT
>5.1. <A
HREF="#AEN331"
>Authors</A
></DT
><DT
>5.2. <A
HREF="#AEN342"
>Most recent version</A
></DT
></DL
></DD
></DL
></DIV
><P
><STRONG
>"Partition-Rescue HOWTO" - Jean-Daniel Dodin</STRONG
> </P
><DIV
CLASS="section"
><HR><H1
CLASS="section"
><A
NAME="AEN12"
></A
>1. Revision History</H1
><P
>Revision V4.1 - 2008-11-24 - Revised by <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Title fix (the wiki have to get the exact name of the HOWTO)</P
><P
> Revision v4 - 2008-08-29 - Revised by: <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Major update - First complete revised wiki version</P
><P
> Revision v3.7 - 2008-05-30 - Revised by: <A
HREF="http://wiki.tldp.org/rm#"
TARGET="_top"
>rm</A
></P
><P
> Minor update - lots of little punctuation, spelling, usage, and grammar nits :-)</P
><P
> Revision v3.6 - 2008-05-25 - Revised by: <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Major update - LDP wiki - addition about logical partitions</P
><P
> Revision v3.5 - 2003-10-31 - Revised by: <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Major update - new licence - some fixes in addresses - vi use :-)</P
><P
> Revision v3.4 - 2002-08-22 - Revised by: <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Minor update related only with docbook</P
><P
> Revision v3.3 - 2001-11-17 - Revised by: <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Minor update - docbook &#38; revision history - emacs use.</P
><P
> Revision v3.2 - 2001-09-25 - Revised by: <A
HREF="http://wiki.tldp.org/jdd#"
TARGET="_top"
>jdd</A
></P
><P
> Major update. </P
><P
>Whow! My disk is empty! My Linux is gone! If you have or fear to have one day or another such a problem, read this... </P
></DIV
><DIV
CLASS="section"
><HR><H1
CLASS="section"
><A
NAME="AEN39"
></A
>2. Beginning</H1
><DIV
CLASS="section"
><H2
CLASS="section"
><A
NAME="AEN41"
></A
>2.1. What's in</H2
><P
>This HOWTO addresses only the "lost partition table" problem. This can be when: </P
><P
></P
><UL
><LI
><P
>you have no more access to your computer, with the "no operating system" message; </P
></LI
><LI
><P
>you have installed a new system (i.e., MS Windows) and you see no more Linux, and MS Windows takes up all the capacity of the disk; </P
></LI
><LI
><P
>you have just partitioned the wrong drive with fdisk (for example, in the process of changing your hard drive). </P
></LI
></UL
><P
>Here, you will learn that, if you know the right thing and do it, Linux comes usually safe from such things. MS Windows can, but it's luckier. </P
><P
>We will first see what you can do <EM
>before</EM
> the problem to ease future recovery, and what you must do <EM
>after</EM
> to recover. There is little to do to prevent from erasing a disk; usually this is done by automatic MS Windows or Linux-install ill-behaved programs or users' mistakes - nothing can be done to prevent this, except care, but you are already careful, aren't you? </P
><P
>It can also be done by the use of MS-DOS/Windows fdisk. Avoid it as most as you can, but you probably can't. </P
><P
>I have done this many times, on my computer and on other guys' computers, and restored Linux most of the time and MS Windows sometimes. I wish you luck! </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN57"
></A
>2.2. What to do right now?</H2
><P
>If you don't have any problem yet, if you read this by curiosity or are just seeking information, and you are on a running Linux system, do immediately the following : </P
><P
></P
><UL
><LI
><P
>open a root terminal or xterm; </P
></LI
><LI
><P
>key in <FONT
COLOR="RED"
>/sbin/fdisk -l</FONT
> (that last character being l for Lima). Then do <FONT
COLOR="RED"
>fdisk -u -l</FONT
>; </P
></LI
></UL
><P
>You will be gratified to see a list of all current partitions, on all disks present on your computer. The second one gives the listing in units of sectors, in place of cylinders, and this is sometimes necessary. </P
><P
></P
><UL
><LI
><P
>Write this back on paper (or do "<FONT
COLOR="RED"
>/sbin/fdisk -l | lpr</FONT
>" and "<FONT
COLOR="RED"
>/sbin/fdisk -u -l | lpr</FONT
>" to print it) and save it in a safe place for future use. If you are not the system administrator, you should not be concerned by the problem, and can stop reading this. </P
></LI
></UL
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN73"
></A
>2.3. Legal stuff</H2
><P
>This HOWTO is Copyright (c) 2000-2008 by Jean-Daniel Dodin. As of November 2003, the licence is LGPL. </P
><P
>I am not responsible of any damage on any computer as a result of anyone reading this HOWTO. If you do any damage, <EM
>it is YOUR fault, NOT MINE</EM
>! Be careful when partitioning disks, and don't make any mistakes, because it can be fatal! Backup all your important data and check that everything you do is correct! What is described here worked on my computer, but it may or may not work on your computer. Although it should work for everyone, I can't guarantee anything. This is the last warning you get: BACKUP IMPORTANT DATA! Or, to put it concisely: Use at your own risk! </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN78"
></A
>2.4. What do I need to know right now?</H2
><P
>You <EM
>need</EM
> to know that, in case of any major problem with your hard disk, you <EM
>need</EM
> to stop using it in <EM
>write</EM
> mode, at least until the time for you to understand what's happening. Information there is very volatile... </P
><P
>If ever, one morning, awaking, your computer says "can't load, no system installed", you <EM
>must not begin reinstalling all the stuff</EM
>. </P
><P
>If you have MS Windows installed, I can't promise you can recover your data, but it's likely you will recover all your Linux stuff, provided it's not located too low (near the beginning of the disk) in the disk structure. This is because some MS Windows viruses erase the very first disk cylinder, whatever is on. However I didn't ever experiment with such viruses, and can't say for sure. Try recovering, anyway. </P
><P
>You must also know that I give you all this information only for this - information purposes. Neither I nor any other people but you can be held responsible for any problem your data can have using this info. There are too many different systems on the world for anybody being able to promise anything. I can only wish you luck and hope that you, like me, will be happy recovering data. </P
></DIV
></DIV
><DIV
CLASS="section"
><HR><H1
CLASS="section"
><A
NAME="AEN88"
></A
>3. Technical info</H1
><DIV
CLASS="section"
><H2
CLASS="section"
><A
NAME="AEN90"
></A
>3.1. Disks</H2
><P
>A hard disk is made of sectors numbered from 0 to the max. </P
><P
>dmesg gives, for example: </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>hdb: ST34321A, 4103MB w/128kB Cache, CHS=523/255/63</PRE
></FONT
></TD
></TR
></TABLE
><P
>CHS means Cylinders, Heads, Sectors. </P
><P
>523*255*63=8401995 sectors of 512 bytes, thus the 4103 MB. This is only a logical map; it's not necessarily what is written on the disk cover (except for the total size). </P
><P
>The true size of the sectors is of no interest for us, given that we don't want to modify anything, but merely wish to restore a previous state. For us, the default size given by fdisk is all right. </P
><P
>The size seen by the system is directly dependent on the work of the BIOS (Basic Input/Output System - the PC's ROM). The mode of the hard disk indicated in the BIOS is essential. On a new disk, it's better to use BIOS automatic hard disk recognition and say "yes". Anyway, any modification at this level may destroy all the data of the disk, so don't play with this without essential reason. </P
><P
>This is probably what your disk already uses, so don't be afraid. </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN100"
></A
>3.2. Partitions</H2
><P
>Disk are now huge -- 500 GB drives are not rare -- so it's not really handy to have all this stuff packed in only one part. Only MS Windows does so, and, if you use Linux, maybe it's because you are aware of how inefficient the other is. </P
><P
>So a hard disk is usually cut in some pieces called "partitions" (see the <A
HREF="http://tldp.org/HOWTO/Partition/index.html"
TARGET="_top"
>Partition HOWTO</A
> for details, also read <EM
>README.fdisk</EM
> on the web or on your disk - location vary). </P
><P
>Let's get a look at (part of) my own print of <FONT
COLOR="RED"
>fdisk -l</FONT
> : </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>Disk /dev/hdb: 255 heads, 63 sectors, 523 cylinders
Units = cylinders of 16065 * 512 bytes
Device Boot Start End Blocks Id System
/dev/hdb1 1 153 1228941 83 Linux
/dev/hdb2 154 166 104422+ 82 Linux swap
/dev/hdb3 * 167 291 1004062+ 83 Linux
/dev/hdb4 295 523 1839442+ 5 Extended
/dev/hdb5 295 422 1028128+ 83 Linux
/dev/hdb6 423 523 811251 6 FAT16</PRE
></FONT
></TD
></TR
></TABLE
><P
>This is my second hard disk, tied to guesses and tries. (The first is too simple to be interesting.) </P
><P
>/dev/hdb is my second ide disk (slave on the primary interface), </P
><P
>/dev/hdb1 is the first primary partition, running from the first (1) block to the block 153. </P
><P
>There can be four such primary partitions. If one wants more than 4, one of them must be repurposed as an "extended" partition (not necessarily the fourth), and all other partitions are "logical" and are located <EM
>inside</EM
> the extended one. Notice that partition number 5 and partition number 4 have the same beginning. Number five is logical, number 4 extended. Logical partitions' numbering always begins at 5, even if there are only 2 primary partitions. </P
><P
>Here's the <FONT
COLOR="RED"
>fdisk -u -l</FONT
> listing of an other disk: </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>Disque /dev/hda : 240 têtes, 63 secteurs, 2584
cylindres Unités = secteurs sur 1 * 512 octets
Périphérique Amorce Début Fin Blocs Id Système
/dev/hda1 * 63 10357199 5178568+ c Win95 FAT32 (LBA)
/dev/hda2 15452640 39070079 11808720 83 Linux
/dev/hda3 10357200 15150239 2396520 f Win95 Etdue (LBA)
/dev/hda4 15150240 15452639 151200 84 Lecteur C: caché OS/2
/dev/hda5 10357263 10463039 52888+ 83 Linux
/dev/hda6 10463103 10780559 158728+ 82 Echange Linux
/dev/hda7 10780623 15150239 2184808+ 6 FAT16
Les entrées de la table de partitions ne suivent pas l'ordre du disque.</PRE
></FONT
></TD
></TR
></TABLE
><P
>Don't worry about the French part, I'm French ... look at your own disk listing. Of course, numbers are bigger. </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN118"
></A
>3.3. Why is there a problem?</H2
><P
>The problem is that all installed operating systems must share the disks, and, since at start, the BIOS only scans the first one, there must be a so called "partition table" at the very beginning of this disk. This partition table is located in the Master Boot Record (MBR), side by side with the boot loader. </P
><P
>Any misuse of the MBR by any of the OS's leads to problems. When trying to install any system, a "yes" answer at a question like "automatic partitioning?" is likely to give problems... This is specially true with MS Windows, and especially with custom MS Windows installations made by special makes' PCs (when no true "Windows" CD is included, as with many laptops). But it's also true with some "smart" (not so smart!) Linux installation programs included with some distributions (hopefully this is not more the case in 2008). </P
></DIV
></DIV
><DIV
CLASS="section"
><HR><H1
CLASS="section"
><A
NAME="AEN122"
></A
>4. Solving the problem</H1
><P
>Please, beware! Following the explanations given here will lead you to revert back to a previous system, losing all your recent changes, if any! You must choose... </P
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN125"
></A
>4.1. The simpler case</H2
><P
>All is simple if you have at hand: </P
><P
></P
><UL
><LI
><P
>A disk (floppy, usb key or CD) able to start Linux by itself with fdisk available - most rescue disks of any distribution can do that; </P
></LI
><LI
><P
>A paper with the <FONT
COLOR="RED"
>fdisk -l</FONT
> and <FONT
COLOR="RED"
>fdisk -u -l</FONT
> content written down. </P
></LI
></UL
><P
>It's enough to: </P
><P
></P
><OL
TYPE="1"
><LI
><P
>Start Linux; </P
></LI
><LI
><P
>Start <FONT
COLOR="RED"
>fdisk /dev/hda</FONT
> (or whatever is the disk to rescue); </P
></LI
><LI
><P
>Use fdisk to delete (d option) all the existing partitions on the damaged disk; </P
></LI
><LI
><P
>Use fdisk to create all the primary (1 - 4) partitions mentioned on the paper; </P
></LI
><LI
><P
>Give them the appropriate tag (t option) : 82 is for Linux swap, 83 for Linux main (L gives you the list), 5 is extended and must be done before creating logical partitions, c is MS Windows FAT32, and f is MS Windows extended when 6 is MS Windows FAT16. </P
></LI
><LI
><P
>Create any logical partition. </P
></LI
></OL
><P
>On my SUSE installation and any time I had to do this for other people, this has produced good results. </P
><P
>However, I said that some fdisks may cut partitions on a sector basis, not cylinder. So the <FONT
COLOR="RED"
>fdisk -u -l</FONT
> version of the paper. </P
><P
>For using the <FONT
COLOR="RED"
>fdisk -u -l</FONT
> listing one must start <FONT
COLOR="RED"
>fdisk -u</FONT
> :-). In my opinion, using sector limit is a very bad idea, but it may have a real use I'm not aware of. The problem is that, with cylinder limit, it's easy to guess even if you don't have paper. With sector one, there are many more guesses... </P
><P
>fdisk is a small and very smart programs. There are many other makes of fdisk, but I always prefer the bare bones one. (I speak of Linux ones, of course, not the others....) </P
><P
>Be aware that fdisk doesn't write anything to disk before you hit w and return. If you fear a mistake, hit q (quit) or Ctrl C (^C) to quit safe without saving changes. </P
><P
>When your new partition table is written, start your Linux. It's possible you might not be able to do that as usual: lilo/grub may have been damaged also, and you thus may need a boot floppy or CD. Choose the option "booting the installed partition".  </P
><P
>If you are accustomed to booting with lilo, as soon as you are logged in as root, key in "lilo" and hit return to reinstall your favourite boot loader. Right now, I'm not sure that the same thing is as easy with GRUB, but it should not be very difficult, either. </P
><P
>Your Linux should be all here; test it. Try, also, to start MS Windows if applicable. If you can't, there is a (very small) chance you can read your data from Linux, maybe with a raw sector-by-sector read. If you can identify the disk sectors your data is on, using dd you can copy it to a file. This is wise for text only. This recovery is NOT in the scope of this mini-HOWTO. </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN161"
></A
>4.2. A not-so-simple case</H2
><DIV
CLASS="section"
><H3
CLASS="section"
><A
NAME="AEN163"
></A
>4.2.1. By hand</H3
><P
>This is when the previous case can't be used, for lack of fdisk paper, or if it won't work for use of an out-of-date one. </P
><P
><STRONG
>Warning</STRONG
> </P
><P
>You can only try <EM
>primary</EM
> partitions with no fear. <EM
>logical</EM
> partition uses ordinary sectors of the disk to store their own housekeeping data, so, each time you write some logical partition with fdisk, you write some sectors, erasing the data content, if any. There is still a chance you don't have any data there or the data is unimportant, but, the less often you do such tries, the better. </P
><P
>First, be aware that as soon as you don't write to the disk (except with fdisk), you don't erase your data, so that you can use a block-by-block try. That is you need to know the beginning of the partition to start it. If, say a 153 doesn't fit, try a 154, and so on. </P
><P
>This can be tiresome, but, if you remember approximately the size of the Linux partition, there is a chance to win. </P
></DIV
><DIV
CLASS="section"
><HR><H3
CLASS="section"
><A
NAME="AEN173"
></A
>4.2.2. Linux's own info and other hacks</H3
><DIV
CLASS="section"
><H4
CLASS="section"
><A
NAME="AEN175"
></A
>4.2.2.1. Kernel</H4
><P
>If you just destroyed your own partition table, but have not rebooted Linux: Don't reboot! You can still retrieve the partition information stored in the Kernel: </P
><P
><FONT
COLOR="RED"
>cat /proc/partitions</FONT
> gives </P
><DIV
CLASS="informaltable"
><A
NAME="AEN180"
></A
><P
></P
><TABLE
BORDER="1"
CLASS="CALSTABLE"
><TBODY
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> major </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> minor </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> #blocks </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> name </P
></TD
></TR
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 0 </P
></TD
><TD
WIDTH="25%"
ALIGN="RIGHT"
VALIGN="MIDDLE"
><P
> 19535040 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> hda </P
></TD
></TR
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 1 </P
></TD
><TD
WIDTH="25%"
ALIGN="RIGHT"
VALIGN="MIDDLE"
><P
> 2096451 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> hda1 </P
></TD
></TR
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 2 </P
></TD
><TD
WIDTH="25%"
ALIGN="RIGHT"
VALIGN="MIDDLE"
><P
> 4980150 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> hda2 </P
></TD
></TR
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="RIGHT"
VALIGN="MIDDLE"
><P
> 1 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> hda3 &#60;--- this marks an extended partition </P
></TD
></TR
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 5 </P
></TD
><TD
WIDTH="25%"
ALIGN="RIGHT"
VALIGN="MIDDLE"
><P
> 4980118 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> hda5 </P
></TD
></TR
><TR
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 3 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> 6 </P
></TD
><TD
WIDTH="25%"
ALIGN="RIGHT"
VALIGN="MIDDLE"
><P
> 4972086 </P
></TD
><TD
WIDTH="25%"
ALIGN="LEFT"
VALIGN="MIDDLE"
><P
> hda6 </P
></TD
></TR
></TBODY
></TABLE
><P
></P
></DIV
></DIV
><DIV
CLASS="section"
><HR><H4
CLASS="section"
><A
NAME="AEN250"
></A
>4.2.2.2. hdparm</H4
><P
><FONT
COLOR="RED"
>hdparm -g /dev/hda1/dev/hda1</FONT
> : </P
><P
>geometry = 2432/255/63, sectors = 4192902, start = 63 </P
><P
>You'll need to do a few unit conversions. "blocks" are usually 1K in length. "Sectors" are disk sectors, often 512 bytes. But usually the disk partitioning tools work in units of cylinders. (Here, 255*63=16065 sectors.) Using this information, you can build a new partition table. </P
></DIV
><DIV
CLASS="section"
><HR><H4
CLASS="section"
><A
NAME="AEN256"
></A
>4.2.2.3. I know the start of the partition, but not the end.</H4
><P
>If you know the start of a Linux partition, but not the end, you can still mount it, and learn about the structure. Set the partition table start correctly, and set the end to something very large. See if you guessed correctly with: </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>e2fsck -n /dev/hd??</PRE
></FONT
></TD
></TR
></TABLE
><P
>You can even mount the partition and check the size: </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>mount -r /dev/hd?? /mnt
df -T</PRE
></FONT
></TD
></TR
></TABLE
><P
>This won't directly tell you where the next partition starts, because of rounding issues. But it can help you get close. Be sure to use the "-n" and "-r" flags, to treat the system as read-only!!! </P
></DIV
><DIV
CLASS="section"
><HR><H4
CLASS="section"
><A
NAME="AEN263"
></A
>4.2.2.4. Other places partition information is stored</H4
><P
>Some distributions record partition information in a file. Of course, you probably won't be able to get to this file when you need it. But, just in case: </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>SuSE: /var/lib/YaST/install.inf</PRE
></FONT
></TD
></TR
></TABLE
><P
>(if you are aware of others, please e-mail the maintainer of this document) </P
></DIV
><DIV
CLASS="section"
><HR><H4
CLASS="section"
><A
NAME="AEN268"
></A
>4.2.2.5. gpart</H4
><P
>But there is a better way if you can still access the Net or have "gpart" on hand. gpart is available in most distribution, at <A
HREF="http://freshmeat.net/"
TARGET="_top"
>http://freshmeat.net/</A
> or directly from <A
HREF="http://www.stud.uni-hannover.de/user/76201/gpart"
TARGET="_top"
>http://www.stud.uni-hannover.de/user/76201/gpart</A
>. </P
><P
>Please note that gpart is <STRONG
>not</STRONG
> gparted - the GNOME partition editor. </P
><P
>"gpart - guess PC-type hard disk partitions" as the first line of the it's man page states (man gpart). And goes on to say: </P
><P
>"gpart tries to guess which partitions are on a hard disk. If the primary partition table has been lost, overwritten, or destroyed, the partitions still exist on the disk, but the operating system cannot access them." </P
><P
>This is exactly what we need. gpart is a very useful tool. </P
><P
>The problem is the following: the first block of any partition is marked. But it's never "unmarked" if not overwritten. So, many "first partition block" exist on an old disk, and gpart tries to do its best guessing what is the good one. In fact, it's not too difficult to try; nothing is written on the disk by gpart. </P
><P
>Here is the result of gpart on the previously seen disk, hdb: </P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>root@charles:/home/jdd &#62; gpart /dev/hdb
Begin scan...
Possible partition(Linux ext2), size(1200Mb), offset(0Mb)
Possible partition(Windows NTFS), size(1200Mb), offset(1200Mb)
Possible partition(Linux ext2), size(1004Mb), offset(2402Mb)
Possible partition(Windows NTFS), size(1600Mb), offset(4102Mb)
End scan.
Checking partitions...
* Warning: partition(OS/2 HPFS, NTFS, QNX or Advanced UNIX) ends beyond disk end .
Partition(Linux ext2 filesystem): primary
Partition(OS/2 HPFS, NTFS, QNX or Advanced UNIX): primary
Partition(Linux ext2 filesystem): primary
Partition(OS/2 HPFS, NTFS, QNX or Advanced UNIX): invalid primary
Ok.
Guessed primary partition table:
Primary partition(1)
type: 131(0x83)(Linux ext2 filesystem)
size: 1200mb #s(2457880) s(63-2457942)
chs: (0/1/1)-(152/254/61)d (0/1/1)-(152/254/61)r
Primary partition(2)
type: 007(0x07)(OS/2 HPFS, NTFS, QNX or Advanced UNIX)
size: 1200mb #s(2457880) s(2457944-4915823)
chs: (152/254/63)-(305/253/60)d (152/254/63)-(305/253/60)r
Primary partition(3)
type: 131(0x83)(Linux ext2 filesystem)
size: 1004mb #s(2056256) s(4919781-6976036)
chs: (306/61/49)-(434/60/47)d (306/61/49)-(434/60/47)r
Primary partition(4)
type: 000(0x00)(unused) size: 0mb #s(0) s(0-0) chs: (0/0/0)-(0/0/0)d (0/0/0)-(0/0/0)r</PRE
></FONT
></TD
></TR
></TABLE
><P
>As you see, primary partition can be recovered, but, for extended ones, it's still to be done. </P
><P
>DOS partitions are labelled "Windows NTFS" because they were created while trying to install MS Windows 2000 (a very awful experience in year 2000!). The "invalid" one is, in fact the extended partition. </P
><P
>With this, one can use fdisk and try re-creating the partition table. (Remember, this is risk-free given the original one is already lost.) </P
><P
>gpart is updated on a weekly basis <SPAN
CLASS="inlinemediaobject"
><IMG
SRC="http://wiki.tldp.org/moin_static172/gugiel/img/smile.png"
WIDTH="16"
HEIGHT="16"></SPAN
> and so new versions may be more powerful than I know. </P
></DIV
><DIV
CLASS="section"
><HR><H4
CLASS="section"
><A
NAME="AEN290"
></A
>4.2.2.6. Recovering partitions inside an extended partition</H4
><P
>Extended partition information is scattered on the disk, not stored with the primary partition. To recover these often requires more work. The process is: </P
><P
></P
><OL
TYPE="1"
><LI
><P
>Scan for the start of the first partition (using gpart's -k option); </P
></LI
><LI
><P
>Create a temporary primary partition entry with the true start position and a fake end position. (This may drive you to delete an actual primary partition if no one is available - this is risk free if you don't reuse the sectors of the deleted partition); </P
></LI
><LI
><P
>Use "<FONT
COLOR="RED"
>e2fsk -n</FONT
>", "<FONT
COLOR="RED"
>mount -r</FONT
>", and "<FONT
COLOR="RED"
>df</FONT
>" to determine the true end point. Write this value down (warning: read the man page for each program mentioned, and use the read-only options; you do not want to write to your disk until all partitions are in the correct place); </P
></LI
><LI
><P
>Repeat this process for each partition to be recovered; </P
></LI
><LI
><P
>Build a complete new correct partition table. </P
></LI
></OL
></DIV
><DIV
CLASS="section"
><HR><H4
CLASS="section"
><A
NAME="AEN307"
></A
>4.2.2.7. If your hard drive has errors</H4
><P
>If your hard drive has errors, you may have real trouble mounting, checking, or using data. (The drive read errors get in the way.) Gpart may not even find it. But if you know the start of the partition, you can easily copy the data to a temporary file stored on a different drive. Sectors with read errors will usually be set to zero by this process: </P
><P
></P
><UL
><LI
><P
>Copy the partition data to a file. You must know the start block of the partition; </P
></LI
></UL
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>dd if=/dev/hd?? of=/tmp/recover_hd?? bs=512 skip=XXXX count=YYY</PRE
></FONT
></TD
></TR
></TABLE
><P
>XXX is the sector start and YYY the sector count (can be guessed). </P
><P
></P
><UL
><LI
><P
>Mount the file as a loop file system. </P
></LI
></UL
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="screen"
>mount -r -t ext2 -o loop /tmp/recover_hd?? /mnt/recover</PRE
></FONT
></TD
></TR
></TABLE
><P
>Use <FONT
COLOR="RED"
>dd_rescue</FONT
> if the disk is really badly damaged. </P
></DIV
></DIV
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN321"
></A
>4.3. The rich man's case</H2
><P
>Partition Magic is a commercial (and proprietary) software product, not so cheap given the little use one can have (approx a hundred bucks in France), but with a very high reputation all around there. However, I never use it and will not rate it. It's said to be able to do anything with partitions, including restoring them. </P
><P
>Ralf's original partition-rescue mini HOWTO was essentially based around the use of Partition Magic, so I assume it's a very good solution, if you have valuable data on your Linux partition and little Linux capability. However, there are now much more recent releases of Partition Magic and I think it's better for you to read the manual. </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN325"
></A
>4.4. PMagic</H2
><P
><A
HREF="http://partedmagic.com/wiki/PartedMagic.php"
TARGET="_top"
>PartedMagic</A
> if the tool of choice for any partition work, including recovery. Extremely good product (and open, of course). Read the HOWTO anyway, because you may need it to prevent disasters, but all the tools are on pmagic, this is the best recovery cd ever... </P
></DIV
></DIV
><DIV
CLASS="section"
><HR><H1
CLASS="section"
><A
NAME="AEN329"
></A
>5. References</H1
><DIV
CLASS="section"
><H2
CLASS="section"
><A
NAME="AEN331"
></A
>5.1. Authors</H2
><P
>The author of this HOWTO is Jean-Daniel Dodin. I can be joined at <A
HREF="http://www.dodin.net/e-mail_codée.html"
TARGET="_top"
>My masqued e-mail</A
> or simply searching "Jean-Daniel Dodin" on Google :-). </P
><P
>My Web site is at [<A
HREF="http://www.dodin.net"
TARGET="_top"
>http://www.dodin.net</A
>]. </P
><P
>I want to thank Rolf Klausen, who wrote the previous partition-rescue mini HOWTO. Even if I rewrote it almost entirely, he had first the good idea. </P
><P
>Every other member of the Linux community, and everybody who supports Linux and writes documentation and programs for Linux, and all the authors of the LDP, and virtually any person involved in anything which has to do with Linux. Particularly Linus B. Torvalds - he is <STRONG
>The King</STRONG
> !!! </P
><P
>I want also to thank Michail Brzitwa (see Web site in the text) for writing gpart ! </P
><P
>Bryce Nesbitt &#60;bryce at obviously dot com&#62; did a very good job, "Linux's own info" is from him as are some minor enhancements. </P
></DIV
><DIV
CLASS="section"
><HR><H2
CLASS="section"
><A
NAME="AEN342"
></A
>5.2. Most recent version</H2
><P
>The most recent version of this HOWTO will be found on <A
HREF="http://wiki.tldp.org/PartitionRescueHowto"
TARGET="_top"
>the tldp wiki</A
> </P
></DIV
></DIV
></DIV
></BODY
></HTML
>