<HTML>
<HEAD>

<TITLE>
Linux PCMCIA HOWTO
</TITLE>
<link rel="stylesheet" href="../bookstyle.css"></HEAD>
<BODY BGCOLOR=white>

<HR>
<H1>Linux PCMCIA HOWTO</H1>

<H2>David Hinds, <CODE>
<A HREF="mailto:dahinds@users.sourceforge.net">dahinds@users.sourceforge.net</A></CODE>. </H2>v2.118, 06 December 2003
<P><HR>
<EM>This document describes how to install and use PCMCIA Card Services
for Linux, and answers some frequently asked questions.  The latest
version of this document can always be found at
<A HREF="http://pcmcia-cs.sourceforge.net">http://pcmcia-cs.sourceforge.net</A>.</EM>
<HR>
<P>
<H2><A NAME="toc1">1.</A> <A HREF="#s1">General information and hardware requirements</A></H2>

<UL>
<LI><A HREF="#ss1.1">1.1 Introduction</A>
<LI><A HREF="#ss1.2">1.2 Copyright notice and disclaimer</A>
<LI><A HREF="#ss1.3">1.3 What is the latest version, and where can I get it?</A>
<LI><A HREF="#ss1.4">1.4 What systems are supported?</A>
<LI><A HREF="#ss1.5">1.5 What cards are supported?</A>
<LI><A HREF="#ss1.6">1.6 When will my favorite (unsupported) card become supported?</A>
<LI><A HREF="#ss1.7">1.7 Mailing lists and other information sources</A>
</UL>
<P>
<H2><A NAME="toc2">2.</A> <A HREF="#s2">Compilation and installation</A></H2>

<UL>
<LI><A HREF="#ss2.1">2.1 Prerequisites and kernel setup</A>
<LI><A HREF="#ss2.2">2.2 Kernel PCMCIA support</A>
<LI><A HREF="#ss2.3">2.3 Installation</A>
<LI><A HREF="#ss2.4">2.4 Startup options</A>
<LI><A HREF="#ss2.5">2.5 System resource settings</A>
<LI><A HREF="#ss2.6">2.6 Notes about specific Linux distributions</A>
</UL>
<P>
<H2><A NAME="toc3">3.</A> <A HREF="#s3">Resolving installation and configuration problems</A></H2>

<UL>
<LI><A HREF="#ss3.1">3.1 Base PCMCIA kernel modules do not load</A>
<LI><A HREF="#ss3.2">3.2 Some client driver modules do not load</A>
<LI><A HREF="#ss3.3">3.3 ISA interrupt scan failures</A>
<LI><A HREF="#ss3.4">3.4 IO port scan failures</A>
<LI><A HREF="#ss3.5">3.5 Memory probe failures</A>
<LI><A HREF="#ss3.6">3.6 Failure to detect card insertions and removals</A>
<LI><A HREF="#ss3.7">3.7 Interrupt delivery problems</A>
<LI><A HREF="#ss3.8">3.8 System resource starvation</A>
<LI><A HREF="#ss3.9">3.9 Resource conflict only with two cards inserted</A>
<LI><A HREF="#ss3.10">3.10 Device configuration does not complete</A>
</UL>
<P>
<H2><A NAME="toc4">4.</A> <A HREF="#s4">Usage and features</A></H2>

<UL>
<LI><A HREF="#ss4.1">4.1 Tools for configuring and monitoring PCMCIA devices</A>
<LI><A HREF="#ss4.2">4.2 Overview of the PCMCIA configuration scripts</A>
<LI><A HREF="#ss4.3">4.3 PCMCIA network adapters</A>
<LI><A HREF="#ss4.4">4.4 PCMCIA serial and modem devices</A>
<LI><A HREF="#ss4.5">4.5 PCMCIA parallel port devices</A>
<LI><A HREF="#ss4.6">4.6 PCMCIA SCSI adapters</A>
<LI><A HREF="#ss4.7">4.7 PCMCIA memory cards</A>
<LI><A HREF="#ss4.8">4.8 PCMCIA ATA/IDE card drives</A>
<LI><A HREF="#ss4.9">4.9 Multifunction cards</A>
</UL>
<P>
<H2><A NAME="toc5">5.</A> <A HREF="#s5">Advanced topics</A></H2>

<UL>
<LI><A HREF="#ss5.1">5.1 Resource allocation for PCMCIA devices</A>
<LI><A HREF="#ss5.2">5.2 PCI interrupt configuration problems and solutions</A>
<LI><A HREF="#ss5.3">5.3 How can I have separate device setups for home and work?</A>
<LI><A HREF="#ss5.4">5.4 Booting from a PCMCIA device</A>
</UL>
<P>
<H2><A NAME="toc6">6.</A> <A HREF="#s6">Dealing with unsupported cards</A></H2>

<UL>
<LI><A HREF="#ss6.1">6.1 Configuring unrecognized cards</A>
<LI><A HREF="#ss6.2">6.2 Adding support for an NE2000-compatible ethernet card</A>
<LI><A HREF="#ss6.3">6.3 PCMCIA floppy interface cards</A>
</UL>
<P>
<H2><A NAME="toc7">7.</A> <A HREF="#s7">Debugging tips and programming information</A></H2>

<UL>
<LI><A HREF="#ss7.1">7.1 Submitting useful problem reports</A>
<LI><A HREF="#ss7.2">7.2 Interpreting kernel trap reports</A>
<LI><A HREF="#ss7.3">7.3 Low level PCMCIA debugging aids</A>
<LI><A HREF="#ss7.4">7.4 /proc/bus/pccard</A>
<LI><A HREF="#ss7.5">7.5 Writing Card Services drivers for new cards</A>
<LI><A HREF="#ss7.6">7.6 Guidelines for PCMCIA client driver authors</A>
<LI><A HREF="#ss7.7">7.7 Guidelines for Linux distribution maintainers</A>
</UL>
<HR>
<H2><A NAME="s1">1.</A> <A HREF="#toc1">General information and hardware requirements</A></H2>

<H2><A NAME="ss1.1">1.1 Introduction</A>
</H2>

<P>Card Services for Linux is a complete PCMCIA or
``PC Card'' support package.  It includes a set of loadable
kernel modules that implement a version of the Card Services
applications program interface, a set of client drivers for specific
cards, and a card manager daemon that can respond to card insertion
and removal events, loading and unloading drivers on demand.  It
supports ``hot swapping'' of most card types, so cards can be safely
inserted and ejected at any time.
<P>This software is a work in progress.  It contains bugs, and should be
used with caution.  I'll do my best to fix problems that are reported
to me, but if you don't tell me, I may never know.  If you use this
code, I hope you will send me your experiences, good or bad!
<P>If you have any suggestions for how this document could be improved,
please let me know (<CODE>
<A HREF="mailto:dahinds@users.sourceforge.net">dahinds@users.sourceforge.net</A></CODE>). 
<P>
<H2><A NAME="ss1.2">1.2 Copyright notice and disclaimer</A>
</H2>

<P>Copyright (c) 1998-2002 David A. Hinds
<P>This document may be reproduced or distributed in any form without my
prior permission.  Modified versions of this document, including
translations into other languages, may be freely distributed, provided
that they are clearly identified as such, and this copyright is
included intact.
<P>This document may be included in commercial distributions without my
prior consent.  While it is not required, I would like to be informed
of such usage.  If you intend to incorporate this document in a
published work, please contact me to make sure you have the latest
available version.
<P>This document is provided ``AS IS'', with no express or implied
warranties.  Use the information in this document at your own risk.
<P>
<H2><A NAME="ss1.3">1.3 What is the latest version, and where can I get it?</A>
</H2>

<P>The current major release of Card Services is version 3.2, and minor
updates or bug fixes are numbered 3.2.1, 3.2.2, and so on.
<P>Source code for the latest version is available on the web at
<A HREF="http://pcmcia-cs.sourceforge.net">http://pcmcia-cs.sourceforge.net</A>, as
<CODE>pcmcia-cs-3.2.?.tar.gz</CODE>.  You may find more than one release
number here.  It is up to you to decide which version is more
appropriate, but the <CODE>CHANGES</CODE> file will summarize the most
important differences.
<P>Pre-compiled drivers are included with current releases of essentially
all major Linux distributions, including Slackware, Debian, Red Hat,
Caldera, and SuSE, among others.  So generally there is no need to
compile the drivers from scratch.
<P>
<H2><A NAME="ss1.4">1.4 What systems are supported?</A>
</H2>

<P>This package should run on almost Intel-based Linux-capable laptop.
It also runs on some Alpha, PowerPC, ARM, and MIPS platforms.  Most
common socket controllers are supported.  Card docks for desktop
systems should work as long as they use a supported controller, and
are plugged directly into the ISA or PCI bus, as opposed to
SCSI-to-PCMCIA or IDE-to-PCMCIA adapters.  The following controllers
are recognized by the supplied socket drivers:
<P>
<UL>
<LI>Cirrus Logic (now Basis Communications) PD6710, PD6720, PD6722,
PD6729, PD6730, PD6832</LI>
<LI>ENE Technology CB1211, CB1225, CB1410, CB1420</LI>
<LI>Intel i82365sl B, C, and DF steps, 82092AA</LI>
<LI>O2Micro OZ6729, OZ6730, OZ6812, OZ6832, OZ6833, OZ6836, OZ6860,
OZ6922, OZ6933, OZ6912</LI>
<LI>Omega Micro 82C365G, 82C092G</LI>
<LI>Ricoh RF5C296, RF5C396, RL5C465, RL5C466, RL5C475, RL5C476,
RL5C477, RL5C478</LI>
<LI>SMC 34C90</LI>
<LI>Texas Instruments PCI1031, PCI1130, PCI1131, PCI1210, PCI1211,
PCI1220, PCI1221, PCI1225, PCI1250A, PCI1251A, PCI1251B, PCI1410,
PCI1410A, PCI1420, PCI1450, PCI1451A, PCI1510, PCI1520, PCI1620,
PCI4410, PCI4410A, PCI4450, PCI4451, PCI4510, PCI4520, PCI7410,
PCI7510, PCI7610</LI>
<LI>Toshiba ToPIC95, ToPIC97, ToPIC100 (experimental, incomplete)</LI>
<LI>Vadem VG465, VG468, VG469</LI>
<LI>VLSI Technologies 82C146, VCF94365</LI>
<LI>VIA VT83C469</LI>
<LI>Databook DB86082, DB86082A, DB86084, DB86084A, DB86072, DB86082B</LI>
</UL>
<P>Other controllers that are register compatible with the Intel i82365sl
will generally work, as well.
<P>Due to the rapid pace of technological change for laptop hardware, new
controllers appear frequently, and there may be delays between when a
new model appears on the market, and when driver support becomes
available.
<P>Support for Toshiba's ToPIC bridges was hindered for a long time by a
lack of sufficiently detailed technical documentation.  While some
datasheets have been available, a few idiosyncracies of the ToPIC
chips were not adequately explained.  Toshiba has given some direct
technical help on some of these issues, and I think the major ones
have been resolved.  However, with the introduction of kernel PCMCIA
support in 2.4.* and later kernels, some new Toshiba bugs may have
cropped up in the new socket driver code.
<P>The Motorola 6AHC05GA controller used in some Hyundai laptops is not
supported.  The custom host controller in the HP Omnibook 600 is
also unsupported.
<P>
<H2><A NAME="ss1.5">1.5 What cards are supported?</A>
</H2>

<P>The current release includes drivers for a variety of ethernet cards,
a driver for modem and serial port cards, several SCSI adapter
drivers, a driver for ATA/IDE drive cards, and memory card drivers
that should support most SRAM cards and some flash cards.  The
<CODE>SUPPORTED.CARDS</CODE> file included with each release of Card Services
lists all cards that are known to work in at least one actual system.
<P>The likelihood that a card not on the supported list will work depends
on the type of card.  Essentially all modems should work with the
supplied driver.  Some network cards may work if they are OEM versions
of supported cards.  Other types of IO cards (frame buffers, sound
cards, etc) will not work until someone writes the appropriate
drivers.
<P>
<H2><A NAME="ss1.6">1.6 When will my favorite (unsupported) card become supported?</A>
</H2>

<P>Unfortunately, they usually don't pay me to write device drivers, so
if you would like to have a driver for your favorite card, you are
probably going to have to do at least some of the work.  Ideally, I'd
like to work towards a model like the Linux kernel, where I would be
responsible mainly for the ``core'' driver code and other authors
would contribute and maintain client drivers for specific cards.  The
<CODE>SUPPORTED.CARDS</CODE> file mentions some cards for which driver work is
currently in progress.  I will try to help where I can, but be warned
that debugging kernel device drivers by email is not particularly
effective.  
<P>
<H2><A NAME="ss1.7">1.7 Mailing lists and other information sources</A>
</H2>

<P>The Linux PCMCIA information page is at
<A HREF="http://pcmcia-cs.sourceforge.net">http://pcmcia-cs.sourceforge.net</A>, and has bug tracking,
support and feature requests, and a variety of PCMCIA related message
forums.  Users can request email notification of new responses to
particular questions, or notification for all new messages in a given
category.  I hope that this will become a useful repository of
information, for questions that go beyond the scope of the HOWTO.
<P>The Linux Laptop Page at 
<A HREF="http://www.linux-on-laptops.com">http://www.linux-on-laptops.com</A>
has links to a vast number of sites that have information about
configuring specific types of laptops for Linux.  There is also a
searchable database of system configuration information, and pointers
to a variety of laptop-related mailing lists.
<P>
<HR>
<H2><A NAME="compile"></A> <A NAME="s2">2.</A> <A HREF="#toc2">Compilation and installation</A></H2>

<H2><A NAME="ss2.1">2.1 Prerequisites and kernel setup</A>
</H2>

<P>Before starting, you should think about whether you really need to
compile the PCMCIA package yourself.  All common Linux distributions
come with pre-compiled driver packages.  Generally, you only need to
install the drivers from scratch if you need a new feature of the
current drivers, or if you've updated and/or reconfigured your kernel
in a way that is incompatible with the drivers included with your
Linux distribution.  While compiling the package is not technically
difficult, it does require some general Linux familiarity.
<P>The following things should be installed on your system before you
begin:
<UL>
<LI>A 2.0, 2.2, 2.4, or 2.6 series kernel source tree.</LI>
<LI>An appropriate set of module utilities.</LI>
<LI>(Optional) the ``XForms'' X11 user interface toolkit.</LI>
</UL>
<P>You need to have a complete linux source tree for your kernel, not
just an up-to-date kernel image.  The driver modules contain some
references to kernel source files.  While you may want to build a new
kernel to remove unnecessary drivers, installing PCMCIA does not
require you to do so.
<P>Current ``stable'' kernel sources and patches are available from
<A HREF="ftp://ftp.kernel.org/pub/linux/kernel/v2.4">ftp://ftp.kernel.org/pub/linux/kernel/v2.4</A>.  Current
module utilities can be found in the same locations.  
<P>In the Linux kernel source tree, the <CODE>Documentation/Changes</CODE>
file describes the versions of all sorts of other system components
that are required for that kernel release.  You may want to check
through this and verify that your system is up to date, especially if
you have updated your kernel.  If you are using a development kernel,
be sure that you are using the right combination of shared libraries
and module tools.
<P>On x86 based systems, if you plan to use 16-bit PC Card devices, you
should also enable <CODE>CONFIG_ISA</CODE>, for recent kernels.  These cards
behave much like ISA devices, and the PCMCIA drivers use
<CODE>CONFIG_ISA</CODE> to judge whether a platform supports ISA bus
interrupts.
<P>When configuring your kernel, if you plan on using a PCMCIA ethernet
card, you should turn on networking support but turn off the normal
Linux network card drivers, including the ``pocket and portable
adapters''.  The PCMCIA network card drivers are all implemented as
loadable modules.  Any drivers compiled into your kernel will only
waste space.
<P>If you want to use SLIP, PPP, or PLIP, you do need to either configure
your kernel with these enabled, or use the loadable module versions of
these drivers.
<P>In order to use a PCMCIA token ring adapter, your kernel should be
configured with ``Token Ring driver support'' (<CODE>CONFIG_TR</CODE>)
enabled, though you should leave <CODE>CONFIG_IBMTR</CODE> off.
<P>If you want to use a PCMCIA IDE adapter, your kernel should be
configured with <CODE>CONFIG_BLK_DEV_IDE_PCMCIA</CODE> enabled, for 2.0.*
kernels.  Newer kernels do not require a special configuration
setting.
<P>If you will be using a PCMCIA SCSI adapter, then enable
<CODE>CONFIG_SCSI</CODE> when configuring your kernel.  Also, enable any top
level drivers (SCSI disk, tape, cdrom, generic) that you expect to
use.  All low-level drivers for particular host adapters should be
disabled, as they will just take up space.
<P>This package includes an X-based card status utility called
<CODE>cardinfo</CODE>.  This utility is based on a freely distributed user
interface toolkit called the XForms Library.  This library is
available as a separate package with most Linux distributions.  If you
would like to build <CODE>cardinfo</CODE>, you should install XForms and all
the normal X header files and libraries before configuring the PCMCIA
package.  This tool is completely optional.
<P>
<H2><A NAME="ss2.2">2.2 Kernel PCMCIA support</A>
</H2>

<P>
<P>PCMCIA driver support is included in the 2.4 and later linux kernel
trees.  While it shares most of the same code with the standalone
PCMCIA driver package, there are some important differences.  The
kernel PCMCIA support is also still evolving.
<P>The kernel PCMCIA code has the same functionality as the driver side
of the pcmcia-cs package.  It does not eliminate the need to install
the pcmcia-cs package, since it requires the same user tools
(<CODE>cardmgr</CODE>, <CODE>cardctl</CODE>, <CODE>/etc/pcmcia/*</CODE> files).  The
drivers in pcmcia-cs can still be built for 2.4 kernels, so you 
have a choice of using either the in-kernel PCMCIA drivers, or the
drivers included in pcmcia-cs.  With 2.5 and later kernels, the
standalone drivers cannot be used.
<P>To use the kernel PCMCIA drivers, configure the kernel with
<CODE>CONFIG_HOTPLUG</CODE>, <CODE>CONFIG_PCMCIA</CODE>, and usually
<CODE>CONFIG_CARDBUS</CODE> enabled.  On x86 based systems, <CODE>CONFIG_ISA</CODE>
should also be enabled.  The drivers can either be built into the
kernel or built as modules.  PCMCIA client driver options are listed
in their regular driver categories; thus, PCMCIA network drivers are
in a submenu of network drivers, and PCMCIA serial drivers are in a
submenu of character drivers.
<P>In the standalone pcmcia-cs drivers, the <CODE>i82365</CODE> module supports
both ISA-to-PCMCIA, PCI-to-PCMCIA, and PCI-to-CardBus bridges.  The
CardBus socket driver in the 2.4 tree is the <CODE>yenta_socket</CODE> driver.
It is selected by the <CODE>CONFIG_CARDBUS</CODE> option.  In your PCMCIA
startup options, this driver should be specified in place of the
<CODE>i82365</CODE> driver.  The kernel version of the <CODE>i82365</CODE> driver,
selected by <CODE>CONFIG_I82365</CODE>, only supports ISA-to-PCMCIA bridges.
PCI-to-PCMCIA bridges that are not CardBus capable, like the Cirrus
PD6729, are not supported at all by the kernel PCMCIA drivers.
<P>When compiling the standalone PCMCIA package, the Configure script
decides whether or not to build any kernel modules by looking at the
value of the <CODE>CONFIG_PCMCIA</CODE> option in your kernel configuration.
If <CODE>CONFIG_PCMCIA</CODE> is enabled, then by default, no driver
components are built.  If <CODE>CONFIG_PCMCIA</CODE> is disabled, then all the
modules will be built and installed.  It is safe to compile the user
tools (cardmgr, cardctl, etc) in a PCMCIA package whose version number
differs from the PCMCIA version number in the kernel source tree.  The
kernel PCMCIA header files take precedence over the ones included in
the PCMCIA package, if <CODE>CONFIG_PCMCIA</CODE> is enabled.
<P>
<H2><A NAME="ss2.3">2.3 Installation</A>
</H2>

<P>Here is a synopsis of the installation process:
<P>
<UL>
<LI>Unpack pcmcia-cs-3.2.?.tar.gz in /usr/src.</LI>
<LI>Run ``<CODE>make config</CODE>'' in the new <CODE>pcmcia-cs-3.2.?</CODE> directory.</LI>
<LI>Run ``<CODE>make all</CODE>'', then ``<CODE>make install</CODE>''.</LI>
<LI>Customize the startup script and the option files in
<CODE>/etc/pcmcia</CODE> for your site, if needed.</LI>
</UL>
<P>If you plan to install any contributed client drivers not included in
the core PCMCIA distribution, unpack each of them in the top-level
directory of the PCMCIA source tree.  Then follow the normal build
instructions.  The extra drivers will be compiled and installed
automatically.  
<P>Running ``<CODE>make config</CODE>'' prompts for a few configuration options,
and checks out your system to verify that it satisfies all
prerequisites for installing PCMCIA support.  In most cases, you'll be
able to just accept all the default configuration options.  Be sure to
carefully check the output of this command in case there are problems.
The following options are available:
<P>
<DL>
<DT><B>Linux kernel source directory?</B><DD><P>This is the location of the source tree for the kernel you want to use
with PCMCIA.  Often this is <CODE>/usr/src/linux</CODE>, but the default
location depends on what Linux distribution you're using (or on where
you've chosen to place your kernel source tree).
<P>
<DT><B>Build 'trusting' versions of card utilities?</B><DD><P>Some of the support utilities (<CODE>cardctl</CODE> and <CODE>cardinfo</CODE>) can be
compiled either in ``safe'' or ``trusting'' forms.  The ``safe'' forms
prevent non-root users from modifying card configurations.  The
``trusting'' forms permit ordinary users to issue commands to suspend
and resume cards, reset cards, and change the current configuration
scheme.  The default is to build the safe forms.
<P>
<DT><B>Include 32-bit (CardBus) card support?</B><DD><P>This option must be selected if you wish to use 32-bit CardBus cards.
It is not required for CardBus bridge support, if you only plan to use
16-bit PC Cards.
<P>
<DT><B>Include PnP BIOS resource checking?</B><DD><P>This builds additional code into the PCMCIA core module to communicate
with a system's PnP BIOS to obtain resource information for built-in
``motherboard'' devices (serial and parallel ports, sound, etc), to
help avoid resource conflicts.  If enabled, some extra resource files
will be created under <CODE>/proc/bus/pccard</CODE>, and the <CODE>lspnp</CODE>
and <CODE>setpnp</CODE> tools can be used to view and manipulate PnP BIOS
devices.  However, this setting causes problems on some laptops and is
not turned on by default.
<P>
<DT><B>Module install directory?</B><DD><P>The directory that new kernel modules will be installed into.
Normally this should be the subdirectory of <CODE>/lib/modules</CODE> that
matches your kernel version.
<P>
<DT><B>How to set kernel-specific options?</B><DD><P>There are a few kernel configuration options that affect the PCMCIA
tools.  The configuration script can deduce these from the running
kernel (the default and most common case).  Alternatively, if you are
compiling for installation on another machine, it can read the
configuration from a kernel source tree, or each option can be set
interactively.
<P>
</DL>
<P>The <CODE>Configure</CODE> script can also be executed non-interactively, for
automatic builds or to quickly reconfigure after a kernel update.
Some additional less-frequently-used options can be only be set from
the command line.  Running ``<CODE>Configure --help</CODE>'' lists all
available options.
<P>Running ``<CODE>make all</CODE>'' followed by ``<CODE>make install</CODE>'' will build
and then install the kernel modules and utility programs.  Kernel
modules are installed under <CODE>/lib/modules/&lt;version&gt;/pcmcia</CODE>.
The <CODE>cardmgr</CODE> and <CODE>cardctl</CODE> programs are installed in
<CODE>/sbin</CODE>.  If <CODE>cardinfo</CODE> is built, it is installed in
<CODE>/usr/bin/X11</CODE>.  
<P>Configuration files will be installed in the <CODE>/etc/pcmcia</CODE>
directory.  If you are installing over an older version, your old
config scripts will be backed up before being replaced.  The saved
scripts will be given an <CODE>*.O</CODE> extension.
<P>If you don't know what kind of host controller your system uses, you
can use the <CODE>pcic_probe</CODE> utility in the <CODE>cardmgr/</CODE>
subdirectory to determine this.  There are several major types: the
Databook TCIC-2 type and the Intel i82365SL-compatible type.  With the
kernel PCMCIA subsystem, Intel compatible controllers are further
subdivided into ISA-bus 16-bit bridges, and PCI-based CardBus bridges.
<P>In a few cases, the <CODE>pcic_probe</CODE> command will be unable to determine
your controller type automatically.  If you have a Halikan NBD 486
system, it has a TCIC-2 controller at an unusual location: you'll need
to edit <CODE>rc.pcmcia</CODE> to load the <CODE>tcic</CODE> module, and also set the
<CODE>PCIC_OPTS</CODE> parameter to ``<CODE>tcic_base=0x02c0</CODE>''.
<P>On some old pre-PCI systems using Cirrus controllers, including the
NEC Versa M, the BIOS puts the controller in a special suspended state
at system startup time.  On these systems, the <CODE>pcic_probe</CODE> command will
fail to find any known host controller.  If this happens, edit
<CODE>rc.pcmcia</CODE> and set <CODE>PCIC</CODE> to <CODE>i82365</CODE>, and <CODE>PCIC_OPTS</CODE> to
``<CODE>wakeup=1</CODE>''.
<P>
<H2><A NAME="startup"></A> <A NAME="ss2.4">2.4 Startup options</A>
</H2>

<P>The PCMCIA startup script recognizes several groups of startup
options, set via environment variables.  Multiple options should be
separated by spaces and enclosed in quotes.  Placement of startup
options depends on the Linux distribution used.  They may be placed
directly in the startup script, or they may be kept in a separate
option file.  See the 
<A HREF="#distributions">Notes about specific Linux distributions</A> for specifics.  The following variables
can be set: 
<P>
<DL>
<DT><B><CODE>PCMCIA</CODE></B><DD><P>This variable specifies whether PCMCIA support should be started up,
or not.  If it is set to anything other than ``yes'', then the startup
script will be disabled.
<DT><B><CODE>PCIC</CODE></B><DD><P>This identifies the PC Card Interface Controller driver module.  There
are several options: ``tcic'', ``i82365'', and (for the kernel PCMCIA
subsystem) ``yenta_socket''.  Virtually all current controllers are in
the ``i82365'' group for the standalone drivers, and ``yenta_socket''
for the kernel drivers.  This is the only mandatory option setting.
<DT><B><CODE>PCIC_OPTS</CODE></B><DD><P>This specifies options for the PCIC module.  Some host controllers
have optional features that may or may not be implemented in a
particular system.  In some cases, it is impossible for the socket
driver to detect if these features are implemented.  See the
corresponding man page for a complete description of the available
options. 
<DT><B><CODE>CORE_OPTS</CODE></B><DD><P>This specifies options for the <CODE>pcmcia_core</CODE> module, which
implements the core PC Card driver services.  See ``<CODE>man
pcmcia_core</CODE>'' for more information.
<DT><B><CODE>CARDMGR_OPTS</CODE></B><DD><P>This specifies options to be passed to the <CODE>cardmgr</CODE> daemon.  See
``<CODE>man cardmgr</CODE>'' for more information.
<DT><B><CODE>SCHEME</CODE></B><DD><P>If set, then the PC Card configuration scheme will be initialized to
this at driver startup time.  See the 
<A HREF="#config">Overview of the PCMCIA configuration scripts</A> for a discussion of schemes.
</DL>
<P>The low level socket drivers, <CODE>tcic</CODE> and <CODE>i82365</CODE>, have various
bus timing parameters that may need to be adjusted for certain systems
with unusual bus clocking.  Symptoms of timing problems can include
card recognition problems, lock-ups under heavy loads, high error
rates, or poor device performance.  Only certain host bridges have
adjustable timing parameters: check the corresponding man page to see
what options are available for your controller.  Here is a brief
summary:
<P>
<UL>
<LI>ISA-bus Cirrus controllers have numerous configurable timing
parameters.  The most important seems to be the <CODE>cmd_time</CODE> flag,
which determines the length of PCMCIA bus cycles.  Fast 486 systems
(i.e., DX4-100) seem to often benefit from increasing this from 6 (the
default) to 12 or 16.</LI>
<LI>The Cirrus PD6729 PCI controller has the <CODE>fast_pci</CODE> flag, which
should be set if the PCI bus speed is greater than 25 MHz.</LI>
<LI>For Vadem VG-468 controllers, the <CODE>async_clock</CODE> flag changes the
relative clocking of PCMCIA bus and host bus cycles.  Setting this
flag adds extra wait states to some operations.  However, I have yet
to hear of a laptop that needs this.</LI>
<LI>The <CODE>pcmcia_core</CODE> module has the <CODE>cis_speed</CODE> parameter for
changing the memory speed used for accessing a card's Card Information
Structure (CIS).  On some systems, increasing this parameter (i.e.,
slowing down card accesses) may fix card recognition problems.</LI>
<LI>Another <CODE>pcmcia_core</CODE> parameter, <CODE>io_speed</CODE>, can be used to slow
down accesses to IO cards.  It may help in certain cases with systems
that have out-of-spec PCMCIA bus timing.</LI>
<LI>This is not a timing issue, but if you have more than one ISA-to-PCMCIA
controller in your system or extra sockets in a laptop docking station,
the <CODE>i82365</CODE> module should be loaded with the <CODE>extra_sockets</CODE>
parameter set to 1.  This should not be necessary for detection of
PCI-to-PCMCIA or PCI-to-CardBus bridges.</LI>
</UL>
<P>Here are some timing settings for a few old systems:
<P>
<UL>
<LI>On the ARM Pentium-90 or Midwest Micro Soundbook Plus, use
``<CODE>freq_bypass=1 cmd_time=8</CODE>''.</LI>
<LI>On a Compaq Presario 1220, try ``<CODE>setup_time=1</CODE>''.</LI>
<LI>On a Midwest Micro Soundbook Elite, use ``<CODE>cmd_time=12</CODE>''.</LI>
<LI>On a Gateway Liberty, try ``<CODE>cmd_time=16</CODE>''.</LI>
<LI>On a Samsung SENS 810, use ``<CODE>fast_pci=1</CODE>''.</LI>
</UL>
<P>
<H3>Card readers for desktop systems</H3>

<P>While almost all PCMCIA card readers and card docks work fine under
Linux, some require special startup options because they do not behave
exactly like laptop PCMCIA bridges.  PCI card readers, in particular,
may handle interrupts differently.  Some of the following parameter
settings are only available for the <CODE>i82365</CODE> module in the
standalone drivers; the kernel's <CODE>yenta_socket</CODE> driver is not
configurable.
<P>
<UL>
<LI>The Linksys ProConnect PCMRDWR and Antec DataChute ISA card readers
are ``ISA Plug and Play'' devices.  To use these, you must first
activate them with the Linux isapnp tools.  See the man pages for
<CODE>pnpdump</CODE> and <CODE>isapnp</CODE> for more information.</LI>
<LI>For Chase CardPORT and Altec ISA card readers using the Cirrus PD6722
ISA-to-PCMCIA bridge, the <CODE>i82365</CODE> driver should be loaded with a
``<CODE>has_ring=0</CODE>'' parameter to prevent irq 15 conflicts.</LI>
<LI>For Elan P-series PCI card readers based on the Cirrus PD6729
PCI-to-PCMCIA bridge chip, the <CODE>i82365</CODE> driver requires a
``<CODE>irq_mode=1</CODE>'' parameter.</LI>
<LI>For the Sycard PCChost1200 host adapter, the <CODE>i82365</CODE> driver
requires a ``<CODE>p2cclk=1</CODE>'' parameter.</LI>
<LI>For the Alex Electronics PCICBI host adapter based on the TI 1221
bridge, the <CODE>i82365</CODE> driver requires ``<CODE>p2cclk=1 irq_mode=0</CODE>''
as well as PCMCIA driver release 3.1.23 or later.</LI>
<LI>With SCM Microsystems SBP series PCI card readers (which are also
being distributed with Lucent WaveLAN IEEE cards), and for the
Synchrotech PCM-CR-PC2IF and PCM-CR-PC2IR, it is necessary to
specify ``<CODE>irq_mode=0</CODE>'' for the <CODE>i82365</CODE> module, to force use
of PCI interrupts.</LI>
<LI>For the ActionTec PC 750 card reader, and for the Antec Datachute PCI
card reader, the <CODE>i82365</CODE> driver requires a ``<CODE>irq_list=0</CODE>''
parameter, to indicate that ISA interrupts are unavailable.</LI>
<LI>The PLX Technologies PCI9052 (also sold as the Linksys WDT11) is not a
general purpose PCMCIA card reader at all: it is a PCI interface card
for use with certain wireless adapters, that makes them look like
ordinary PCI devices.  These devices are not supported.</LI>
</UL>
<P>
<H2><A NAME="ss2.5">2.5 System resource settings</A>
</H2>

<P>Card Services should automatically avoid allocating IO ports and
interrupts already in use by other standard devices.  It will also
attempt to detect conflicts with unknown devices, but this is not
completely reliable.  In some cases, you may need to explicitly
exclude resources for a device in <CODE>/etc/pcmcia/config.opts</CODE>.
<P>Here are some resource settings for specific laptop types.  View this
list with suspicion: it may give useful hints for solving problems,
but it is inevitably out of date and certainly contains mistakes.
Corrections and additions are welcome. 
<P>
<UL>
<LI>On the AMS SoundPro, exclude irq 10.</LI>
<LI>On some AMS TravelPro 5300 models, use memory 0xc8000-0xcffff.</LI>
<LI>On the BMX 486DX2-66, exclude irq 5, irq 9.</LI>
<LI>On the Chicony NB5, use memory 0xda000-0xdffff.</LI>
<LI>On the Compaq Presario 900Z, exclude port 0x3b0-0x3bb.</LI>
<LI>On the Compaq Presario 1020, exclude port 0x2f8-0x2ff, irq 3, irq 5.</LI>
<LI>On the Compaq Presario 2120EA, exclude irq 10.</LI>
<LI>On the Dell Inspiron 7000, exclude irq 3, irq 5.</LI>
<LI>On the Dell Inspiron 8000, exclude port 0x800-0x8ff.</LI>
<LI>On the Fujitsu C series, exclude port 0x200-0x27f.</LI>
<LI>On the HP Omnibook 4000C, exclude port 0x300-0x30f.</LI>
<LI>On the HP Omnibook 4100, exclude port 0x220-0x22f.</LI>
<LI>On the IBM ThinkPad 380, and maybe the 385 and 600 series, exclude
port 0x230-0x233, and irq 5.</LI>
<LI>On IBM ThinkPad 600 and 770 models with internal modems, exclude port
0x2f8-0x2ff.</LI>
<LI>On the IBM ThinkPad 600E and 770Z, change the high memory window to
0x60000000-0x60ffffff.</LI>
<LI>On the Micron Millenia Transport, exclude irq 5, irq 9.</LI>
<LI>On the NEC Versa M, exclude irq 9, port 0x2e0-2ff.</LI>
<LI>On the NEC Versa P/75, exclude irq 5, irq 9.</LI>
<LI>On the NEC Versa S, exclude irq 9, irq 12.</LI>
<LI>On the NEC Versa 6000 series, exclude port 0x2f8-0x33f, irq 9, irq 10.</LI>
<LI>On the NEC Versa SX, exclude port 0x300-0x31f.</LI>
<LI>On the ProStar 9200, Altima Virage, and Acquiline Hurricane DX4-100,
exclude irq 5, port 0x330-0x35f.  Maybe use memory 0xd8000-0xdffff.</LI>
<LI>On the Siemens Nixdorf SIMATIC PG 720C, use memory 0xc0000-0xcffff,
port 0x300-0x3bf.</LI>
<LI>On the TI TravelMate 5000, use memory 0xd4000-0xdffff.</LI>
<LI>On the Toshiba Satellite 4030CDS, exclude irq 9.</LI>
<LI>On the Toshiba T4900 CT, exclude irq 5, port 0x2e0-0x2e8, port
0x330-0x338.</LI>
<LI>On the Toshiba Tecra 8000, exclude irq 3, irq 5, irq 9.</LI>
<LI>On the Twinhead 5100, HP 4000, Sharp PC-8700 and PC-8900, exclude
irq 9 (sound), irq 12.</LI>
<LI>On an MPC 800 Series, exclude irq 5, port 0x300-0x30f for the CD-ROM.</LI>
</UL>
<P>
<H3>PowerBook specific settings</H3>

<P>On PowerPC based PowerBook systems, the default system resources in
<CODE>/etc/pcmcia/config.opts</CODE> file are no good at all.  Replace all
the IO port and window definitions with something like:
<P>
<BLOCKQUOTE><CODE>
<PRE>
include port 0x100-0x4ff, port 0x1000-0x17ff
include memory 0x80000000-0x80ffffff
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H2><A NAME="distributions"></A> <A NAME="ss2.6">2.6 Notes about specific Linux distributions</A>
</H2>

<P>This section is incomplete.  Corrections and additions are welcome.
<P>
<H3>Debian</H3>

<P>Debian uses a System V boot script arrangement.  The PCMCIA startup
script is installed as <CODE>/etc/init.d/pcmcia</CODE>.  New packages use
<CODE>/etc/default/pcmcia</CODE> for startup options; older versions used
<CODE>/etc/pcmcia.conf</CODE> for this purpose.  Debian's syslog
configuration will place kernel messages in <CODE>/var/log/messages</CODE>
and <CODE>cardmgr</CODE> messages in <CODE>/var/log/daemon.log</CODE>.
<P>Debian distributes the PCMCIA system in two packages: the
``<CODE>pcmcia-cs</CODE>'' package contains <CODE>cardmgr</CODE> and other tools, man
pages, and configuration scripts; and the ``<CODE>pcmcia-modules</CODE>''
package contains the kernel driver modules.
<P>Starting with 3.1.25, a clean PCMCIA install will identify Debian
systems and create a special <CODE>network.opts</CODE> file that, in the
absence of other network configuration settings, uses Debian's
<CODE>ifup</CODE> and <CODE>ifdown</CODE> commands to configure a network card based
on settings in <CODE>/etc/network/interfaces</CODE>.
<P>
<H3>Red Hat, Caldera, Mandrake</H3>

<P>These distributions use a System V boot script organization.  The
PCMCIA startup script is installed as
<CODE>/etc/rc.d/init.d/pcmcia</CODE>, and boot options are kept in
<CODE>/etc/sysconfig/pcmcia</CODE>.  Beware that installing the Red Hat
package may install a default boot option file that has PCMCIA
disabled.  To enable PCMCIA, the ``<CODE>PCMCIA</CODE>'' variable should be
set to ``<CODE>yes</CODE>''.  Red Hat's default <CODE>syslogd</CODE> configuration will
record all interesting messages in <CODE>/var/log/messages</CODE>.
<P>Red Hat's PCMCIA package contains a replacement for the network setup
script, <CODE>/etc/pcmcia/network</CODE>, which meshes with the Red Hat
<CODE>linuxconf</CODE> configuration system.  This is convenient for the case
where just one network adapter is used, with one set of network
parameters, but does not have the full flexibility of the regular
PCMCIA network script.  Compiling and installing a clean PCMCIA source
distribution will overwrite the network script, breaking the link to
the Red Hat tools.  If you prefer using the Red Hat tools, either use
only Red Hat RPM's, or replace <CODE>/etc/pcmcia/network.opts</CODE> with
the following:
<P>
<BLOCKQUOTE><CODE>
<PRE>
if [ -f /etc/sysconfig/network-scripts/ifcfg-$2 ] ; then
    start_fn () {
        . /etc/sysconfig/network-scripts/ifcfg-$1
        if [ "$ONBOOT" = "yes" ] ; then /sbin/ifup $1 ; fi
    }
    stop_fn () {
        /sbin/ifdown $1
    }
fi
</PRE>
</CODE></BLOCKQUOTE>
<P>Starting with the 3.1.22 release, the PCMCIA installation script will
automatically append a variant of this to the default
<CODE>network.opts</CODE> file, so this problem should no longer be an issue.
<P>If you do use <CODE>linuxconf</CODE> (or <CODE>netconf</CODE>) to configure your
network interface, leave the ``kernel module'', ``I/O port'', and
``irq'' parameters blank.  Setting these parameters may interfere with
proper operation of the PCMCIA subsystem.
<P>At boot time, when the Red Hat network subsystem starts up, it may say
``Delaying eth0 initialization'' and ``[FAILED]''.  This is actually
not a failure: it means that this network interface will not be
initialized until after the PCMCIA network device is configured.
<P>Red Hat bundles their slightly modified PCMCIA source distribution
with their kernel sources, rather than as a separate source package.
When preparing to build a new set of PCMCIA drivers, you will
generally want to install Red Hat's kernel-source RPM
(<CODE>kernel-source-*.i386.rpm</CODE>), and not the kernel SRPM
(<CODE>kernel-*.src.rpm</CODE>).  The SRPM is tailored for building their
kernel RPM files, which is not exactly what you want.  With Red Hat
7.0, the kernel-source RPM also includes a mis-configured PCMCIA
source tree; if you want to use it, delete their PCMCIA config.out
file and re-do "make config".
<P>
<H3>Slackware</H3>

<P>Slackware uses a BSD boot script arrangement.  The PCMCIA startup
script is installed as <CODE>/etc/rc.d/rc.pcmcia</CODE>, and boot options
are specified in <CODE>rc.pcmcia</CODE> itself.  The PCMCIA startup script
is invoked from <CODE>/etc/rc.d/rc.S</CODE>.
<P>
<H3>SuSE</H3>

<P>SuSE uses a System V init script arrangement, with init scripts stored
under <CODE>/etc/init.d</CODE>.  The PCMCIA startup script is installed as
<CODE>/etc/init.d/pcmcia</CODE>, and startup options are kept in
<CODE>/etc/rc.config</CODE>.  Before release 7.0, init scripts were kept
under <CODE>/sbin/init.d</CODE>.  In early SuSE releases (pre-5.3), the
PCMCIA startup script was somewhat limited and did not allow PCMCIA
startup variables to be overridden from the <CODE>lilo</CODE> boot prompt.
<P>SuSE 8.0 includes both the standalone PCMCIA modules, and the 2.4
kernel PCMCIA subsystem modules.  A new variable, <CODE>PCMCIA_SYSTEM</CODE>,
is available in <CODE>/etc/sysconfig/pcmcia</CODE> to choose between
these.  It can be set to either ``kernel'' or ``external''.
<P>To look up current PCMCIA issues in SuSE's support database, go to
<A HREF="http://sdb.suse.de/cgi-bin/sdbsearch_en.cgi?stichwort=PCMCIA">http://sdb.suse.de/cgi-bin/sdbsearch_en.cgi?stichwort=PCMCIA</A>.
<P>
<HR>
<H2><A NAME="s3">3.</A> <A HREF="#toc3">Resolving installation and configuration problems</A></H2>

<P>This section describes some of the most common failure modes for the
PCMCIA subsystem.  Try to match your symptoms against the examples.
This section only describes general failures that are not specific
to a particular client driver or type of card.
<P>Before trying to diagnose a problem, you have to know where your
system log is kept (see 
<A HREF="#distributions">Notes about specific Linux distributions</A>).  You should also be familiar with
basic diagnostic tools like <CODE>dmesg</CODE> and <CODE>lsmod</CODE>.  Also, be aware
that most driver components (including all the kernel modules) have
their own individual man pages. 
<P>In 3.1.15 and later releases, the <CODE>debug-tools</CODE> subdirectory of the
PCMCIA source tree has a few scripts to help diagnose some of the most
common configuration problems.  The <CODE>test_setup</CODE> script checks your
PCMCIA installation for completeness.  The <CODE>test_network</CODE> and
<CODE>test_modem</CODE> scripts will try to diagnose problems with PCMCIA
network and modem cards.  These scripts can be particularly helpful if
you are unfamiliar with Linux and are not sure how to approach a
problem.
<P>Try to define your problem as narrowly as possible.  If you have
several cards, try each card in isolation, and in different
combinations.  Try cold Linux boots, versus warm boots from Windows.
Compare booting with cards inserted, versus inserting cards after
boot.  If you normally use your laptop docked, try it undocked.  And
sometimes, two sockets will behave differently.
<P>For debugging problems in the device configuration scripts, it may be
useful to start <CODE>cardmgr</CODE> with the ``<CODE>-v</CODE>'' option.  With a
3.1.23 or later PCMCIA package, this will cause most important script
actions to be recorded in the system log.
<P>It is nearly impossible to debug driver problems encountered when
attempting to install Linux via a PCMCIA device.  Even if you can
identify the problem based on its symptoms, installation disks are
difficult to modify, especially without access to a running Linux
system.  Customization of installation disks is completely dependent
on the choice of Linux distribution, and is beyond the scope of this
document.  In general, the best course of action is to install Linux
using some other means, obtain the latest drivers, and then debug the
problem if it persists.
<P>
<H2><A NAME="ss3.1">3.1 Base PCMCIA kernel modules do not load</A>
</H2>

<P>Symptoms:
<UL>
<LI>Kernel version mismatch errors are reported when the PCMCIA
startup script runs.</LI>
<LI>After startup, <CODE>lsmod</CODE> does not show any PCMCIA modules.</LI>
<LI><CODE>cardmgr</CODE> reports ``<CODE>no pcmcia driver in
/proc/devices</CODE>'' in the system log.</LI>
</UL>
<P>Kernel modules contain version information that is checked against the
current kernel when a module is loaded.  The type of checking depends
on the setting of the <CODE>CONFIG_MODVERSIONS</CODE> kernel option.  If this
is false, then the kernel version number is compiled into each module,
and <CODE>insmod</CODE> checks this for a match with the running kernel.  If
<CODE>CONFIG_MODVERSIONS</CODE> is true, then each symbol exported by the
kernel is given a sort of checksum.  These codes are all compared
against the corresponding codes compiled into a module.  The intent
was for this to make modules less version-dependent, because the
checksums would only change if a kernel interface changed, and would
generally stay the same across minor kernel updates.  In practice, the
checksums have turned out to be even more restrictive, because many
kernel interfaces depend on compile-time kernel option settings.
Also, the checksums turned out to be an excessively pessimistic judge
of compatibility.
<P>The practical upshot of this is that kernel modules are closely tied
to both the kernel version, and the setting of many kernel
configuration options.  Generally, a set of modules compiled for one
2.2.19 kernel will not load against some other 2.2.19 kernel unless
special care is taken to ensure that the two were built with similar
configurations.  This makes distribution of precompiled kernel modules
a tricky business.
<P>You have several options:
<P>
<UL>
<LI>If you obtained precompiled drivers as part of a Linux
distribution, verify that you are using an unmodified kernel as
supplied with that distribution.  If you intend to use precompiled
modules, you generally must stick with the corresponding kernel.</LI>
<LI>If you have reconfigured or upgraded your kernel, you will
probably need to compile and install the PCMCIA package from scratch.
This is easily done if you already have the kernel source tree
installed.  See 
<A HREF="#compile">Compilation and installation</A>
for detailed instructions.</LI>
<LI>In some cases, incompatibilities in other system components can 
prevent correct loading of kernel modules.  If you have upgraded your
own kernel, pay attention to the ``minimal requirements'' for module
utilities and binutils listed in the <CODE>Documentation/Changes</CODE>
file in the kernel source code tree.  
</LI>
</UL>
<P>
<H2><A NAME="ss3.2">3.2 Some client driver modules do not load</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>The base modules (<CODE>pcmcia_core</CODE>, <CODE>ds</CODE>, <CODE>i82365</CODE>) load correctly.</LI>
<LI>Inserting a card gives a high beep + low beep pattern.</LI>
<LI><CODE>cardmgr</CODE> reports version mismatch errors in the system log.</LI>
</UL>
<P>Some of the driver modules require kernel services that may or may not
be present, depending on kernel configuration.  For instance, the SCSI
card drivers require that the kernel be configured with SCSI support,
and the network drivers require a networking kernel.  If a kernel
lacks a necessary feature, <CODE>insmod</CODE> may report undefined symbols
and refuse to load a particular module. Note that <CODE>insmod</CODE> error
messages do not distinguish between version mismatch errors and
missing symbol errors.
<P>Specifically:
<UL>
<LI>The serial client driver <CODE>serial_cs</CODE> requires the kernel
serial driver to be enabled with <CODE>CONFIG_SERIAL</CODE>.  This driver may
be built as a module.</LI>
<LI>Support for multiport serial cards or multifunction cards that
include serial or modem devices requires <CODE>CONFIG_SERIAL_SHARE_IRQ</CODE>
to be enabled.</LI>
<LI>The SCSI client drivers require that <CODE>CONFIG_SCSI</CODE> be
enabled, along with the appropriate top level driver options
(<CODE>CONFIG_BLK_DEV_SD</CODE>, <CODE>CONFIG_BLK_DEV_SR</CODE>, etc for 2.2 and later
kernels).  These may be built as modules.</LI>
<LI>The network client drivers require that <CODE>CONFIG_INET</CODE> is
enabled.  Kernel networking support cannot be compiled as a module.</LI>
<LI>The token-ring client requires that the kernel be compiled with
<CODE>CONFIG_TR</CODE> enabled.</LI>
</UL>
<P>There are two ways to proceed:
<UL>
<LI>Rebuild your kernel with the necessary features enabled.</LI>
<LI>If the features have been compiled as modules, then modify
<CODE>/etc/pcmcia/config</CODE> to preload these modules.</LI>
</UL>
<P>The <CODE>/etc/pcmcia/config</CODE> file can specify that additional
modules need to be loaded for a particular client.  For example, for
the serial driver, one would use:
<P>
<BLOCKQUOTE><CODE>
<PRE>
device "serial_cs"
  class "serial" module "misc/serial", "serial_cs"
</PRE>
</CODE></BLOCKQUOTE>
<P>Module paths are specified relative to the top-level module directory
for the current kernel version; if no relative path is given, then the
path defaults to the <CODE>pcmcia</CODE> subdirectory.
<P>
<H2><A NAME="irqscan"></A> <A NAME="ss3.3">3.3 ISA interrupt scan failures</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>The system locks up when the PCMCIA drivers are loaded, even
with no cards present.</LI>
<LI>The system log shows a successful host controller probe just
before the lock-up, but does not show interrupt probe results.</LI>
</UL>
<P>After identifying the host controller type, the socket driver probes
for free ISA bus interrupts.  The probe involves programming the
controller for each apparently free interrupt, then generating a
``soft'' interrupt, to see if the interrupt can be detected correctly.
In some cases, probing a particular interrupt can interfere with
another system device.   
<P>The reason for the probe is to identify interrupts which appear to be
free (i.e., are not reserved by any other Linux device driver), yet
are either not physically wired to the host controller, or are
connected to another device that does not have a driver.
<P>In the system log, a successful probe might look like:
<P>
<BLOCKQUOTE><CODE>
<PRE>
Intel PCIC probe:
  TI 1130 CardBus at mem 0x10211000, 2 sockets
  ...
  ISA irqs (scanned) = 5,7,9,10 status change on irq 10
</PRE>
</CODE></BLOCKQUOTE>
<P>There are two ways to proceed:
<UL>
<LI>The ISA interrupt probe can be restricted to a list of
interrupts using the <CODE>irq_list</CODE> parameter for the socket drivers.
For example, ``<CODE>irq_list=5,9,10</CODE>'' would limit the scan to three
interrupts.  All 16-bit PCMCIA devices will be restricted to using
these interrupts (assuming they pass the probe).  You may need to use
trial and error to find out which interrupts can be safely probed.</LI>
<LI>The interrupt probe can be disabled entirely by loading the
socket driver with the ``do_scan=0'' option.  In this case, a default
interrupt list will be used, which just avoids interrupts already
allocated for other devices.</LI>
</UL>
<P>In either case, the probe options can be specified using the
<CODE>PCIC_OPTS</CODE> definition in the PCMCIA startup script, for example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
PCIC_OPTS="irq_list=5,9,10"
</PRE>
</CODE></BLOCKQUOTE>
<P>It should be noted that <CODE>/proc/interrupts</CODE> is completely
useless when it comes to diagnosing interrupt probe problems.  The
probe is sensible enough to never attempt to use an interrupt that is
already in use by another Linux driver.  So, the PCMCIA drivers are
already using all the information in <CODE>/proc/interrupts</CODE>.
Depending on system design, an inactive device can still occupy an
interrupt and cause trouble if it is probed for PCMCIA.
<P>
<H2><A NAME="ioscan"></A> <A NAME="ss3.4">3.4 IO port scan failures</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>The system locks up when <CODE>cardmgr</CODE> is first started.  For
3.1.24, the lockup happens even with no cards present; for 3.1.25, a
card must be inserted.</LI>
<LI>The system log shows a successful host controller probe,
including interrupt probe results, but does not show IO probe
results.  </LI>
<LI>In some cases, the IO probe will succeed, but report large
numbers of random exclusions.</LI>
</UL>
<P>When <CODE>cardmgr</CODE> processes IO port ranges listed in
<CODE>/etc/pcmcia/config.opts</CODE>, the kernel probes these ranges to
detect latent devices that occupy IO space but are not associated
with a Linux driver.  The probe is read-only, but in rare cases,
reading from a device may interfere with an important system function,
resulting in a lock-up.
<P>Your system user's guide may include a map of system devices, showing
their IO and memory ranges.  These can be explicitly excluded in
<CODE>config.opts</CODE>.
<P>Alternatively, if the probe is unreliable on your system, it can be
disabled by setting <CODE>CORE_OPTS</CODE> to ``<CODE>probe_io=0</CODE>''.  In this
case, you should be very careful to specify only genuinely available
ranges of ports in <CODE>config.opts</CODE>, instead of using the default
settings.
<P>
<H2><A NAME="ss3.5">3.5 Memory probe failures</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>The core drivers load correctly when no cards are present, with
no errors in the system log.</LI>
<LI>The system freezes and/or reboots as soon as any card is
inserted, before any beeps are heard.</LI>
</UL>
<P>Or alternately:
<UL>
<LI>All card insertions generate a high beep followed by a low beep.</LI>
<LI>All cards are identified as ``anonymous memory cards''.</LI>
<LI>The system log reports that various memory ranges have been
excluded.</LI>
</UL>
<P>The core modules perform a memory scan at the time of first 16-bit
card insertion.  This scan can potentially interfere with other memory
mapped devices.  Also, pre-3.0.0 driver packages perform a more
aggressive scan than more recent drivers.  The memory window is
defined in <CODE>/etc/pcmcia/config.opts</CODE>.  The default window is
large, so it may help to restrict the scan to a narrower range.
Reasonable ranges to try include 0xd0000-0xdffff, 0xc0000-0xcffff,
0xc8000-0xcffff, or 0xd8000-0xdffff.
<P>If you have DOS or Windows PCMCIA drivers, you may be able to deduce
what memory region those drivers use.  Note that DOS memory addresses
are often specified in ``segment'' form, which leaves off the final
hex digit (so an absolute address of 0xd0000 might be given as
0xd000).  Be sure to add the extra digit back when making changes to
<CODE>config.opts</CODE>.  
<P>Changing BIOS settings affecting how devices are mapped can sometimes
be useful.  Try changing settings for BIOS shadowing, or "Plug and
Play OS support".
<P>In unusual cases, a memory probe failure can indicate a timing
register setup problem with the host controller.  See the 
<A HREF="#startup">Startup options</A> section for information about
dealing with common timing problems.  This really only applies to
ISA-to-PCMCIA bus bridges.
<P>
<UL>
<LI><CODE>cs: warning: no high memory space available!</CODE></LI>
</UL>
<P>CardBus bridges can allocate memory windows outside of the 640KB-1MB
``memory hole'' in the ISA bus architecture.  It is generally a good
idea to configure CardBus bridges to use high memory windows, because
these are unlikely to conflict with other devices.  Also, CardBus
cards may require large memory windows, which may be difficult or
impossible to fit into low memory.  Card Services will preferentially
allocate windows in high memory for CardBus bridges, if both low and
high memory windows are defined in <CODE>config.opts</CODE>.  The default
<CODE>config.opts</CODE> includes several candidate high memory windows, one
of which will work in most cases.
<P>
<H2><A NAME="ss3.6">3.6 Failure to detect card insertions and removals</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>Cards are detected and configured properly if present at boot
time. </LI>
<LI>The drivers do not respond to insertion and removal events,
either by recording events in the system log, or by beeping.</LI>
</UL>
<P>In most cases, the socket driver (<CODE>i82365</CODE> or <CODE>tcic</CODE>) will
automatically probe and select an appropriate interrupt to signal card
status changes.  The automatic interrupt probe doesn't work on some
Intel-compatible controllers, including Cirrus chips and the chips
used in some IBM ThinkPads.  If a device is inactive at probe time,
its interrupt may also appear to be available.  In these cases, the
socket driver may pick an interrupt that is used by another device.
<P>With the <CODE>i82365</CODE> and <CODE>tcic</CODE> drivers, the <CODE>irq_list</CODE> option
can be used to limit the interrupts that will be tested.  This list
limits the set of interrupts that can be used by PCMCIA cards as well
as for monitoring card status changes.  The <CODE>cs_irq</CODE> option can
also be used to explicitly set the interrupt to be used for monitoring
card status changes.
<P>If you can't find an interrupt number that works, there is also a
polled status mode: both <CODE>i82365</CODE> and <CODE>tcic</CODE> will accept a
<CODE>poll_interval=100</CODE> option, to poll for card status changes once
per second.  This option should also be used if your system has a
shortage of interrupts available for use by PCMCIA cards.  Especially
for systems with more than one host controller, there is little
point in dedicating interrupts for monitoring card status changes.
<P>All these options should be set in the <CODE>PCIC_OPTS=</CODE> line in either
<CODE>/etc/rc.d/rc.pcmcia</CODE> or <CODE>/etc/sysconfig/pcmcia</CODE>,
depending on your site setup.
<P>
<H2><A NAME="ss3.7">3.7 Interrupt delivery problems</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>Cards appear to be configured successfully, but don't work.</LI>
<LI>Serial and modem cards may respond very sluggishly.</LI>
<LI>Network cards may report ``interrupt(s) dropped'', and/or
transmit timeouts.</LI>
</UL>
<P>The most simple interrupt delivery problems are due to conflicts with
other system devices.  These can generally be resolved by excluding
problem interrupts in <CODE>/etc/pcmcia/config.opts</CODE>.  To test, just
exclude interrupts one by one until either the problem is fixed or you
run out of interrupts.  If no interrupts work, then device conflicts
are probably not the problem.
<P>For CardBus bridges, a variety of other interrupt delivery issues may
come into play.  For a complete discussion, see 
<A HREF="#irqmode">PCI interrupt delivery problems</A>.
<P>
<H2><A NAME="ss3.8">3.8 System resource starvation</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>When a card is inserted, it is identified correctly but cannot
be configured (high/low beep pattern).</LI>
<LI>One of the following messages will appear in the system log:
<BLOCKQUOTE><CODE>
<PRE>
RequestIO: Resource in use
RequestIRQ: Resource in use
RequestWindow: Resource in use
GetNextTuple: No more items
could not allocate nn IO ports for CardBus socket n
could not allocate nnK memory for CardBus socket n
could not allocate interrupt for CardBus socket n
</PRE>
</CODE></BLOCKQUOTE>
</LI>
</UL>
<P>Interrupt starvation often indicates a problem with the interrupt
probe (see 
<A HREF="#irqscan">Interrupt scan failures</A>).  In
some cases, the probe will seem to work, but only report one or two
available interrupts.  Check your system log to see if the scan
results look sensible.  Disabling the probe and selecting interrupts
manually should help.
<P>If the interrupt probe is not working properly, the socket driver may
allocate an interrupt for monitoring card insertions, even when
interrupts are too scarce for this to be a good idea.  You can switch
the controller to polled mode by setting <CODE>PCIC_OPTS</CODE> to
``<CODE>poll_interval=100</CODE>'.  Or, if you have a CardBus controller and
an older version of the PCMCIA drivers, try ``<CODE>pci_csc=1</CODE>'', which
selects a PCI interrupt (if available) for card status changes.
<P>In some cases, kernel misconfiguration can also produce an apparent
interrupt shortage.  On 2.4 and later kernels, if <CODE>CONFIG_ISA</CODE>
is not enabled, then the PCMCIA drivers will assume no ISA bus
interrupts are available.
<P>IO port starvation is fairly uncommon, but sometimes happens with
cards that require large, contiguous, aligned regions of IO port
space, or that only recognize a few specific IO port positions.  The
default IO port ranges in <CODE>/etc/pcmcia/config.opts</CODE> are
normally sufficient, but may be extended.  If this is the problem,
try uncommenting the ``<CODE>include port 0x1000-0x17ff</CODE>'' line in
<CODE>config.opts</CODE>.  In rare cases, starvation may indicate that the IO
port probe failed (see 
<A HREF="#ioscan">IO port scan failures</A>).
<P>Memory starvation is also uncommon with the default memory window
settings in <CODE>config.opts</CODE>.  CardBus cards may require larger memory
regions than typical 16-bit cards.  Since CardBus memory windows can
be mapped anywhere in the host's PCI address space (rather than just
in the 640K-1MB ``hole'' in PC systems), it is helpful to specify
large memory windows in high memory, such as 0xa0000000-0xa0ffffff.
<P>
<H2><A NAME="ss3.9">3.9 Resource conflict only with two cards inserted</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>Two cards each work fine when used separately.</LI>
<LI>When both cards are inserted, only one works.</LI>
</UL>
<P>This usually indicates a resource conflict with a system device that
Linux does not know about.  PCMCIA devices are dynamically configured,
so, for example, interrupts are allocated as needed, rather than
specifically assigned to particular cards or sockets.  Given a list of
resources that appear to be available, cards are assigned resources in
the order they are configured.  In this case, the card configured last
is being assigned a resource that in fact is not free.
<P>Check the system log to see what resources are used by the non-working
card.  Exclude these in <CODE>/etc/pcmcia/config.opts</CODE>, and restart
the <CODE>cardmgr</CODE> daemon to reload the resource database.
<P>
<H2><A NAME="ss3.10">3.10 Device configuration does not complete</A>
</H2>

<P>
<P>Symptoms:
<UL>
<LI>When a card is inserted, exactly one high beep is heard.</LI>
<LI>Subsequent card insertions and removals may be ignored.</LI>
</UL>
<P>This indicates that the card was identified successfully, however,
<CODE>cardmgr</CODE> has been unable to complete the configuration process for
some reason.  The most likely reason is that a step in the card setup
script has blocked.  A good example would be the network script
blocking if a network card is inserted with no actual network hookup
present.
<P>To pinpoint the problem, you can manually run a setup script to see
where it is blocking.  The scripts are in the <CODE>/etc/pcmcia</CODE>
directory.  They take two parameters: a device name, and an action.
The <CODE>cardmgr</CODE> daemon records the configuration commands in the
system log.  For example, if the system log shows that the command
``./network start eth0'' was the last command executed by
<CODE>cardmgr</CODE>, the following command would trace the script:
<P>
<BLOCKQUOTE><CODE>
<PRE>
sh -x /etc/pcmcia/network start eth0
</PRE>
</CODE></BLOCKQUOTE>
<P>
<HR>
<H2><A NAME="s4">4.</A> <A HREF="#toc4">Usage and features</A></H2>

<H2><A NAME="ss4.1">4.1 Tools for configuring and monitoring PCMCIA devices</A>
</H2>

<P>If the modules are all loaded correctly, the output of the <CODE>lsmod</CODE>
command should look like the following, when no cards are inserted:
<P>
<BLOCKQUOTE><CODE>
<PRE>
Module                  Size  Used by
ds                      5640   2 
i82365                 15452   2 
pcmcia_core            30012   3  [ds i82365]
</PRE>
</CODE></BLOCKQUOTE>
<P>The system log should also include output from the socket driver
describing the host controller(s) found and the number of sockets
detected.
<P>
<H3>The cardmgr configuration daemon</H3>

<P>The <CODE>cardmgr</CODE> daemon is responsible for monitoring
PCMCIA sockets, 
loading client drivers when needed, and running user-level scripts in
response to card insertions and removals.  It records its actions in
the system log, but also uses beeps to signal card status changes.
The tones of the beeps indicate success or failure of particular
configuration steps.  Two high beeps indicate that a card was
identified and configured successfully.  A high beep followed by a low
beep indicates that a card was identified, but could not be configured
for some reason.  One low beep indicates that a card could not be
identified.
<P>The <CODE>cardmgr</CODE> daemon configures cards based on a database of known
card types kept in <CODE>/etc/pcmcia/config</CODE>.  This file
describes the various client drivers, then describes how to identify
various cards, and which driver(s) belong with which cards.  The
format of this file is described in the <CODE>pcmcia(5)</CODE> man page.
<P>
<H3>The socket status file, stab</H3>

<P>
<P><CODE>Cardmgr</CODE> records device information for each socket in
<CODE>/var/lib/pcmcia/stab</CODE>.  Here is a sample
<CODE>stab</CODE> listing: 
<P>
<BLOCKQUOTE><CODE>
<PRE>
Socket 0: Adaptec APA-1460 SlimSCSI
0       scsi    aha152x_cs      0       sda     8       0
0       scsi    aha152x_cs      1       scd0    11      0
Socket 1: Serial or Modem Card
1       serial  serial_cs       0       ttyS1   5       65
</PRE>
</CODE></BLOCKQUOTE>
<P>For the lines describing devices, the first field is the socket, the
second is the device class, the third is the driver name, the fourth
is used to number multiple devices associated with the same driver,
the fifth is the device name, and the final two fields are the major
and minor device numbers for this device (if applicable).  See the
<CODE>stab</CODE> man page for more info.
<P>In 2.4 and later kernels, hot plut PCI drivers for CardBus cards are
not managed by <CODE>cardmgr</CODE>; they are managed by the <CODE>hotplug</CODE>
subsystem.  See 
<A HREF="http://linux-hotplug.sourceforge.net">http://linux-hotplug.sourceforge.net</A> for
information about this facility.  When <CODE>cardmgr</CODE> sees a card that is
owned by a hot plug PCI driver, it will ignore that card.  There will
be one beep when these cards are inserted or ejected, but they will be
identified only as a ``CardBus hotplug device'' in the system log and
<CODE>stab</CODE> file.
<P>
<H3>The cardctl and cardinfo utilities</H3>

<P>
<P>The <CODE>cardctl</CODE> command can be used to check the status of a
socket, or to see how it is configured.  It can also be used to alter
the configuration status of a card.  Here is an example of the
output of the ``<CODE>cardctl config</CODE>'' command:
<P>
<BLOCKQUOTE><CODE>
<PRE>
Socket 0:
  not configured
Socket 1:
  Vcc = 5.0, Vpp1 = 0.0, Vpp2 = 0.0
  Card type is memory and I/O
  IRQ 3 is dynamic shared, level mode, enabled
  Speaker output is enabled
  Function 0:
    Config register base = 0x0800
      Option = 0x63, status = 0x08
    I/O window 1: 0x0280 to 0x02bf, auto sized
    I/O window 2: 0x02f8 to 0x02ff, 8 bit
</PRE>
</CODE></BLOCKQUOTE>
<P>Or ``<CODE>cardctl ident</CODE>'', to get card identification information:
<P>
<BLOCKQUOTE><CODE>
<PRE>
Socket 0:
  no product info available
Socket 1:
  product info: "LINKSYS", "PCMLM336", "A", "0040052D6400"
  manfid: 0x0143, 0xc0ab
  function: 0 (multifunction)
</PRE>
</CODE></BLOCKQUOTE>
<P>The ``<CODE>cardctl suspend</CODE>'' and ``<CODE>cardctl resume</CODE>'' commands can
be used to shut down a card without unloading its associated drivers.
The ``<CODE>cardctl reset</CODE>'' command attempts to reset and reconfigure a
card. ``<CODE>cardctl insert</CODE>'' and ``<CODE>cardctl eject</CODE>'' mimic the
actions performed when a card is physically inserted or ejected,
including loading or unloading drivers, and configuring or shutting
down devices.  
<P>If you are running X, the <CODE>cardinfo</CODE> utility produces
a graphical display showing the current status of all PCMCIA sockets,
similar in content to ``<CODE>cardctl config</CODE>''.  It also provides a
graphical interface to most other <CODE>cardctl</CODE> functions.
<P>
<H3>Inserting and ejecting cards</H3>

<P>In theory, you can insert and remove PCMCIA cards at any time.
However, it is a good idea not to eject a card that is currently being
used by an application program.  Kernels older than 1.1.77 would often
lock up when serial/modem cards were ejected, but this should be fixed
now.
<P>Some card types cannot be safely hot ejected.  Specifically, ATA/IDE
and SCSI interface cards are not hot-swap-safe.  This is unlikely to
be fixed, because a complete solution would require significant
changes to the Linux block device model.  Also, it is generally not
safe to hot eject CardBus cards of any type.  This is likely to
improve gradually as hot swap bugs in the CardBus drivers are found
and fixed.  For these card types (IDE, SCSI, CardBus), it is
recommended that you always use ``<CODE>cardctl eject</CODE>'' before
ejecting.
<P>
<H3>Card Services and Advanced Power Management</H3>

<P>Card Services can be compiled with support for APM
(Advanced Power Management) if you've configured your
kernel with APM support.  The APM kernel driver is maintained by
Stephen Rothwell (Stephen.Rothwell@canb.auug.org.au).  The <CODE>apmd</CODE>
daemon is maintained by Avery Pennarun (apenwarr@worldvisions.ca), with
more information available at
<A HREF="http://www.worldvisions.ca/~apenwarr/apmd/">http://www.worldvisions.ca/~apenwarr/apmd/</A>.  The PCMCIA
modules will automatically be configured for APM if a compatible
version is detected on your system.
<P>Whether or not APM is configured, you can use ``<CODE>cardctl suspend</CODE>''
before suspending your laptop, and ``<CODE>cardctl resume</CODE>'' after
resuming, to cleanly shut down and restart your PCMCIA cards.  This
will not work with a modem that is in use, because the serial driver
isn't able to save and restore the modem operating parameters.
<P>APM seems to be unstable on some systems.  If you experience trouble
with APM and PCMCIA on your system, try to narrow down the problem to
one package or the other before reporting a bug.
<P>Some drivers, notably the PCMCIA SCSI drivers, cannot recover from a
suspend/resume cycle.  When using a PCMCIA SCSI card, always use
``<CODE>cardctl eject</CODE>'' prior to suspending the system.
<P>
<H3>Shutting down the PCMCIA system</H3>

<P>To unload the entire PCMCIA package, invoke <CODE>rc.pcmcia</CODE> with:
<P>
<BLOCKQUOTE><CODE>
<PRE>
/etc/rc.d/rc.pcmcia stop
</PRE>
</CODE></BLOCKQUOTE>
<P>This script will take several seconds to run, to give all client
drivers time to shut down gracefully.  If a device is currently in
use, the shutdown will be incomplete, and some kernel modules may not
be unloaded.  To avoid this, use ``<CODE>cardctl eject</CODE>'' to shut down
all sockets before invoking <CODE>rc.pcmcia</CODE>.  The exit status of the
<CODE>cardctl</CODE> command will indicate if any sockets could not be shut
down.
<P>
<H2><A NAME="config"></A> <A NAME="ss4.2">4.2 Overview of the PCMCIA configuration scripts</A>
</H2>

<P>The following information applies to cards that are managed by
<CODE>cardmgr</CODE>.  In 2.4 and later kernels, if the kernel PCMCIA
subsystem is active, then CardBus cards are managed by the
<CODE>hotplug</CODE> subsystem and the PCMCIA scripts are not used.
<P>Each PCMCIA device has an associated ``class'' that describes how it
should be configured and managed.  Classes are associated with device
drivers in <CODE>/etc/pcmcia/config</CODE>.  There are currently five IO
device classes (network, SCSI, cdrom, fixed disk, and serial) and
two memory device classes (memory and FTL).  For each class,
there are two
scripts in <CODE>/etc/pcmcia</CODE>: a main configuration script
(i.e., <CODE>/etc/pcmcia/scsi</CODE> for SCSI devices), and an options
script (i.e., <CODE>/etc/pcmcia/scsi.opts</CODE>).  The main script for a
device will be invoked to configure that device when a card is
inserted, and to shut down the device when the card is removed.  For
cards with several associated devices, the script will be invoked for
each device.
<P>The config scripts start by extracting some information about a device
from the <CODE>stab</CODE> file.  Each script constructs a ``device address'',
that uniquely describes the device it has been asked to configure, in
the <CODE>ADDRESS</CODE> shell variable.  This is passed to the <CODE>*.opts</CODE>
script, which should return information about how a device at this
address should be configured.  For some devices, the device address is
just the socket number.  For others, it includes extra information
that may be useful in deciding how to configure the device.  For
example, network devices pass their hardware ethernet address as part
of the device address, so the <CODE>network.opts</CODE> script could use this
to select from several different configurations.
<P>The first part of all device addresses is the current PCMCIA
``scheme''.  This parameter is used to support multiple sets of device
configurations based on a single external user-specified variable.
One use of schemes would be to have a ``home'' scheme, and a ``work''
scheme, which would include different sets of network configuration
parameters.  The current scheme is selected using the ``<CODE>cardctl
scheme</CODE>'' command.  The default if no scheme is set is ``default''.
<P>There are a few additional shell variables that can be used in
<CODE>*.opts</CODE> files in addition to <CODE>ADDRESS</CODE>:
<P>
<DL>
<DT><B><CODE>SOCKET</CODE>, <CODE>CLASS</CODE>, <CODE>DRIVER</CODE>, <CODE>INSTANCE</CODE>, <CODE>DEVICE</CODE>, <CODE>MAJOR</CODE>, <CODE>MINOR</CODE></B><DD><P>These correspond to individual fields from one line in the <CODE>stab</CODE>
file.  See its man page for details.
<DT><B><CODE>PRODID_1</CODE>, <CODE>PRODID_2</CODE>, <CODE>PRODID_3</CODE>, <CODE>PRODID_4</CODE>, <CODE>MANFID</CODE>, <CODE>FUNCID</CODE></B><DD><P>These are equivalent to the output of ``<CODE>cardctl info</CODE>'' and give
more detailed card identification information.
</DL>
<P>As the <CODE>*.opts</CODE> files are just shell scripts, it is not required
that they follow the form of the examples, which just return settings
based on <CODE>ADDRESS</CODE>.
<P>As a general rule, when configuring Linux for a laptop, PCMCIA devices
should only be configured from the PCMCIA device scripts.  Do not try
to configure a PCMCIA device the same way you would configure a
permanently attached device.  However, some Linux distributions
provide PCMCIA packages that are hooked into those distributions' own
device configuration tools.  In that case, some of the following
sections may not apply; ideally, this will be documented by the
distribution maintainers.
<P>
<H2><A NAME="ss4.3">4.3 PCMCIA network adapters</A>
</H2>

<P>Linux ethernet-type network interfaces normally have names like
<CODE>eth0</CODE>, <CODE>eth1</CODE>, and so on.  Token-ring adapters are handled
similarly, however they are named <CODE>tr0</CODE>, <CODE>tr1</CODE>, and so on.
The <CODE>ifconfig</CODE> command is used to
view or modify the state of a network interface.  A peculiarity of
Linux is that network interfaces do not have corresponding device
files under <CODE>/dev</CODE>, so do not be surprised when you do not find
them.
<P>When an ethernet card is detected, it will be assigned the first free
interface name, which will normally be <CODE>eth0</CODE>.  <CODE>Cardmgr</CODE> will
run the <CODE>/etc/pcmcia/network</CODE> script to configure the
interface, which normally reads network settings from
<CODE>/etc/pcmcia/network.opts</CODE>.  The <CODE>network</CODE> and
<CODE>network.opts</CODE> scripts will be executed only when your ethernet
card is actually present.  If your system has an automatic network
configuration facility, it may or may not be PCMCIA-aware.  Consult
the documentation of your Linux distribution and the
<A HREF="#distributions">Notes about specific Linux distributions</A>  to determine if PCMCIA network devices should be
configured with the automatic tools, or by editing <CODE>network.opts</CODE>.
<P>The device address passed to <CODE>network.opts</CODE> consists of four
comma-separated fields: the scheme, the socket number, the device
instance, and the card's hardware ethernet address.  The device
instance is used to 
number devices for cards that have several network interfaces, so it
will usually be 0.  If you have several network cards used for
different purposes, one option would be to configure the cards based
on socket position, as in:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,0,*,*)
    # definitions for network card in socket 0
    ;;
*,1,*,*)
    # definitions for network card in socket 1
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>Alternatively, they could be configured using their hardware
addresses, as in:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,*,*,00:80:C8:76:00:B1)
    # definitions for a D-Link card
    ;;
*,*,*,08:00:5A:44:80:01)
    # definitions for an IBM card
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Network device parameters</H3>

<P>The following parameters can be defined in <CODE>network.opts</CODE>:
<P>
<DL>
<DT><B><CODE>IF_PORT</CODE></B><DD><P>Specifies the ethernet transceiver type, for certain 16-bit cards that
do not autodetect.  See ``<CODE>man ifport</CODE>'' and ``<CODE>man mii-tool</CODE>''
for more information.
<DT><B><CODE>BOOTP</CODE></B><DD><P>A boolean (y/n) value: indicates if the host's IP address and routing
information should be obtained using the BOOTP protocol, with
<CODE>bootpc</CODE> or <CODE>pump</CODE>.
<DT><B><CODE>DHCP</CODE></B><DD><P>A boolean (y/n) value: indicates if the host's IP address and routing
information should be obtained from a DHCP server.  The network script
first looks for <CODE>dhcpcd</CODE>, then <CODE>dhclient</CODE>, then <CODE>pump</CODE>.
<DT><B><CODE>DHCP_HOSTNAME</CODE></B><DD><P>Specifies a hostname to be passed to <CODE>dhcpcd</CODE> or <CODE>pump</CODE>, for
inclusion in DHCP messages.
<DT><B><CODE>IPADDR</CODE></B><DD><P>The IP address for this interface.
<DT><B><CODE>NETMASK</CODE>, <CODE>BROADCAST</CODE>, <CODE>NETWORK</CODE></B><DD><P>Basic network parameters: see the networking HOWTO for more
information.  
<DT><B><CODE>GATEWAY</CODE></B><DD><P>The IP address of a gateway for this host's subnet.  Packets with
destinations outside this subnet will be routed to this gateway.
<DT><B><CODE>DOMAIN</CODE></B><DD><P>The local network domain name for this host, to be used in creating
<CODE>/etc/resolv.conf</CODE>.
<DT><B><CODE>SEARCH</CODE></B><DD><P>A search list for host name lookup, to be added to
<CODE>/etc/resolv.conf</CODE>.  <CODE>DOMAIN</CODE> and <CODE>SEARCH</CODE> are mutually
exclusive: see ``<CODE>man resolver</CODE>'' for more information.
<DT><B><CODE>DNS_1</CODE>, <CODE>DNS_2</CODE>, <CODE>DNS_3</CODE></B><DD><P>Host names or IP addresses for nameservers for this interface, to be
added to <CODE>/etc/resolv.conf</CODE>
<DT><B><CODE>MOUNTS</CODE></B><DD><P>A space-separated list of NFS mount points to be mounted for this interface.
<DT><B><CODE>IPX_FRAME</CODE>, <CODE>IPX_NETNUM</CODE></B><DD><P>For IPX networks: the frame type and network number, passed to the
<CODE>ipx_interface</CODE> command.
<DT><B><CODE>NO_CHECK</CODE>, <CODE>NO_FUSER</CODE></B><DD><P>Boolean (y/n) settings for card eject policy.  If <CODE>NO_CHECK</CODE> is
set, then ``<CODE>cardctl eject</CODE>'' will shut down a device even if
there are open connections. If <CODE>NO_FUSER</CODE> is set, then the script
will not check for busy NFS mounts or kill processes using those mounts.
</DL>
<P>For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,*,*,*)
    IF_PORT="10base2"
    BOOTP="n"
    IPADDR="10.0.0.1"
    NETMASK="255.255.255.0"
    NETWORK="10.0.0.0"
    BROADCAST="10.0.0.255"
    GATEWAY="10.0.0.1"
    DOMAIN="domain.org"
    DNS_1="dns1.domain.org"
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>To automatically mount and unmount NFS filesystems, first add all
these filesystems to <CODE>/etc/fstab</CODE>, but include <CODE>noauto</CODE>
in the mount options.  In <CODE>network.opts</CODE>, list the filesystem
mount points in the <CODE>MOUNTS</CODE> variable.  It is especially
important to use either <CODE>cardctl</CODE> or <CODE>cardinfo</CODE> to shut down a
network card when NFS mounts are active.  It is not possible to
cleanly unmount NFS filesystems if a network card is simply ejected
without warning.
<P>In addition to the usual network configuration parameters, the
<CODE>network.opts</CODE> script can specify extra actions to be taken after
an interface is configured, or before an interface is shut down.  If
<CODE>network.opts</CODE> defines a shell function called <CODE>start_fn</CODE>, it
will be invoked by the network script after the interface is
configured, and the interface name will be passed to the function as its
first (and only) argument.  Similarly, if it is defined, <CODE>stop_fn</CODE>
will be invoked before shutting down an interface.
<P>The transceiver type for some (mostly old) cards must be manually be
selected using the <CODE>IF_PORT</CODE> setting.  This can either be a numeric
value, or a keyword identifying the transceiver type.  All the network
drivers default to either autodetect the interface if possible, or
10baseT otherwise.  The <CODE>ifport</CODE> command can be used to check or
set the current transceiver type.  For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
# ifport eth0 10base2
# 
# ifport eth0
eth0    2 (10base2)
</PRE>
</CODE></BLOCKQUOTE>
<P>Most modern 10/100baseT cards use a ``media independent interface''
(MII) transceiver that automatically selects line speed and duplex
setting.  The <CODE>mii-tool</CODE> command can be used to monitor and control
the behavior of the MII interface.
<P>
<H3>Comments about specific cards</H3>

<P>
<P>
<UL>
<LI>With IBM CCAE and Socket EA cards, the transceiver type (10base2,
10baseT, AUI) needs to be set when the network device is configured.
Make sure that the transceiver type reported in the system log matches
your connection.</LI>
<LI>The Farallon EtherWave is actually based on the 3Com 3c589, with a
special transceiver.  Though the EtherWave uses 10baseT-style
connections, its transceiver requires that the 3c589 be configured in
10base2 mode.</LI>
<LI>If you have trouble with an IBM CCAE, NE4100, Thomas Conrad, or
Kingston adapter, try increasing the memory access
time with the <CODE>mem_speed=#</CODE> option to the <CODE>pcnet_cs</CODE> module.
An example of how to do this is given in the standard <CODE>config.opts</CODE>
file.  Try speeds of up to 1000 (in nanoseconds).</LI>
<LI>For the New Media Ethernet adapter, on some systems, it may be
necessary to increase the IO port access time with the
<CODE>io_speed=#</CODE> option when the <CODE>pcmcia_core</CODE> module is loaded.
Edit <CODE>CORE_OPTS</CODE> in the startup script  to set this option.</LI>
<LI>The multicast support in the New Media Ethernet driver is incomplete.
The latest driver will function with multicast kernels, but will ignore
multicast packets.  Promiscuous mode should work properly.</LI>
<LI>The driver used by the IBM and 3Com token ring adapters
seems to behave very badly if the cards are not connected to a ring
when they get initialized.  Always connect these cards to the net
before they are powered up.  If <CODE>ifconfig</CODE> reports the hardware
address as all 0's, this is likely to be due to a memory window
configuration problem.</LI>
<LI>Some Linksys, D-Link, and IC-Card 10baseT/10base2 cards have a unique
way of selecting the transceiver type that isn't handled by the Linux
drivers.  One workaround is to boot DOS and use the vendor-supplied
utility to select the transceiver, then warm boot Linux.
Alternatively, a Linux utility to perform this function is available
at 
<A HREF="http://pcmcia-cs.sourceforge.net/ftp/extras/dlport.c">http://pcmcia-cs.sourceforge.net/ftp/extras/dlport.c</A>.</LI>
<LI>16-bit PCMCIA cards have a maximum performance of 1.5-2 MB/sec.  That
means that any 16-bit 100baseT card (i.e., any card that uses the
<CODE>pcnet_cs</CODE>, <CODE>3c574_cs</CODE>, <CODE>smc91c92_cs</CODE>, or <CODE>xirc2ps_cs</CODE>
driver) will never achieve full 100baseT throughput.  Only CardBus
network adapters can fully exploit 100baseT data rates.</LI>
<LI>For WaveLAN wireless network adapters, Jean Tourrilhes
(<CODE>jt@hpl.hp.com</CODE>) has put together a wireless HOWTO at
<A HREF="http://www.hpl.hp.com/personal/Jean_Tourrilhes/Linux/">http://www.hpl.hp.com/personal/Jean_Tourrilhes/Linux/</A>.</LI>
</UL>
<P>
<H3>Diagnosing problems with network adapters</H3>

<P>
<P>
<UL>
<LI>In 3.1.15 and later PCMCIA releases, the <CODE>test_network</CODE> script in
the <CODE>debug-tools</CODE> subdirectory of the PCMCIA source tree will spot
some common problems.</LI>
<LI>Is your card recognized as an ethernet card?  Check the system log and
make sure that <CODE>cardmgr</CODE> identifies the card correctly and starts
up one of the network drivers.  If it doesn't, your card might still
be usable if it is compatible with a supported card.  This will be
most easily done if the card claims to be ``NE2000 compatible''.</LI>
<LI>Is the card configured properly?  If you are using a supported card,
and it was recognized by <CODE>cardmgr</CODE>, but still doesn't work, there
might be an interrupt or port conflict with another device.  Find out
what resources the card is using (from the system log),
and try excluding these in <CODE>/etc/pcmcia/config.opts</CODE> to force
the card to use something different.</LI>
<LI>If your card seems to be configured properly, but sometimes locks up,
particularly under high load, you may need to try changing your socket
driver timing parameters.  See the 
<A HREF="#startup">Startup options</A> section for more information.</LI>
<LI>If you get ``Network is unreachable'' messages when you try to
access the network, then the routing information specified in
<CODE>/etc/pcmcia/network.opts</CODE> is incorrect.  This exact message is
an absolutely foolproof indication of a routing error.  On the other
hand, mis-configured cards will usually fail silently.</LI>
<LI>If you are trying to use DHCP to configure your network interface, try
testing things with a static IP address instead, to rule out a DHCP
configuration problem.</LI>
<LI>To diagnose problems in <CODE>/etc/pcmcia/network.opts</CODE>, start by
trying to ping other systems on the same subnet using their IP
addresses.  Then try to ping your gateway, and then machines on other
subnets.  Ping machines by name only after trying these simpler tests.</LI>
<LI>Make sure your problem is really a PCMCIA one.  It may help to see see
if the card works under DOS with the vendor's drivers.  Double check
your modifications to the <CODE>/etc/pcmcia/network.opts</CODE> script.
Make sure your drop cable, ``T'' jack, terminator, etc are working.</LI>
<LI>Use real network cables.  Don't even think about using that old phone
cord you found in your basement.  And this means Category 5 cable for
100baseT.  It really matters.</LI>
</UL>
<P>
<H2><A NAME="ss4.4">4.4 PCMCIA serial and modem devices</A>
</H2>

<P>Linux serial devices are accessed via the <CODE>/dev/ttyS*</CODE> and
<CODE>/dev/cua*</CODE> special device files.  In pre-2.2 kernels, the
<CODE>ttyS*</CODE> devices were for incoming connections, such as directly
connected terminals, and the <CODE>cua*</CODE> devices were for outgoing
connections, such as modems.  Use of <CODE>cua*</CODE> devices is deprecated
in current kernels, and <CODE>ttyS*</CODE> can be used for all applications.
The configuration of a serial device can be examined and modified with
the <CODE>setserial</CODE> command.
<P>When a serial or modem card is detected, it will be assigned to the
first available serial device slot.  This will usually be
<CODE>/dev/ttyS1</CODE> (<CODE>cua1</CODE>) or <CODE>/dev/ttyS2</CODE> (<CODE>cua2</CODE>),
depending on the number of built-in serial ports.  The <CODE>ttyS*</CODE>
device is the one reported in <CODE>stab</CODE>.  The default
serial device option script, <CODE>/etc/pcmcia/serial.opts</CODE>, will
link the device file to <CODE>/dev/modem</CODE> as a convenience.  For
pre-2.2 kernels, the link is made to the <CODE>cua*</CODE> device.
<P>Do not try to use <CODE>/etc/rc.d/rc.serial</CODE> to configure a PCMCIA
modem.  This script should only be used to configure non-removable
devices.  Modify <CODE>/etc/pcmcia/serial.opts</CODE> if you want to do
anything special to set up your modem.  Also, do not try to change the
IO port and interrupt settings of a serial device using
<CODE>setserial</CODE>.  This would tell the serial driver to look for the
device in a different place, but would not change how the card's
hardware is actually configured.  The serial configuration script
allows you to specify other <CODE>setserial</CODE> options, as well as whether
a line should be added to <CODE>/etc/inittab</CODE> for this port.
<P>The device address passed to <CODE>serial.opts</CODE> has three
comma-separated fields: the first is the scheme, the second is the
socket number, and the third is the device instance.  The device
instance may take several values for cards that support multiple
serial ports, but for single-port cards, it will always be 0.  If you
commonly use more than one modem, you may want to specify different
settings based on socket position, as in:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,0,*)
    # Options for modem in socket 0
    LINK=/dev/modem0
    ;;
*,1,*)
    # Options for modem in socket 1
    LINK=/dev/modem1
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>If a PCMCIA modem is already configured when Linux boots, it may be
incorrectly identified as an ordinary built-in serial port.  This is
harmless, however, when the PCMCIA drivers take control of the modem,
it will be assigned a different device slot.  It is best to either
parse <CODE>stab</CODE> or use <CODE>/dev/modem</CODE>, rather than
expecting a PCMCIA modem to always have the same device assignment.
<P>If you configure your kernel to load the basic Linux serial port
driver as a module, you must edit <CODE>/etc/pcmcia/config</CODE> to
indicate that this module must be loaded.  Edit the serial device
entry to read:
<P>
<BLOCKQUOTE><CODE>
<PRE>
device "serial_cs"
  class "serial" module "misc/serial", "serial_cs"
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Serial device parameters</H3>

<P>The following parameters can be defined in <CODE>serial.opts</CODE>:
<DL>
<DT><B><CODE>LINK</CODE></B><DD><P>Specifies a path for a symbolic link to be created to the ``callout''
device (e.g., <CODE>/dev/cua*</CODE> for pre-2.2, or <CODE>/dev/ttyS*</CODE>
for 2.2 kernels).
<DT><B><CODE>SERIAL_OPTS</CODE></B><DD><P>Specifies options to be passed to the <CODE>setserial</CODE> command.
<DT><B><CODE>INITTAB</CODE></B><DD><P>If specified, this will be used to construct an <CODE>inittab</CODE> entry for
the device. 
<DT><B><CODE>NO_CHECK</CODE>, <CODE>NO_FUSER</CODE></B><DD><P>Boolean (y/n) settings for card eject policy.  If <CODE>NO_CHECK</CODE> is
true, then ``<CODE>cardctl eject</CODE>'' will shut down a device even if it
is busy.  If <CODE>NO_FUSER</CODE> is true, then the script will not try to
kill processes using an ejected device.
</DL>
<P>For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,*,*)
    LINK="/dev/modem"
    SERIAL_OPTS=""
    INITTAB="/sbin/getty"
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Comments about specific cards</H3>

<P>
<P>
<UL>
<LI>The Uniden Data 2000 Wireless CDPD card has some special dialing
strings for initiating SLIP and PPP mode.  For SLIP, use ``ATDT2'';
for PPP, "ATDT0".</LI>
<LI>Socket IO revision H serial port cards have a faster-than-normal
clock rate for the UART.  The card's actual baud rate is four times
faster than the serial driver thinks it is.  To work around the
problem, specify <CODE>SERIAL_OPTS="baud_base 460800"</CODE> in
<CODE>/etc/pcmcia/serial.opts</CODE>.</LI>
</UL>
<P>
<H3>Diagnosing problems with serial devices</H3>

<P>
<P>
<UL>
<LI>In 3.1.15 and later PCMCIA releases, the <CODE>test_modem</CODE> script in the
<CODE>debug-tools</CODE> subdirectory of the PCMCIA source tree will spot some
common problems. </LI>
<LI>Is your card recognized as a modem?  Check the system log and
make sure that <CODE>cardmgr</CODE> identifies the card correctly and starts up the
<CODE>serial_cs</CODE> driver.  If it doesn't, you may need to add a new entry to
your <CODE>/etc/pcmcia/config</CODE> file so that it will be identified properly.
See the 
<A HREF="#new-card">Configuring unrecognized cards</A>
section for details.</LI>
<LI>Is the modem configured successfully by serial_cs?  Again, check
the system log and look for messages from the serial_cs driver.  If
you see ``register_serial() failed'', you may have an I/O port conflict
with another device.  Another
tip-off of a conflict is if the device is reported to be an 8250; most
modern modems should be identified as 16550A UART's.  If you
think you're seeing a port conflict, edit <CODE>/etc/pcmcia/config.opts</CODE>
and exclude the port range that was allocated for the modem.  </LI>
<LI>Is there an interrupt conflict?  If the system log looks good,
but the modem just doesn't seem to work, try using <CODE>setserial</CODE> to
change the irq to 0, and see if the modem works.  This causes the
serial driver to use a slower polled mode instead of using interrupts.
If this seems to fix the problem, it is likely that some other device
in your system is using the interrupt selected by serial_cs.  You
should add a line to <CODE>/etc/pcmcia/config.opts</CODE> to exclude this
interrupt.</LI>
<LI>If the modem seems to work only very, very slowly, this is an almost
certain indicator of an interrupt conflict.</LI>
<LI>Make sure your problem is really a PCMCIA one.  It may help to see
if the card works under DOS with the vendor's drivers.  Also, don't
test the card with something complex like SLIP or PPP until you are
sure you can make simple connections.  If simple things work but SLIP
does not, your problem is most likely with SLIP, not with PCMCIA.</LI>
<LI>If you get kernel messages indicating that the serial_cs module cannot
be loaded, it means that your kernel does not have serial device
support.  If you have compiled the serial driver as a module, you must
modify <CODE>/etc/pcmcia/config</CODE> to indicate that the
<CODE>serial</CODE> module should be loaded before <CODE>serial_cs</CODE>.</LI>
</UL>
<P>
<H2><A NAME="ss4.5">4.5 PCMCIA parallel port devices</A>
</H2>

<P>The Linux parallel port driver is layered so that several high-level
device types can share use of the same low level port driver.  Printer
devices are accessed via the <CODE>/dev/lp*</CODE> special device files.
The configuration of a printer device can be examined and modified with
the <CODE>tunelp</CODE> command.
<P>The <CODE>parport_cs</CODE> module depends on the <CODE>parport</CODE> and
<CODE>parport_pc</CODE> drivers, which may be either compiled into the kernel
or compiled as modules.  The layered driver structure means that any
top-level parallel drivers (such as the plip driver, the printer
driver, etc) must be compiled as modules.  These drivers only 
recognize parallel port devices at module startup time, so they need
to be loaded after any PC Card parallel devices are configured.
<P>The device address passed to <CODE>parport.opts</CODE> has three
comma-separated fields: the first is the scheme, the second is the
socket number, and the third is the device instance.  The device
instance may take several values for cards that support multiple
parallel ports, but for single-port cards, it will always be 0.  If
you commonly use more than one such card, you may want to specify
different settings based on socket position, as in:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,0,*)
    # Options for card in socket 0
    LINK=/dev/printer0
    ;;
*,1,*)
    # Options for card in socket 1
    LINK=/dev/printer1
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Parallel device parameters</H3>

<P>The following parameters can be defined in <CODE>parport.opts</CODE>:
<DL>
<DT><B><CODE>LINK</CODE></B><DD><P>Specifies a path for a symbolic link to be created to the printer
port.
<DT><B><CODE>LP_OPTS</CODE></B><DD><P>Specifies options to be passed to the <CODE>tunelp</CODE> command.
<DT><B><CODE>NO_CHECK</CODE>, <CODE>NO_FUSER</CODE></B><DD><P>Boolean (y/n) settings for card eject policy.  If <CODE>NO_CHECK</CODE> is
true, then ``<CODE>cardctl eject</CODE>'' will shut down a device even if it
is busy.  If <CODE>NO_FUSER</CODE> is true, then the script will not try to
kill processes using an ejected device.
</DL>
<P>For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,*,*,*)
    LINK="/dev/printer"
    LP_OPTS=""
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Diagnosing problems with parallel port devices</H3>

<P>
<P>
<UL>
<LI>Is there an interrupt conflict?  If the system log looks good,
but the port just doesn't seem to work, try using <CODE>tunelp</CODE> to 
change the irq to 0, and see if things improve.  This switches the
driver to polling mode.  If this seems to fix the problem, it is
likely that some other device in your system is using the interrupt
selected by parport_cs.  You should add a line to
<CODE>/etc/pcmcia/config.opts</CODE> to exclude this interrupt.</LI>
<LI>If you get kernel messages indicating that the <CODE>parport_cs</CODE> module
cannot be loaded, it means that your kernel does not have parallel
device support.  If you have compiled the parallel driver as a module,
you may need to modify <CODE>/etc/pcmcia/config</CODE> to indicate that the
<CODE>parport</CODE> and <CODE>parport_pc</CODE> modules should be loaded before
<CODE>parport_cs</CODE>. </LI>
</UL>
<P>
<H2><A NAME="ss4.6">4.6 PCMCIA SCSI adapters</A>
</H2>

<P>All the currently supported PCMCIA SCSI cards are work-alikes of one
of the following ISA bus cards: the Qlogic, the Adaptec AHA-152X, or
the Future Domain TMC-16x0.  The PCMCIA drivers are built by linking
some PCMCIA-specific code (in <CODE>qlogic_cs.c</CODE>, <CODE>aha152x_cs.c</CODE>, or
<CODE>fdomain_cs.c</CODE>) with the normal Linux SCSI driver, pulled from the
Linux kernel source tree.  The Adaptec APA1480 CardBus driver is based
on the kernel aic7xxx PCI driver.  Due to limitations in the Linux
SCSI driver model, only one removable card per driver is supported.
<P>When a new SCSI host adapter is detected, the SCSI drivers will probe
for devices.  Check the system log to make sure your devices are
detected properly.  New SCSI devices will be assigned to the first
available SCSI device files.  The first SCSI disk will be
<CODE>/dev/sda</CODE>, the first SCSI tape will be <CODE>/dev/st0</CODE>, and
the first CD-ROM will be <CODE>/dev/scd0</CODE>.
<P>A list of SCSI devices connected to this host adapter will be shown in
<CODE>stab</CODE>, and the SCSI configuration script,
<CODE>/etc/pcmcia/scsi</CODE>, will be called once for each attached
device, to either configure or shut down that device.  The default
script does not take any actions to configure SCSI devices, but will
properly unmount filesystems on SCSI devices when a card is removed.
<P>The device addresses passed to <CODE>scsi.opts</CODE> are complicated, because
of the variety of things that can be attached to a SCSI adapter.
Addresses consist of either six or seven comma-separated fields: the
current scheme, the
device type, the socket number, the SCSI channel, ID, and logical unit
number, and optionally, the partition number.  The device type will be
``sd'' for disks, ``st'' for tapes, ``sr'' for CD-ROM devices, and
``sg'' for generic SCSI devices.  For most setups, the SCSI channel
and logical unit number will be 0.  For disk devices with several
partitions, <CODE>scsi.opts</CODE> will first be called for the whole device,
with a five-field address.  The script should set the <CODE>PARTS</CODE>
variable to a list of partitions.  Then, <CODE>scsi.opts</CODE> will be called
for each partition, with the longer six-field addresses.
<P>If your kernel does not have a top-level driver (disk, tape, etc) for
a particular SCSI device, then the device will not be configured by
the PCMCIA drivers.  As a side effect, the device's name in
<CODE>stab</CODE> will be something like ``sd#nnnn'' where ``nnnn''
is a four-digit hex number.  This happens when <CODE>cardmgr</CODE> is unable
to translate a SCSI device ID into a corresponding Linux device name.
<P>It is possible to modularize the top-level SCSI drivers so that they
are loaded on demand.  To do so, you need to edit
<CODE>/etc/pcmcia/config</CODE> to tell <CODE>cardmgr</CODE> which extra modules
need to be loaded when your adapter is configured.  For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
device "aha152x_cs"
  class "scsi" module "scsi/scsi_mod", "scsi/sd_mod", "aha152x_cs"
</PRE>
</CODE></BLOCKQUOTE>
<P>would say to load the core SCSI module and the top-level disk driver
module before loading the regular PCMCIA driver module.
<P>Always turn on SCSI devices before powering up your laptop, or before
inserting the adapter card, so that the SCSI bus is properly
terminated when the adapter is configured.  Also be very careful about
ejecting a SCSI adapter.  Be sure that all associated SCSI devices are
unmounted and closed before ejecting the card.  The best way to ensure
this is to use either <CODE>cardctl</CODE> or <CODE>cardinfo</CODE> to request card
removal before physically ejecting the card.  For now, all SCSI
devices should be powered up before plugging in a SCSI adapter, and
should stay connected until after you unplug the adapter and/or power
down your laptop.
<P>There is a potential complication when using these cards that does not
arise with ordinary ISA bus adapters.  The SCSI bus carries a
``termination power'' signal that is necessary for proper operation of
ordinary passive SCSI terminators.  PCMCIA SCSI adapters do not supply
termination power, so if it is required, an external device must
supply it.  Some external SCSI devices may be configured to supply
termination power.  Others, such as the Zip Drive and the Syquest
EZ-Drive, use active terminators that do not depend on it.  In some
cases, it may be necessary to use a special terminator block such as
the APS SCSI Sentry 2, which has an external power supply.  When
configuring your SCSI device chain, be aware of whether or not any of
your devices require or can provide termination power.
<P>
<H3>SCSI device parameters</H3>

<P>The following parameters can be defined in <CODE>scsi.opts</CODE>:
<DL>
<DT><B><CODE>LINK</CODE></B><DD><P>Specifies a path for a symbolic link to be created to this device.
<DT><B><CODE>DO_FSTAB</CODE></B><DD><P>A boolean (y/n) setting: specifies if an entry should be added to
<CODE>/etc/fstab</CODE> for this device.
<DT><B><CODE>DO_FSCK</CODE></B><DD><P>A boolean (y/n) setting: specifies if the filesystem should be checked
before being mounted, with ``<CODE>fsck -Ta</CODE>''.
<DT><B><CODE>DO_MOUNT</CODE></B><DD><P>A boolean (y/n) setting: specifies if this device should be
automatically mounted at card insertion time.
<DT><B><CODE>FSTYPE</CODE>, <CODE>OPTS</CODE>, <CODE>MOUNTPT</CODE></B><DD><P>The filesystem type, mount options, and mount point to be used for the
fstab entry and/or mounting the device.
<DT><B><CODE>NO_CHECK</CODE>, <CODE>NO_FUSER</CODE></B><DD><P>Boolean (y/n) settings for card eject policy.  If <CODE>NO_CHECK</CODE> is
true, then ``<CODE>cardctl eject</CODE>'' will shut down a device even if it
is busy.  If <CODE>NO_FUSER</CODE> is true, then the script will not try to
kill processes using an ejected device.
</DL>
<P>For example, here is a script for configuring a disk device at SCSI ID
3, with two partitions, and a CD-ROM at SCSI ID 6:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,sd,*,0,3,0)
    # This device has two partitions...
    PARTS="1 2"
    ;;
*,sd,*,0,3,0,1)
    # Options for partition 1:
    #  update /etc/fstab, and mount an ext2 fs on /usr1
    DO_FSTAB="y" ; DO_FSCK="y" ; DO_MOUNT="y"
    FSTYPE="ext2"
    OPTS=""
    MOUNTPT="/usr1"
    ;;
*,sd,*,0,3,0,2)
    # Options for partition 2:
    #  update /etc/fstab, and mount an MS-DOS fs on /usr2
    DO_FSTAB="y" ; DO_FSCK="y" ; DO_MOUNT="y"
    FSTYPE="msdos"
    OPTS=""
    MOUNTPT="/usr2"
    ;;
*,sr,*,0,6,0)
    # Options for CD-ROM at SCSI ID 6
    PARTS=""
    DO_FSTAB="y" ; DO_FSCK="n" ; DO_MOUNT="y"
    FSTYPE="iso9660"
    OPTS="ro"
    MOUNTPT="/cdrom"
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Comments about specific cards</H3>

<P>
<P>
<UL>
<LI>The Adaptec APA-1480 CardBus card needs a large IO port window (256
contiguous ports aligned on a 256-port boundary).  It may be necessary
to expand the IO port regions in <CODE>/etc/pcmcia/config.opts</CODE> to
guarantee that such a large window can be found.</LI>
<LI>The Adaptec APA-460 SlimSCSI adapter is not supported.  This card was
originally sold under the Trantor name, and when Adaptec merged with
Trantor, they continued to sell the Trantor card with an Adaptec
label.  The APA-460 is not compatible with any existing Linux driver.</LI>
<LI>I have had one report of a bad interaction between the New Media Bus
Toaster and a UMAX Astra 1200s scanner.  Due to the complexity of the
SCSI protocol, when diagnosing problems with SCSI devices, it is worth
considering that incompatible combinations like this may exist and may
not be documented.</LI>
</UL>
<P>
<H3>Diagnosing problems with SCSI adapters</H3>

<P>
<UL>
<LI>With the <CODE>aha152x_cs</CODE> driver (used by Adaptec, New Media, and
a few others), it seems that SCSI disconnect/reconnect support is a
frequent source of trouble with tape drives.  To disable this ``feature,''
add the following to <CODE>/etc/pcmcia/config.opts</CODE>:
<BLOCKQUOTE><CODE>
<PRE>
module "aha152x_cs" opts "reconnect=0"
</PRE>
</CODE></BLOCKQUOTE>
</LI>
<LI>Also with the <CODE>aha152x_cs</CODE> driver, certain devices seem to require
a longer startup delay, controlled via the <CODE>reset_delay</CODE> module
parameter.  The Yamaha 4416S CDR drive is one such device.  The result
is the device is identified successfully, then hangs the system.  In
such cases, try:
<BLOCKQUOTE><CODE>
<PRE>
module "aha152x_cs" opts "reset_delay=500"
</PRE>
</CODE></BLOCKQUOTE>
</LI>
<LI>Another potential source of SCSI device probe problems is probing of
multiple LUN's.  If you see successful detection of a device, followed
by SCSI bus timeouts when LUN 1 for that device is probed, then
disable the kernel's <CODE>CONFIG_SCSI_MULTI_LUN</CODE> option.</LI>
<LI>If you have compiled SCSI support as modules (<CODE>CONFIG_SCSI</CODE> is
``m''), you may need to modify <CODE>/etc/pcmcia/config</CODE> to load the
SCSI modules before the appropriate <CODE>*_cs</CODE> driver is loaded.</LI>
<LI>If you get ``aborting command due to timeout'' messages when the SCSI
bus is probed, you almost certainly have an interrupt conflict.</LI>
<LI>If the host driver reports ``no SCSI devices found'', verify that your
kernel was compiled with the appropriate top-level SCSI drivers for
your devices (i.e., disk, tape, CD-ROM, and/or generic).  If a
top-level driver is missing, devices of that type will be ignored.</LI>
</UL>
<P>
<H2><A NAME="ss4.7">4.7 PCMCIA memory cards</A>
</H2>

<P>The <CODE>memory_cs</CODE> driver handles all types of memory cards, as well
as providing direct access to the PCMCIA memory address space for
cards that have other functions.  When loaded, it creates a
combination of character and block devices.  See the man page for the
module for a complete description of the device naming scheme.  Block
devices are used for disk-like access (creating and mounting
filesystems, etc).  The character devices are for "raw" unbuffered
reads and writes at arbitrary locations.
<P>The device address passed to <CODE>memory.opts</CODE> consists of two fields:
the scheme, and the socket number.  The options are applied to the
first common memory partition on the corresponding memory card.
<P>Some flash memory cards, and most simple static RAM cards, lack a
``Card Information Structure'' (CIS), which is the system PCMCIA cards
use to identify themselves.  Normally, <CODE>cardmgr</CODE> will assume that
any card that lacks a CIS is a simple memory card, and load the
<CODE>memory_cs</CODE> driver.  Thus, a common side effect of a general card
identification problem is that other types of cards may be misdetected
as memory cards.
<P>There is another issue to consider when handling memory cards that do
not have CIS information.  At startup time, the PCMCIA package tries
to use the first detected card to determine what memory regions are
usable for PCMCIA.  The memory scan can be fooled if that card is a
simple memory card.  If you plan to use memory cards often, it is best
to limit the memory windows in <CODE>/etc/pcmcia/config.opts</CODE> to
known-good regions.
<P>The <CODE>memory_cs</CODE> driver uses a heuristic to guess the capacity of
these cards.  The heuristic does not work for write protected cards,
and may make mistakes in some other cases as well.  If a card is
misdetected, its size should then be explicitly specified when using
commands such as <CODE>dd</CODE> or <CODE>mkfs</CODE>.  The <CODE>memory_cs</CODE> module also
has a parameter for overriding the size detection.  See the man page.
<P>
<H3>Memory device parameters</H3>

<P>
<P>The following parameters can be specified in <CODE>memory.opts</CODE>:
<P>
<DL>
<DT><B><CODE>DO_FSTAB</CODE></B><DD><P>A boolean (y/n) setting: specifies if an entry should be added to
<CODE>/etc/fstab</CODE> for this device.
<DT><B><CODE>DO_FSCK</CODE></B><DD><P>A boolean (y/n) setting: specifies if the filesystem should be checked
before being mounted, with ``<CODE>fsck -Ta</CODE>''.
<DT><B><CODE>DO_MOUNT</CODE></B><DD><P>A boolean (y/n) setting: specifies if this device should be
automatically mounted at card insertion time.
<DT><B><CODE>FSTYPE</CODE>, <CODE>OPTS</CODE>, <CODE>MOUNTPT</CODE></B><DD><P>The filesystem type, mount options, and mount point to be used for the
fstab entry and/or mounting the device.
<DT><B><CODE>NO_CHECK</CODE>, <CODE>NO_FUSER</CODE></B><DD><P>Boolean (y/n) settings for card eject policy.  If <CODE>NO_CHECK</CODE> is
true, then ``<CODE>cardctl eject</CODE>'' will shut down a device even if it
is busy.  If <CODE>NO_FUSER</CODE> is true, then the script will not try to
kill processes using an ejected device.
</DL>
<P>Here is an example of a script that will automatically mount memory
cards based on which socket they are inserted into:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,0,0)
    # Mount filesystem, but don't update /etc/fstab
    DO_FSTAB="n" ; DO_FSCK="y" ; DO_MOUNT="y"
    FSTYPE="ext2" ; OPTS=""
    MOUNTPT="/mem0"
    ;;
*,1,0)
    # Mount filesystem, but don't update /etc/fstab
    DO_FSTAB="n" ; DO_FSCK="y" ; DO_MOUNT="y"
    FSTYPE="ext2" ; OPTS=""
    MOUNTPT="/mem1"
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Using linear flash memory cards</H3>

<P>The following information applies only to so-called ``linear flash''
memory cards.  Many flash cards, including all SmartMedia and
CompactFlash cards, actually include circuitry to emulate an IDE disk
device.  Those cards are thus handled as IDE devices, not memory
cards.
<P>There are two major formats for flash memory cards: the FTL
or ``flash translation layer'' style, and the Microsoft
Flash File System.  The FTL format is generally more
flexible because it allows any ordinary high-level filesystem (ext2,
ms-dos, etc) to be used on a flash card as if it were an ordinary disk
device.  The FFS is a completely different filesystem type.  Linux
cannot currently handle cards formated with FFS.
<P>To use a flash memory card as an ordinary disk-like block device,
first create an FTL partition on the device with the
<CODE>ftl_format</CODE> command.  This layer hides the
device-specific details of flash memory programming and make the card
look like a simple block device.  For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
ftl_format -i /dev/mem0c0c
</PRE>
</CODE></BLOCKQUOTE>
<P>Note that this command accesses the card through the ``raw'' memory
card interface.  Once formatted, the card can be accessed as an
ordinary block device via the <CODE>ftl_cs</CODE> driver.  For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
mke2fs /dev/ftl0c0
mount -t ext2 /dev/ftl0c0 /mnt
</PRE>
</CODE></BLOCKQUOTE>
<P>Device naming for FTL devices is tricky.  Minor device numbers have
three parts: the card number, the region number on that card, and
optionally, the partition within that region.  A region can either be
treated as a single block device with no partition table (like a
floppy), or it can be partitioned like a hard disk device.  The
``ftl0c0'' device is card 0, common memory region 0, the entire
region.  The ``ftl0c0p1'' through ``ftl0c0p4'' devices are primary
partitions 1 through 4 if the region has been partitioned.
<P>Configuration options for FTL partitions can be given in
<CODE>ftl.opts</CODE>, which is similar in structure to <CODE>memory.opts</CODE>.
The device address passed to <CODE>ftl.opts</CODE> consists of three or four
fields: the scheme, the socket number, the region number, and
optionally, the partition number.  Most flash cards have just one
flash memory region, so the region number will generally always be
zero.
<P>Intel Series 100 flash cards use the first 128K flash block to store
the cards' configuration information.  To prevent accidental erasure
of this information, <CODE>ftl_format</CODE> will automatically detect this
and skip the first block when creating an FTL partition.
<P>
<H2><A NAME="ss4.8">4.8 PCMCIA ATA/IDE card drives</A>
</H2>

<P>ATA/IDE drive support is based on the regular kernel IDE driver.  This
includes SmartMedia and CompactFlash devices: these flash memory cards
are set up so that they emulate an IDE interface.  The PCMCIA-specific
part of the driver is <CODE>ide_cs</CODE>.  Be sure to use <CODE>cardctl</CODE> or
<CODE>cardinfo</CODE> to shut down an ATA/IDE card before ejecting it, as the
driver has not been made ``hot-swap-proof''.
<P>The device addresses passed to <CODE>ide.opts</CODE> consist of either three
or four fields: the current scheme, the socket number, the drive's
serial number, and an optional partition number.  The <CODE>ide_info</CODE>
command can be used to obtain an IDE device's serial number.  As with
SCSI devices, <CODE>ide.opts</CODE> is first called for the entire device.  If
<CODE>ide.opts</CODE> returns a list of partitions in the <CODE>PARTS</CODE>
variable, the script will then be called for each partition.
<P>
<H3>ATA/IDE fixed-disk device parameters</H3>

<P>
<P>The following parameters can be specified in <CODE>ide.opts</CODE>:
<P>
<DL>
<DT><B><CODE>DO_FSTAB</CODE></B><DD><P>A boolean (y/n) setting: specifies if an entry should be added to
<CODE>/etc/fstab</CODE> for this device.
<DT><B><CODE>DO_FSCK</CODE></B><DD><P>A boolean (y/n) setting: specifies if the filesystem should be checked
before being mounted, with ``<CODE>fsck -Ta</CODE>''.
<DT><B><CODE>DO_MOUNT</CODE></B><DD><P>A boolean (y/n) setting: specifies if this device should be
automatically mounted at card insertion time.
<DT><B><CODE>FSTYPE</CODE>, <CODE>OPTS</CODE>, <CODE>MOUNTPT</CODE></B><DD><P>The filesystem type, mount options, and mount point to be used for the
fstab entry and/or mounting the device.
<DT><B><CODE>NO_CHECK</CODE>, <CODE>NO_FUSER</CODE></B><DD><P>Boolean (y/n) settings for card eject policy.  If <CODE>NO_CHECK</CODE> is
true, then ``<CODE>cardctl eject</CODE>'' will shut down a device even if it
is busy.  If <CODE>NO_FUSER</CODE> is true, then the script will not try to
kill processes using an ejected device.
</DL>
<P>Here is an example <CODE>ide.opts</CODE> file to mount the first partition
of any ATA/IDE card on <CODE>/mnt</CODE>.
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
*,*,*,1)
    DO_FSTAB="y" ; DO_FSCK="y" ; DO_MOUNT="y"
    FSTYPE="msdos"
    OPTS=""
    MOUNTPT="/mnt"
    ;;
*,*,*)
    PARTS="1"
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Diagnosing problems with ATA/IDE adapters</H3>

<P>
<UL>
<LI>An IO port conflict may cause the IDE driver to misdetect the drive
geometry and report ``<CODE>INVALID GEOMETRY: 0 PHYSICAL HEADS?</CODE>''.  To
fix, try excluding the selected IO port range in
<CODE>/etc/pcmcia/config.opts</CODE>.</LI>
<LI>Some IDE drives violate the PCMCIA specification by requiring more
time to spin up than the maximum allowed card setup time.  This may
result in ``timed out during reset'' messages at card detect time.
Adjust the <CODE>unreset_delay</CODE> and/or <CODE>unreset_limit</CODE> parameters for
the <CODE>pcmcia_core</CODE> module to give a drive more time to spin up; see
the <CODE>pcmcia_core</CODE> man page for parameter details.  For example:
<BLOCKQUOTE><CODE>
<PRE>
CORE_OPTS="unreset_delay=400"
</PRE>
</CODE></BLOCKQUOTE>
</LI>
<LI>To use an ATA/IDE CD-ROM device, your kernel must be compiled with
<CODE>CONFIG_BLK_DEV_IDECD</CODE> enabled.  This will normally be the case for
standard kernels, however it is something to be aware of if you
compile a custom kernel.</LI>
<LI>A common error when using IDE drives is try to mount the wrong device
file.  Generally, you want to mount a partition of the device, not the
entire device (i.e., <CODE>/dev/hde1</CODE>, not <CODE>/dev/hde</CODE>).</LI>
<LI>The Linux IDE driver may have trouble configuring certain
removable-media drives if no media is present at insertion time.  The
IBM Portable DriveBay has this problem.</LI>
<LI>Some kernels will report a pair of ``drive_cmd'' errors at insertion
time.  These errors can be ignored: they pop up when a removable IDE
device does not accept the IDE ``door lock'' command.</LI>
</UL>
<P>
<H2><A NAME="ss4.9">4.9 Multifunction cards</A>
</H2>

<P>A single interrupt can be shared by several drivers, such as the
serial driver and an ethernet driver: in fact, the PCMCIA
specification requires all card functions to share the same interrupt.
Normally, all card functions are available without having to swap
drivers.  All Linux kernels support this kind of interrupt sharing.
<P>Simultaneous use of two card functions is ``tricky'' and various
hardware vendors have implemented interrupt sharing in their own
incompatible (and sometimes proprietary) ways.  The drivers for some
cards (Ositech Jack of Diamonds, 3Com 3c562 and related cards, Linksys
cards) properly support simultaneous access, but others (older
Megahertz cards in particular) do not.  If you have trouble using a
card with both functions active, try using each function in isolation.
That may require explicitly doing an ``<CODE>ifconfig down</CODE>'' to shut
down a network interface and use a modem on the same card.
<P>
<HR>
<H2><A NAME="s5">5.</A> <A HREF="#toc5">Advanced topics</A></H2>

<P>
<P>
<H2><A NAME="ss5.1">5.1 Resource allocation for PCMCIA devices</A>
</H2>

<P>In theory, it should not really matter which interrupt is allocated to
which device, as long as two devices are not configured to use the
same interrupt.  In <CODE>/etc/pcmcia/config.opts</CODE> you'll find
a place for excluding interrupts that are used by non-PCMCIA devices.
<P>Similarly, there is no way to directly specify the I/O addresses for a
card to use.  The <CODE>/etc/pcmcia/config.opts</CODE> file allows
you to specify ranges of ports available for use by any card, or to
exclude ranges that conflict with other devices. 
<P>After modifying <CODE>/etc/pcmcia/config.opts</CODE>, you can reinitialize
<CODE>cardmgr</CODE> with ``<CODE>kill -HUP</CODE>''.
<P>The interrupt used to monitor card status changes is chosen
by the low-level socket driver module (<CODE>i82365</CODE> or <CODE>tcic</CODE>)
before <CODE>cardmgr</CODE> parses <CODE>/etc/pcmcia/config</CODE>, so it is not
affected by changes to this file.  To set this interrupt, use the
<CODE>cs_irq=</CODE> option when the socket driver is loaded, by setting
the <CODE>PCIC_OPTS</CODE> variable in <CODE>/etc/rc.d/rc.pcmcia</CODE>.
<P>All the client card drivers have a parameter called <CODE>irq_list</CODE> for
specifying which interrupts they may try to allocate.
These driver options should be set in
your <CODE>/etc/pcmcia/config</CODE> file.  For example:
<P>
<BLOCKQUOTE><CODE>
<PRE>
device "serial_cs"
  module "serial_cs" opts "irq_list=8,12"
  ...
</PRE>
</CODE></BLOCKQUOTE>
<P>would specify that the serial driver should only use irq 8 or irq 12.
Regardless of <CODE>irq_list</CODE> settings, Card Services will never
allocate an interrupt that is already in use by another device, or an
interrupt that is excluded in the config file.
<P>
<H2><A NAME="ss5.2">5.2 PCI interrupt configuration problems and solutions</A>
</H2>

<P>
<P>Most of the following discussion applies to 2.2 and earlier kernels.
With 2.4 and later kernels, the PCI subsystem has more complete
responsibility for PCI interrupt management.  The following tips may
help diagnose a problem, though some workarounds described here may
not be available.
<P>
<H3>An overview of PCI interrupt routing issues</H3>

<P>Each PCI slot has four PCI interrupt pins, INTA through INTD.  Single
function devices will only use the INTA pin; multifunction devices may
use multiple INT pins.  On the processor side, on x86 single processor
systems, incoming hardware interrupts are directed to interrupt
requests (irq's) numbered 0..15.  The PCI interrupt router, usually
part of the PCI-to-ISA host bridge, determines how incoming PCI
interrupts are mapped to CPU irq numbers.  Most modern bridge chips
have several PCI interrupt inputs, known as PIRQ1, PIRQ2, etc, each of
which can be routed to any CPU irq number.  So we might have something
like:
<P>
<BLOCKQUOTE><CODE>
<PRE>
PCI slot 1 INTA --> router PIRQ1 --> CPU irq 9
PCI slot 1 INTB --> router PIRQ2 --> CPU irq 10

PCI slot 2 INTA --> router PIRQ2 --> CPU irq 10
PCI slot 2 INTB --> router PIRQ1 --> CPU irq 9
</PRE>
</CODE></BLOCKQUOTE>
<P>Multiple INT pins are often connected to the same PIRQ pin.  Usually,
the connections from INT pins to PIRQ pins are arranged to spread
installed devices out as much as possible, to give the OS the most
flexibility for choosing how interrupts are shared.  The mapping from
bridge PIRQ pins to CPU irq numbers can be obtained by reading
registers in the interrupt router.  The mapping from INT pins to the
router's PIRQ pins, however, depends on how the board designer decided
to connect things up, and cannot be directly determined by driver
software.
<P>For most PCI devices, the OS does not need to understand the interrupt
router details.  Each PCI device has a configuration register, the PCI
Interrupt Line Register, that the BIOS initializes with the
appropriate CPU irq number for that device.  Unfortunately, the BIOS
generally will not configure PCI interrupts for CardBus bridge devices.
<P>The PCI BIOS's Interrupt Routing Table is a data structure that
contains information about the mapping from PCI INT pins to the PIRQ
pins on the PCI interrupt router.  The routing information in the
table is stored in a somewhat unhelpful form, however.  For each
device's INT pins, the table specifies a ``link value''.  All
interrupts with the same link value are wired to the same PIRQ pin;
however, the meaning of the link values is defined by the chipset
vendor.
<P>Several tools are available for examining PCI interrupt routing
information:
<P>
<DL>
<P>
<DT><B><CODE>lspci</CODE>, <CODE>/proc/pci</CODE></B><DD><P>These will show you resource information (including interrupt
assignments, where they are known) for all your PCI devices.
<P>
<DT><B><CODE>dump_pirq</CODE></B><DD><P>This is in the <CODE>debug-tools</CODE> directory of the PCMCIA source
distribution.  It dumps the contents of your PCI interrupt routing
table, if available.  It also scans for known interrupt routers and
dumps their current interrupt steering settings.
<P>
</DL>
<P>Several PCMCIA module parameters affect PCI interrupt routing:
<P>
<DL>
<P>
<DT><B><CODE>pcmcia_core</CODE> module: <CODE>cb_pci_irq=n</CODE></B><DD><P>This option specifies one interrupt number to be used to program the
PCI interrupt router for all CardBus sockets that do not already have
an interrupt assignment. It only has any effect on systems that have a
PCI irq routing table, and a known interrupt router.
<P>
<DT><B><CODE>i82365</CODE> module: <CODE>irq_mode=n</CODE></B><DD><P>Most CardBus bridges offer several methods for delivering interrupts
to the host.  The i82365 module by default assumes that a bridge can
deliver both PCI and ISA interrupts, since this is normal for laptops.
A setting of ``<CODE>irq_mode=0</CODE>'' can be used to force a bridge to use only
PCI interrupts.  See the man page for the <CODE>i82365</CODE> module for a
description of what other values mean for different bridge types.
<P>
<DT><B><CODE>i82365</CODE> module: <CODE>irq_list=n,n,...</CODE></B><DD><P>This parameter lists which ISA interrupt(s) can be used for PCMCIA.
If no ISA interrupts are available, specify ``<CODE>irq_list=0</CODE>''.  Note
that ``<CODE>irq_mode=0</CODE>'' implies ``<CODE>irq_list=0</CODE>''.
<P>
<DT><B><CODE>i82365</CODE> module: <CODE>pci_irq_list=n,n,...</CODE></B><DD><P>This option specifies a list of PCI interrupt numbers to use for
CardBus sockets.  It differs from <CODE>cb_pci_irq</CODE>, because it does not
actually program the PCI interrupt router; it can be used when you
know the PCI interrupts are already set up a certain way, even if you
do not know how the router works.
<P>
</DL>
<P>If you are having problems that you think may be related to PCI
interrupt configuration, you should first verify that you have a
reasonably current PCMCIA driver package.  Also carefully look at the
startup messages when the PCMCIA kernel modules are loaded.  You
should see something like:
<P>
<BLOCKQUOTE><CODE>
<PRE>
Linux PCMCIA Card Services 3.1.18
  kernel build: 2.2.14-5.0 #1 Tue May 9 10:44:24 PDT 2000 
  options:  [pci] [cardbus] [apm] [pnp]
PCI routing table version 1.0 at 0xfdf30
Intel PCIC probe:
  TI 1125 rev 02 PCI-to-CardBus at slot 00:07, mem 0x20000000
    host opts [0]: [ring] [serial pci &amp; irq] [pci irq 11] ...
    host opts [0]: [ring] [serial pci &amp; irq] [pci irq 11] ...
  ISA irqs (scanned) = 3,4,7 PCI status changes
</PRE>
</CODE></BLOCKQUOTE>
<P>The ``<CODE>PCI routing table</CODE>'' message indicates that a valid routing
table was found.  The ``<CODE>host opts</CODE>'' lines indicate the interrupt
delivery mode and whether or not a PCI interrupt could be determined
for each socket.  And the final line indicates the results of the scan
for available interrupts.
<P>
<H3>CardBus bridge is not detected by the PCI BIOS</H3>

<P>
<P>Symptoms:
<UL>
<LI>Intel PCIC probe: not found.</LI>
<LI>The bridge does not show up in <CODE>lspci</CODE> or in <CODE>/proc/pci</CODE>.</LI>
</UL>
<P>The Lucent/SCM PCI-to-CardBus adapters seem to confuse the PCI BIOS on
some older systems.  Lucent says that this card is only supported
on systems that have a BIOS that supports the PCI 2.2 specification,
or are PC99 compliant.  Some older systems will not detect the Lucent
card at all, and if the system can't detect it, the Linux drivers
cannot use it.  The only possible resolutions are a BIOS upgrade, or
using a different motherboard or CardBus adapter.
<P>
<H3><A NAME="irqmode"></A> PCI interrupt delivery problems </H3>

<P>
<P>Symptoms:
<UL>
<LI>Cards seem to be configured correctly, but do not work.</LI>
<LI><CODE>/proc/interrupts</CODE> shows a count of 0 for interrupts
assigned to PCMCIA drivers.</LI>
</UL>
<P>CardBus bridges usually support two types of interrupts, PCI and ISA.
Partly for historical reasons, it has become conventional to use PCI
interrupts for signaling card insertion and removal events, and for
CardBus card interrupts; and ISA interrupts for 16-bit cards.  Since
version 3.1.9, this is the scheme that the Linux PCMCIA system will
use by default.  Most CardBus bridges support multiple methods for
delivering interrupts to the host CPU.  Methods include ``parallel''
interrupts, where each supported irq has a dedicated pin on the
bridge; various serial interrupt protocols, where one or two pins are
used to communicate with an interrupt controller; and hybrids, where
PCI interrupts might be signalled using dedicated pins, while ISA
interrupts are delivered via a serial controller.
<P>In general, it is the responsibility of the BIOS to program a bridge
for the appropriate interrupt delivery method.  However, there are
systems that do this incorrectly, and in some cases, there is no way
for software to safely detect the correct delivery method.  The
<CODE>i82365</CODE> module reports the bridge mode at startup time, and has a
parameter, <CODE>irq_mode</CODE>, that can be used to reconfigure it.  Not all
bridges support this parameter, and the meaning of <CODE>irq_mode</CODE>
depends on the bridge type.  See the <CODE>i82365</CODE> man page for a
description of what values are supported by your bridge.  In some
cases, a bridge may function correctly in more than one interrupt
mode.
<P>Most PCMCIA card readers that fit in a PCI bus slot only provide PCI
interrupt routing.  The Linux drivers assume that all bridges have ISA
interrupt capability, since that is generally correct on laptops.
With a card reader, it will generally be necessary to use the
<CODE>irq_mode</CODE> parameter to specify a ``PCI only'' interrupt delivery
mode; the value of the parameter depends on the bridge type, so check
the <CODE>i82365</CODE> man page.  A few PCI card readers require an
<CODE>irq_mode</CODE> that permits ISA interrupts, but those interrupts are
not actually connected; in that case, use ``<CODE>irq_list=0</CODE>''.
<P>Check the system log and verify that the CardBus bridge has a PCI
interrupt assignment.  If it does not, then resolve that problem
first, then return here if the symptoms persist.  Next, experiment
with different values for the <CODE>irq_mode</CODE> parameter.
<P>
<H3>No PCI interrupt assignment; valid routing table</H3>

<P>
<P>Symptoms:
<UL>
<LI>The Intel PCIC probe reports ``no pci irq'' for each socket.</LI>
<LI>There is a routing table, and the router type is supported.</LI>
</UL>
<P>When a routing table is present, the <CODE>pcmcia_core</CODE> module will try
to automatically configure the PCI interrupt router, but only does so
when it has a safe and unambiguous choice for what PCI interrupt to
use.  If there are several valid choices, then you must use the
``<CODE>cb_pci_irq=...</CODE>'' option to specify which interrupt to assign.
Your best bet is to pick the most lightly used interrupt that is
already assigned to another PCI device.
<P>Moving the card to another slot sometimes offers a quick solution.  If
that slot shares its interrupt with an already-configured device, then
the PCMCIA drivers will have no trouble figuring out the assignment.
<P>
<H3>No PCI interrupt assignment; unknown interrupt router</H3>

<P>
<P>Symptoms:
<UL>
<LI>The Intel PCIC probe reports ``no pci irq'' for each socket.</LI>
<LI>There is a routing table, but the router is an unknown type.</LI>
</UL>
<P>Adding support for a new interrupt router is tricky but not a big
job.  First determine, from a datasheet, how your interrupt router
steers PCI interrupts.  Then, see if you can guess the meaning of the
link values from the output of <CODE>dump_pirq</CODE>.  Usually this is
reasonably obvious.  Most routers have four PIRQ pins, and the link
values might be something like 1,2,3,4, or 0x10,0x18,0x20,0x28, or
0x60,0x61,0x62,0x63.  The values are usually chosen so that they can
be easily converted to the location of the appropriate interrupt
steering register.  Finally, add small functions to
<CODE>modules/pci_fixup.c</CODE> to get/set the interrupt steering
information for this router, using the other routers as examples.
<P>
<H3>No PCI interrupt assignment; no routing table</H3>

<P>
<P>Symptoms:
<UL>
<LI>The Intel PCIC probe reports ``no pci irq'' for each socket.</LI>
<LI>No interrupt routing table is found.</LI>
</UL>
<P>Without an interrupt routing table, we cannot tell how interrupts from
the CardBus bridge are directed to CPU irq numbers.  All hope is not
lost: you may be able to guess the PCI interrupt assignment and use
the ``<CODE>pci_irq_list=...</CODE>'' option to pass this information to the
<CODE>i82365</CODE> module.  Good guesses might include the interrupt(s)
assigned to other PCI devices, the interrupt(s) used under Windows, or
any other interrupts that are unaccounted for.
<P>You may also want to experiment with putting the adapter in different
PCI slots, for each <CODE>pci_irq_list</CODE> you try.  You are trying to find
a slot that shares its interrupt with an already-configured device,
and might need to try several slots to find one.
<P>
<H2><A NAME="ss5.3">5.3 How can I have separate device setups for home and work?</A>
</H2>

<P>This is fairly easy using ``scheme'' support.
Use two configuration schemes, called ``home'' and ``work''.  Here is
an example of a <CODE>network.opts</CODE> script with scheme-specific
settings:
<P>
<BLOCKQUOTE><CODE>
<PRE>
case "$ADDRESS" in
work,*,*,*)
    # definitions for network card in work scheme
    ...
    ;;
home,*,*,*|default,*,*,*)
    # definitions for network card in home scheme
    ...
    ;;
esac
</PRE>
</CODE></BLOCKQUOTE>
<P>The first part of a device address is always the configuration
scheme.  In this example, the second ``case'' clause will select for
both the ``home'' and ``default'' schemes.  So, if the scheme is unset
for any reason, it will default to the ``home'' setup.
<P>Now, to select between the two sets of settings, run either:
<P>
<BLOCKQUOTE><CODE>
<PRE>
cardctl scheme home
</PRE>
</CODE></BLOCKQUOTE>
<P>or
<P>
<BLOCKQUOTE><CODE>
<PRE>
cardctl scheme work
</PRE>
</CODE></BLOCKQUOTE>
<P>The <CODE>cardctl</CODE> command does the equivalent of shutting down all your
cards and restarting them.  The command can be safely executed whether
or not the PCMCIA system is loaded, but the command may fail if you
are using other PCMCIA devices at the time (even if their
configurations are not explicitly dependant on the scheme setting).
<P>To find out the current scheme setting, run:
<P>
<BLOCKQUOTE><CODE>
<PRE>
cardctl scheme
</PRE>
</CODE></BLOCKQUOTE>
<P>By default, the scheme setting is persistent across boots.  This can
have undesirable effects if networking is initialized for the wrong
environment.  Optionally, you can set the initial scheme value with
the <CODE>SCHEME</CODE> startup option (see 
<A HREF="#startup">Startup options</A> for details).  It is also possible to set the scheme from
the <CODE>lilo</CODE> boot prompt.  Since <CODE>lilo</CODE> passes unrecognized
options to <CODE>init</CODE> as environment variables, a value for <CODE>SCHEME</CODE>
(or any other PCMCIA startup option) at the boot prompt will be
propagated into the PCMCIA startup script.
<P>To save even more keystrokes, schemes can be specified in <CODE>lilo</CODE>'s
configuration file.  For instance, you could have:
<P>
<BLOCKQUOTE><CODE>
<PRE>
root = /dev/hda1
read-only
image = /boot/vmlinuz
  label  = home
  append = "SCHEME=home"
image = /boot/vmlinuz
  label  = work
  append = "SCHEME=work"
</PRE>
</CODE></BLOCKQUOTE>
<P>Typing ``home'' or ``work'' at the boot prompt would then boot into
the appropriate scheme.
<P>
<H2><A NAME="ss5.4">5.4 Booting from a PCMCIA device</A>
</H2>

<P>
<P>Having the root filesystem on a PCMCIA device is tricky because the
Linux PCMCIA system is not designed to be linked into the kernel.  Its
core components, the loadable kernel modules and the user mode cardmgr
daemon, depend on an already running system.  The kernel's
``initrd'' facility works around this requirement by
allowing Linux to boot using a temporary ram disk as a minimal root
image, load drivers, and then re-mount a different root filesystem.
The temporary root can configure PCMCIA devices and then re-mount a
PCMCIA device as root.
<P>The initrd image absolutely must reside on a bootable device: this
generally cannot be put on a PCMCIA device.  This is a BIOS
limitation, not a kernel limitation.  It is useful here to distinguish
between ``boot-able'' devices (i.e., devices that can be booted), and
``root-able'' devices (i.e., devices that can be mounted as root).
``Boot-able'' devices are determined by the BIOS, and are generally
limited to internal floppy and hard disk drives.  ``Root-able''
devices are any block devices that the kernel supports once it has
been loaded.  The initrd facility makes more devices ``root-able'',
not ``boot-able''. 
<P>Some Linux distributions will allow installation to a device connected
to a PCMCIA SCSI adapter, as an unintended side-effect of their
support for installs from PCMCIA SCSI CD-ROM devices.  However, at
present, no Linux installation tools support configuring an
appropriate ``initrd'' to boot Linux with a PCMCIA root filesystem.
Setting up a system with a PCMCIA root thus requires that you use
another Linux system to create the ``initrd'' image.  If another Linux
system is not available, another option would be to temporarily
install a minimal Linux setup on a non-PCMCIA drive, create an initrd
image, and then reinstall to the PCMCIA target.
<P>The Linux Bootdisk-HOWTO has some general information about setting up
boot disks but nothing specific to initrd.  The main initrd document
is included with recent kernel source code distributions, in
<CODE>linux/Documentation/initrd.txt</CODE>.  Before beginning, you should
read this document.  A familiarity with <CODE>lilo</CODE> is also helpful.
Using initrd also requires that you have a kernel compiled with
<CODE>CONFIG_BLK_DEV_RAM</CODE> and <CODE>CONFIG_BLK_DEV_INITRD</CODE> enabled.
<P>This is an advanced configuration technique, and requires a high level
of familiarity with Linux and the PCMCIA system.  Be sure to read all
the relevant documentation before starting.  The following cookbook
instructions should work, but deviations from the examples will
quickly put you in uncharted and ``unsupported'' territory, and you
will be on your own. 
<P>This method absolutely requires that you use a PCMCIA driver release
of 2.9.5 or later.  Older PCMCIA packages or individual components
will not work in the initrd context.  Do not mix components from
different releases.
<P>
<H3>The pcinitrd helper script</H3>

<P>The <CODE>pcinitrd</CODE> script creates a basic initrd image for booting with
a PCMCIA root partition.  The image includes a minimal directory
heirarchy, a handful of device files, a few binaries, shared
libraries, and a set of PCMCIA driver modules.  When invoking
<CODE>pcinitrd</CODE>, you specify the driver modules that you want to be
included in the image.  The core PCMCIA components, <CODE>pcmcia_core</CODE>
and <CODE>ds</CODE>, are automatically included.
<P>As an example, say that your laptop uses an i82365-compatible
host controller, and you want to boot Linux with the root filesystem
on a hard drive attached to an Adaptec SlimSCSI adapter.  You could
create an appropriate initrd image with:
<P>
<BLOCKQUOTE><CODE>
<PRE>
pcinitrd -v initrd pcmcia/i82365.o pcmcia/aha152x_cs.o
</PRE>
</CODE></BLOCKQUOTE>
<P>To customize the initrd startup sequence, you could mount the image
using the ``loopback'' device with a command like:
<P>
<BLOCKQUOTE><CODE>
<PRE>
mount -o loop -t ext2 initrd /mnt
</PRE>
</CODE></BLOCKQUOTE>
<P>and then edit the <CODE>linuxrc</CODE> script.  The configuration files
will be installed under <CODE>/etc</CODE> in the image, and can also be
customized.  See the man page for <CODE>pcinitrd</CODE> for more information.
<P>
<H3>Creating an initrd boot floppy</H3>

<P>
<P>After creating an image with <CODE>pcinitrd</CODE>, you can create a boot
floppy by copying the kernel, the compressed initrd image, and a few
support files for <CODE>lilo</CODE> to a clean floppy.  In the following
example, we assume that the desired PCMCIA root device is
<CODE>/dev/sda1</CODE>:
<P>
<BLOCKQUOTE><CODE>
<PRE>
mke2fs /dev/fd0
mount /dev/fd0 /mnt
mkdir /mnt/etc /mnt/boot /mnt/dev
cp -a /dev/fd0 /dev/sda1 /mnt/dev
cp [kernel-image] /mnt/vmlinuz
cp /boot/boot.b /mnt/boot/boot.b
gzip &lt; [initrd-image] > /mnt/initrd
</PRE>
</CODE></BLOCKQUOTE>
<P>Create <CODE>/mnt/etc/lilo.conf</CODE> with the contents:
<P>
<BLOCKQUOTE><CODE>
<PRE>
boot=/dev/fd0
compact
image=/vmlinuz
    label=linux
    initrd=/initrd
    read-only
    root=/dev/sda1
</PRE>
</CODE></BLOCKQUOTE>
<P>Finally, invoke lilo with:
<P>
<BLOCKQUOTE><CODE>
<PRE>
lilo -r /mnt
</PRE>
</CODE></BLOCKQUOTE>
<P>When <CODE>lilo</CODE> is invoked with <CODE>-r</CODE>, it performs all actions
relative to the specified alternate root directory.  The reason for
creating the device files under <CODE>/mnt/dev</CODE> was that <CODE>lilo</CODE>
will not be able to use the files in <CODE>/dev</CODE> when it is running
in this alternate-root mode.
<P>
<H3>Installing an initrd image on a non-Linux drive</H3>

<P>One common use of the initrd facility would be on systems where the
internal hard drive is dedicated to another operating system.  The
Linux kernel and initrd image can be placed in a non-Linux partition,
and <CODE>lilo</CODE> or <CODE>LOADLIN</CODE> can be set up to boot Linux from these
images.
<P>Assuming that you have a kernel has been configured for the
appropriate root device, and an initrd image created on another
system, the easiest way to get started is to boot Linux using
<CODE>LOADLIN</CODE>, as:
<P>
<BLOCKQUOTE><CODE>
<PRE>
LOADLIN &lt;kernel> initrd=&lt;initrd-image>
</PRE>
</CODE></BLOCKQUOTE>
<P>Once you can boot Linux on your target machine, you could then
install <CODE>lilo</CODE> to allow booting Linux directly.
For example, say that <CODE>/dev/hda1</CODE> is the non-Linux target
partition and <CODE>/mnt</CODE> can be used as a mount point.  First,
create a subdirectory on the target for the Linux files:
<P>
<BLOCKQUOTE><CODE>
<PRE>
mount /dev/hda1 /mnt
mkdir /mnt/linux
cp [kernel-image] /mnt/linux/vmlinuz
cp [initrd-image] /mnt/linux/initrd
</PRE>
</CODE></BLOCKQUOTE>
<P>In this example, say that <CODE>/dev/sda1</CODE> is the desired Linux root
partition, a SCSI hard drive mounted via a PCMCIA SCSI adapter.  To
install <CODE>lilo</CODE>, create a <CODE>lilo.conf</CODE> file with the contents:
<P>
<BLOCKQUOTE><CODE>
<PRE>
boot=/dev/hda
map=/mnt/linux/map
compact
image=/mnt/linux/vmlinuz
        label=linux
        root=/dev/sda1
        initrd=/mnt/linux/initrd
        read-only
other=/dev/hda1
        table=/dev/hda
        label=windows
</PRE>
</CODE></BLOCKQUOTE>
<P>The <CODE>boot=</CODE> line says to install the boot loader in the master boot
record of the specified device.  The <CODE>root=</CODE> line identifies the
desired root filesystem to be used after loading the initrd image, and
may be unnecessary if the kernel image is already configured this way.
The <CODE>other=</CODE> section is used to describe the other operating system
installed on <CODE>/dev/hda1</CODE>.
<P>To install <CODE>lilo</CODE> in this case, use:
<P>
<BLOCKQUOTE><CODE>
<PRE>
lilo -C lilo.conf
</PRE>
</CODE></BLOCKQUOTE>
<P>Note that in this case, the <CODE>lilo.conf</CODE> file uses absolute paths
that include <CODE>/mnt</CODE>.  I did this in the example because the target
filesystem may not support the creation of Linux device files for the
<CODE>boot=</CODE> and <CODE>root=</CODE> options.
<P>
<HR>
<H2><A NAME="s6">6.</A> <A HREF="#toc6">Dealing with unsupported cards</A></H2>

<P>
<P>
<H2><A NAME="new-card"></A> <A NAME="ss6.1">6.1 Configuring unrecognized cards</A>
 </H2>

<P>
<P>Assuming that your card is supported by an existing driver, all
that needs to be done is to add an entry to
<CODE>/etc/pcmcia/config</CODE> to tell <CODE>cardmgr</CODE> how to identify the card,
and which driver(s) need to be linked up to this card.  Check the man
page for <CODE>pcmcia</CODE> for more information about the config file format.
If you insert an unknown card, <CODE>cardmgr</CODE> will normally record some
identification information in the system log that can be
used to construct the config entry.  This information can also be
displayed with the ``<CODE>cardctl ident</CODE>'' command.
<P>Here is an example of how cardmgr will report an unsupported card in
the system log:
<P>
<BLOCKQUOTE><CODE>
<PRE>
cardmgr[460]: unsupported card in socket 1
cardmgr[460]: product info: "MEGAHERTZ", "XJ2288", "V.34 PCMCIA MODEM"
cardmgr[460]: manfid: 0x0101, 0x1234  function: 2 (serial)
</PRE>
</CODE></BLOCKQUOTE>
<P>The corresponding entry in <CODE>/etc/pcmcia/config</CODE> would be:
<P>
<BLOCKQUOTE><CODE>
<PRE>
card "Megahertz XJ2288 V.34 Fax Modem"
  version "MEGAHERTZ", "XJ2288", "V.34 PCMCIA MODEM"
  bind "serial_cs"
</PRE>
</CODE></BLOCKQUOTE>
<P>or using the more compact product ID codes:
<P>
<BLOCKQUOTE><CODE>
<PRE>
card "Megahertz XJ2288 V.34 Fax Modem"
  manfid 0x0101, 0x1234
  bind "serial_cs"
</PRE>
</CODE></BLOCKQUOTE>
<P>You can use ``*'' to match strings that don't need to match exactly,
like version numbers.  When making new config entries, be careful
to copy the strings exactly, preserving case and blank spaces.
Also be sure that the config entry has the same number of strings as
are reported in the log file.
<P>Beware that you can specify just about any driver for a card, but if
you're just shooting in the dark, there is not much reason to expect
this to be productive.  You may get lucky and find that your card is
supported by an existing driver.  However, the most likely outcome is
that the driver won't work, and may have unfortunate side effects
like locking up your system.  Unlike most ordinary device drivers,
which probe for an appropriate card, the probe for a PCMCIA device is
done by <CODE>cardmgr</CODE>, and the driver itself may not do much validation
before attempting to communicate with the device.
<P>After editing <CODE>/etc/pcmcia/config</CODE>, you can signal <CODE>cardmgr</CODE>
to reload the file with:
<P>
<BLOCKQUOTE><CODE>
<PRE>
kill -HUP `cat /var/run/cardmgr.pid`
</PRE>
</CODE></BLOCKQUOTE>
<P>If you do set up an entry for a new card, please send me a copy so
that I can include it in the standard config file.
<P>
<H2><A NAME="ss6.2">6.2 Adding support for an NE2000-compatible ethernet card</A>
</H2>

<P>Before you begin: this procedure will only work for simple 16-bit
ethernet cards.  Multifunction cards (i.e., ethernet/modem combo
cards) have an extra layer of complexity regarding how the two
functions are integrated, and generally cannot be supported without
obtaining some configuration information from the card vendor.  Using
the following procedure for a multifunction card will not be
productive.
<P>First, see if the card is already recognized by <CODE>cardmgr</CODE>.  Some
cards not listed in <CODE>SUPPORTED.CARDS</CODE> are actually OEM versions of
cards that are supported.  If you find a card like this, let me know
so I can add it to the list.
<P>If your card is not recognized, follow the instructions in the
<A HREF="#new-card">Configuring unrecognized cards</A> section to
create a config entry for your card, 
and bind the card to the <CODE>pcnet_cs</CODE> driver.  Restart <CODE>cardmgr</CODE>
to use the updated config file.
<P>If the <CODE>pcnet_cs</CODE> driver says that it is unable to determine your
card's hardware ethernet address, then edit your new config entry to
bind the card to the memory card driver, <CODE>memory_cs</CODE>.
Restart <CODE>cardmgr</CODE> to use the new updated config file.
You will need to know your card's hardware ethernet address.  This
address is a series of six two-digit hex numbers, often printed on the
card itself.  If it is not printed on the card, you may be able to use
a DOS driver to display the address.  In any case, once you know it,
run:
<P>
<BLOCKQUOTE><CODE>
<PRE>
dd if=/dev/mem0a count=20 | od -Ax -t x1
</PRE>
</CODE></BLOCKQUOTE>
<P>and search the output for your address.  Only the even bytes are
defined, so ignore the odd bytes in the dump.  Record the hex offset of the
first byte of the address.  Now, edit <CODE>clients/pcnet_cs.c</CODE> and
find the <CODE>hw_info</CODE> structure.  You'll need to create a new entry
for your card.  The first field is the memory offset.  The
next three fields are the first three bytes of the hardware address.
The final field contains some flags for specific card features; to
start, try setting it to 0.
<P>After editing <CODE>pcnet_cs.c</CODE>, compile and install the new module.
Edit <CODE>/etc/pcmcia/config</CODE> again, and change the card binding
from <CODE>memory_cs</CODE> to <CODE>pcnet_cs</CODE>.  Follow the instructions for
reloading the config file, and you should be all set.  Please send me
copies of your new <CODE>hw_info</CODE> and config entries.
<P>If you can't find your card's hardware address in the hex dump, as a
method of last resort, it is possible to ``hard-wire'' the address when
the <CODE>pcnet_cs</CODE> module is initialized.  Edit
<CODE>/etc/pcmcia/config.opts</CODE> and add a <CODE>hw_addr=</CODE> option, like
so: 
<P>
<BLOCKQUOTE><CODE>
<PRE>
module "pcnet_cs" opts "hw_addr=0x00,0x80,0xc8,0x01,0x02,0x03"
</PRE>
</CODE></BLOCKQUOTE>
<P>Substitute your own card's hardware address in the appropriate spot,
of course.  Beware that if you've gotten this far, it is very unlikely
that your card is genuinely NE2000 compatible.  In fact, I'm not sure
if there are <EM>any</EM> cards that are not handled by one of the first
two methods.
<P>
<H2><A NAME="ss6.3">6.3 PCMCIA floppy interface cards</A>
</H2>

<P>The PCMCIA floppy interface used in the Compaq Aero and a few other
laptops is not yet supported by this package.  The snag in supporting
the Aero floppy is that the Aero seems to use a customized
PCMCIA controller to support DMA to the floppy.  Without
knowing exactly how this is done, there isn't any way to implement
support under Linux.
<P>If the floppy adapter card is present when an Aero is booted, the Aero
BIOS will configure the card, and Linux will identify it as a normal
floppy drive.  When the Linux PCMCIA drivers are loaded, they will
notice that the card is already configured and attached to a Linux
driver, and this socket will be left alone.  So, the drive can be used
if it is present at boot time, but the card is not hot swappable.
<P>
<HR>
<H2><A NAME="s7">7.</A> <A HREF="#toc7">Debugging tips and programming information</A></H2>

<H2><A NAME="ss7.1">7.1 Submitting useful problem reports</A>
</H2>

<P>The best way to submit reports is to use the online pcmcia-cs forums
or the bug tracker at SourceForge.  That way, other people can see
current problems (and fixes or workarounds, if available).  Here are
some things that should be included in all bug reports:
<P>
<UL>
<LI>Your system brand and model.</LI>
<LI>All PCMCIA card(s) you are using.</LI>
<LI>Your Linux kernel version (i.e., ``<CODE>uname -rv</CODE>''), and PCMCIA
driver version (i.e., ``<CODE>cardctl -V</CODE>'').</LI>
<LI>Output of 'lspci -v'</LI>
<LI>Any changes you have made to the startup files in
<CODE>/etc/pcmcia</CODE>, or to the PCMCIA startup script.</LI>
<LI>All PCMCIA-related messages in your system log file.  That
includes startup messages, and messages generated when your
cards are configured.</LI>
</UL>
<P>All the PCMCIA modules and the <CODE>cardmgr</CODE> daemon send status
messages to the system log.  These will usually end up somewhere like
<CODE>/var/log/messages</CODE> or <CODE>/var/log/daemon.log</CODE>.  These
files should be the first place to look when tracking down a problem.
When submitting a bug report, always include the relevant contents of
these files.  If you are having trouble finding your system messages,
check <CODE>/etc/syslog.conf</CODE> to see how different classes of
messages are handled.
<P>Before submitting a bug report, please check to make sure that you are
using an up-to-date copy of the driver package.  While it is somewhat
gratifying to read bug reports for things I've already fixed, it isn't
a particularly constructive use of my time.
<P>If you do not have web access, bug reports can be sent to me at
<CODE>
<A HREF="mailto:dahinds@users.sourceforge.net">dahinds@users.sourceforge.net</A></CODE>.  However, I prefer that
bug reports be posted to the pcmcia-cs SourceForge site, so that they
can be seen by others.
<P>
<H2><A NAME="ss7.2">7.2 Interpreting kernel trap reports</A>
</H2>

<P>If your problem involves a kernel fault, the register dump from the
fault is only useful if you can translate the fault address, EIP, to
something meaningful.  Recent versions of <CODE>klogd</CODE> attempt to
translate fault addresses based on the current kernel symbol map, but
this may not work if the fault is in a module, or if the problem is
severe enough that <CODE>klogd</CODE> cannot finish writing the fault
information to the system log.
<P>If a fault is in the main kernel, the fault address can be looked up
in the <CODE>System.map</CODE> file.  This may be installed in
<CODE>/System.map</CODE> or <CODE>/boot/System.map</CODE>.  If a fault is in a
module, the <CODE>nm</CODE> command gives the same information, however, the
fault address has to be adjusted based on the module's load address.
Let's say that you have the following kernel fault:
<P>
<BLOCKQUOTE><CODE>
<PRE>
Unable to handle kernel NULL pointer dereference
current->tss.cr3 = 014c9000, %cr3 = 014c9000
*pde = 00000000
Oops: 0002
CPU:    0
EIP:    0010:[&lt;c2026081>]
EFLAGS: 00010282
</PRE>
</CODE></BLOCKQUOTE>
<P>The fault address is 0xc2026081.  Looking at <CODE>System.map</CODE>, we
see that this is past the end of the kernel, i.e., is in a kernel
module.  To determine which module, check the output of
``<CODE>ksyms -m | sort</CODE>'':
<P>
<BLOCKQUOTE><CODE>
<PRE>
Address   Symbol                            Defined by
c200d000  (35k)                             [pcmcia_core]
c200d10c  register_ss_entry                 [pcmcia_core]
c200d230  unregister_ss_entry               [pcmcia_core]
          ...
c2026000  (9k)                              [3c574_cs]
c202a000  (4k)                              [serial_cs]
</PRE>
</CODE></BLOCKQUOTE>
<P>So, 0xc2026081 is in the <CODE>3c574_cs</CODE> module, and is at an offset of
0x0081 from the start of the module.  We cannot look up this offset in
<CODE>3c574_cs.o</CODE> yet: when the kernel loads a module, it inserts a
header at the module load address, so the real start of the module is
offset from the address shown in <CODE>ksyms</CODE>.  The size of the header
varies with kernel version: to find out the size for your kernel,
check a module that exports symbols (like <CODE>pcmcia_core</CODE> above), and
compare a symbol address with <CODE>nm</CODE> output for that symbol.  In this
example, <CODE>register_ss_entry</CODE> is loaded at an offset of 0xc200d10c -
0xc200d000 = 0x010c, while ``<CODE>nm pcmcia_core.o</CODE>'' shows the offset
as 0x00c0, so the header size is 0x010c - 0x00c0 = 0x004c bytes.
<P>Back to <CODE>3c574_cs</CODE>, our fault offset is 0x0081, and subtracting the
0x004c header, the real module offset is 0x0035.  Now looking at
``<CODE>nm 3c574_cs.o | sort</CODE>'', we see:
<P>
<BLOCKQUOTE><CODE>
<PRE>
0000002c d if_names
0000002c t tc574_attach
00000040 d mii_preamble_required
00000041 d dev_info
</PRE>
</CODE></BLOCKQUOTE>
<P>So, the fault is located in <CODE>tc574_attach()</CODE>.
<P>In this example, the fault did not cause a total system lockup, so
<CODE>ksyms</CODE> could be executed after the fault happened.  In other
cases, you may have to infer the module load addresses indirectly.
The same sequence of events will normally load modules in the same
order and at the same addresses.  If a fault happens when a certain
card is inserted, get the <CODE>ksyms</CODE> output before inserting the card,
or with a different card inserted.  You can also manually load the
card's driver modules with <CODE>insmod</CODE> and run <CODE>ksyms</CODE> before
inserting the card.
<P>For more background, see ``<CODE>man insmod</CODE>'', ``<CODE>man ksyms</CODE>'', and
``<CODE>man klogd</CODE>''.  In the kernel source tree,
<CODE>Documentation/oops-tracing.txt</CODE> is also relevant.  Here are a
few more kernel debugging hints: 
<P>
<UL>
<LI>Depending on the fault, it may also be useful to translate
addresses in the ``Call Trace'', using the same procedure as for the
main fault address.</LI>
<LI>To diagnose a silent lock-up, try to provoke the problem with X
disabled, since kernel messages sent to the text console will not be
visible under X.</LI>
<LI>If you kill <CODE>klogd</CODE>, most kernel messages will be echoed
directly on the text console, which may be helpful if the problem
prevents <CODE>klogd</CODE> from writing to the system log.</LI>
<LI>To cause all kernel messages to be sent to the console, for 2.2
and later kernels, if <CODE>/proc/sys/kernel/printk</CODE> exists, do:
<BLOCKQUOTE><CODE>
<PRE>
echo 8 > /proc/sys/kernel/printk
</PRE>
</CODE></BLOCKQUOTE>
</LI>
<LI>The key combination &lt;RightAlt&gt;&lt;ScrLk&gt; prints a
register dump on the text console.  This may work even if the system
is otherwise completely unresponsive, and the EIP address can be
interpreted as for a kernel fault.</LI>
<LI>For 2.2 and later kernels configured with
<CODE>CONFIG_MAGIC_SYSRQ</CODE> enabled, various emergency functions are
available via special &lt;Alt&gt;&lt;SysRq&gt; key combinations,
documented in <CODE>Documentation/sysrq.txt</CODE> in the kernel source
tree.</LI>
</UL>
<P>
<H2><A NAME="pcdebug"></A> <A NAME="ss7.3">7.3 Low level PCMCIA debugging aids</A>
</H2>

<P>The PCMCIA modules contain a lot of conditionally-compiled debugging
code.  Most of this code is under control of the <CODE>PCMCIA_DEBUG</CODE>
preprocessor define.  If this is undefined, debugging code will
not be compiled.  If set to 0, the code is compiled but inactive.
Larger numbers specify increasing levels of verbosity.  Each module
built with <CODE>PCMCIA_DEBUG</CODE> defined will have an integer parameter,
<CODE>pc_debug</CODE>, that controls the verbosity of its output.  This
can be adjusted when the module is loaded, so output can be controlled
on a per-module basis without recompiling.
<P>Your default configuration for <CODE>syslogd</CODE> may discard kernel
debugging messages.  To ensure that they are recorded, edit
<CODE>/etc/syslog.conf</CODE> to ensure that ``<CODE>kern.debug</CODE>'' messages
are recorded somewhere.  See ``<CODE>man syslog.conf</CODE>'' for details.
<P>There are a few register-level debugging tools in the
<CODE>debug_tools/</CODE> subdirectory of the PCMCIA distribution.  The
<CODE>dump_tcic</CODE> and <CODE>dump_i365</CODE> utilities generate register dumps
for ISA-to-PCMCIA controllers.  In 3.1.15 and later releases,
<CODE>dump_i365</CODE> is replaced by <CODE>dump_exca</CODE>, which is similar but
also works for PCI-to-CardBus bridges.  Also new in 3.1.15 for CardBus
bridges is the <CODE>dump_cardbus</CODE> tool, which interprets the
CardBus-specific registers.  These are all most useful if you have
access to a datasheet for the corresponding controller chip.  The
<CODE>dump_cis</CODE> utility (<CODE>dump_tuples</CODE> in pre-3.0.2 distributions)
lists the contents of a card's CIS (Card Information Structure), and
decodes most of the important bits.  And the <CODE>dump_cisreg</CODE> utility
displays a card's local configuration registers.
<P>The <CODE>memory_cs</CODE> memory card driver is also sometimes useful for
debugging problems with 16-bit PC Cards.  It can be bound to any card,
and does not interfere with other drivers.  It can be used to directly
access any card's attribute memory or common memory.  Similarly for
CardBus cards, the <CODE>memory_cb</CODE> driver can be bound to any 32-bit
card, to give direct access to that card's address spaces.  See the
man pages for more information.
<P>
<H2><A NAME="ss7.4">7.4 /proc/bus/pccard</A>
</H2>

<P>On 2.2 and later kernels, the PCMCIA package will create a tree
of status information under <CODE>/proc/bus/pccard</CODE>.
Much of the information can only be interpreted using the data sheets
for the PCMCIA host controller.  Its contents may depend on how the
drivers were configured, but may include all or some of the following:
<P>
<DL>
<DT><B><CODE>/proc/bus/pccard/{irq,ioport,memory}</CODE></B><DD><P>If present, these files contain resource allocation information to
supplement the normal kernel resource tables.  Recent versions of
the PCMCIA system may obtain additional resource information from
the Plug and Play BIOS if configured to do so.
<DT><B><CODE>/proc/bus/pccard/drivers</CODE></B><DD><P>In recent releases, this lists all currently loaded PCMCIA client
drivers.  Unlike <CODE>/proc/modules</CODE>, it also lists drivers that
may be statically linked into the kernel.
<DT><B><CODE>/proc/bus/pccard/*/info</CODE></B><DD><P>For each socket, describes that socket's host controller and its
capabilities.
<DT><B><CODE>/proc/bus/pccard/*/exca</CODE></B><DD><P>This contains a dump of a controller's ``ExCA'' Intel
i82365sl-compatible register set.
<DT><B><CODE>/proc/bus/pccard/*/{pci,cardbus}</CODE></B><DD><P>For CardBus bridges, a dump of the bridge's PCI configuration space,
and a dump of the bridge's CardBus configuration registers.
</DL>
<P>
<H2><A NAME="ss7.5">7.5 Writing Card Services drivers for new cards</A>
</H2>

<P>The Linux PCMCIA Programmer's Guide is the best documentation for the
client driver interface.  The latest version is always available from
<CODE>projects.sourceforge.net</CODE> in <CODE>/pub/pcmcia-cs/doc</CODE>, or on
the web at 
<A HREF="http://pcmcia-cs.sourceforge.net">http://pcmcia-cs.sourceforge.net</A>.
<P>For devices that are close relatives of normal ISA devices, you will
probably be able to use parts of existing Linux drivers.  In some
cases, the biggest stumbling block will be modifying an existing
driver so that it can handle adding and removing devices after boot
time.  Of the current drivers, the memory card driver is the only
``self-contained'' driver that does not depend on other parts of the
Linux kernel to do most of the dirty work.
<P>In many cases, the largest barrier to supporting a new card type is
obtaining technical information from the manufacturer.  It may be
difficult to figure out who to ask, or to explain exactly what
information is needed.  However, with a few exceptions, it is very
difficult if not impossible to implement a driver for a card without
technical information from the manufacturer.
<P>I have written a dummy driver with lots of comments that explains a
lot of how a driver communicates with Card Services; you will find
this in the PCMCIA source distribution in <CODE>clients/dummy_cs.c</CODE>.
<P>
<H2><A NAME="ss7.6">7.6 Guidelines for PCMCIA client driver authors</A>
</H2>

<P>
<P>I have decided that it is not really feasible for me to distribute all
PCMCIA client drivers as part of the PCMCIA package.  Each new driver
makes the main package incrementally harder to maintain, and including
a driver inevitably transfers some of the maintenance work from the
driver author to me.  Instead, I will decide on a case by case basis
whether or not to include contributed drivers, based on user demand as
well as maintainability.  For drivers not included in the core
package, I suggest that driver authors adopt the following scheme for
packaging their drivers for distribution.
<P>Driver files should be arranged in the same directory scheme used in
the PCMCIA source distribution, so that the driver can be unpacked on
top of a complete PCMCIA source tree.  A driver should include source
files (in <CODE>./modules/</CODE>), a man page (in <CODE>./man/</CODE>), and
configuration files (in <CODE>./etc/</CODE>).  The top level directory
should also include a README file.
<P>The top-level directory should include a makefile, set up so
that ``<CODE>make -f ...</CODE> all'' and ``<CODE>make -f ... install</CODE>'' compile the
driver and install all appropriate files.  If this makefile is given
an extension of <CODE>.mk</CODE>, then it will automatically be invoked by the
top-level <CODE>Makefile</CODE> for the <CODE>all</CODE> and <CODE>install</CODE> targets.
Here is an example of how such a makefile could be constructed:
<P>
<BLOCKQUOTE><CODE>
<PRE>
# Sample Makefile for contributed client driver
FILES = sample_cs.mk README.sample_cs \
        modules/sample_cs.c modules/sample_cs.h \
        etc/sample.conf etc/sample etc/sample.opts \
        man/sample_cs.4
all:
        $(MAKE) -C modules MODULES=sample_cs.o
install:
        $(MAKE) -C modules install-modules MODULES=sample_cs.o
        $(MAKE) -C etc install-clients CLIENTS=sample
        $(MAKE) -C man install-man4 MAN4=sample_cs.4
dist:
        tar czvf sample_cs.tar.gz $(FILES)
</PRE>
</CODE></BLOCKQUOTE>
<P>This makefile uses install targets defined in 2.9.10 and later
versions of the PCMCIA package.  This makefile also includes a
``dist'' target for the convenience of the driver author.  You would
probably want to add a version number to the final package filename
(for example, <CODE>sample_cs-1.5.tar.gz</CODE>).  A complete distribution
could look like:
<P>
<BLOCKQUOTE><CODE>
<PRE>
sample_cs.mk
README.sample_cs
modules/sample_cs.c
modules/sample_cs.h
etc/sample.conf
etc/sample
etc/sample.opts
man/sample_cs.4
</PRE>
</CODE></BLOCKQUOTE>
<P>With this arrangement, when the contributed driver is unpacked, it
becomes essentially part of the PCMCIA source tree.  It can make use
of the PCMCIA header files, as well as the machinery for checking the
user's system configuration, and automatic dependency checking, just
like a ``normal'' client driver. 
<P>In this example, <CODE>etc/sample</CODE> and <CODE>etc/sample.opts</CODE>
would be the new driver's configuration scripts (if needed), and
<CODE>etc/sample.conf</CODE> would contain any additions to the PCMCIA
card configuration file.  Starting with the 3.1.6 release,
<CODE>cardmgr</CODE> will automatically process any <CODE>*.conf</CODE> files
installed in <CODE>/etc/pcmcia</CODE>, so installation of contributed
drivers should no longer require hand editing configuration files.
<P>I will accept client drivers prepared according to this specification
and place them in the <CODE>/pub/pcmcia-cs/contrib</CODE> directory on
<CODE>projects.sourceforge.net</CODE>.  The README in this directory will
describe how to unpack a contributed driver.
<P>The client driver interface has not changed much over time, and has
almost always preserved backwards compatibility.  A client driver will
not normally need to be updated for minor revisions in the main
package.  I will try to notify authors of contributed drivers of
changes that require updates to their drivers.
<P>
<H2><A NAME="ss7.7">7.7 Guidelines for Linux distribution maintainers</A>
</H2>

<P>
<P>If your distribution has system configuration tools that you would
like to be PCMCIA-aware, please use the <CODE>*.opts</CODE> files in
<CODE>/etc/pcmcia</CODE> for your ``hooks.''  These files will not be
modified if a user compiles and installs a new release of the PCMCIA
package.  If you modify the main configuration scripts, then a fresh
install will silently overwrite your custom scripts and break the
connection with your configuration tools.  Contact me if you are not
sure how to write an appropriate option script, or if you need
additional capabilities.
<P>It is helpful for users (and for me) if you can document how your
distribution deviates from the PCMCIA package as described in this
document.  In particular, please document changes to the startup
script and configuration scripts.  If you send me the appropriate
information, I will include it in the 
<A HREF="#distributions">Notes about specific Linux distributions</A>.
<P>When building PCMCIA for distribution, consider including contributed
drivers that are not part of the main PCMCIA package.  For reasons of
maintainability, I am trying to limit the core package size, by only
adding new drivers if I think they are of particularly broad interest.
Other drivers will be distributed separately, as described in the
previous section.  The split between integral and separate drivers is
somewhat arbitrary and partly historical, and should not imply a
difference in quality.
<P>
<HR>
</BODY>
</HTML>
