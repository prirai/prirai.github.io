<HTML
><HEAD
><TITLE
>Postfix-Cyrus-Web-cyradm-HOWTO</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"><link rel="stylesheet" href="../bookstyle.css"></HEAD
><BODY
CLASS="ARTICLE"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="TITLE"
><A
NAME="AEN2"
></A
>Postfix-Cyrus-Web-cyradm-HOWTO</H1
><H3
CLASS="AUTHOR"
><A
NAME="AEN4"
>Luc de Louw</A
></H3
><DIV
CLASS="AFFILIATION"
><DIV
CLASS="ADDRESS"
><P
CLASS="ADDRESS"
>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:luc at delouw.ch"
>luc at delouw.ch</A
>&#62;</TT
><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</P
></DIV
></DIV
><DIV
CLASS="REVHISTORY"
><TABLE
WIDTH="100%"
BORDER="0"
><TR
><TH
ALIGN="LEFT"
VALIGN="TOP"
COLSPAN="3"
><B
>Revision History</B
></TH
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.6</TD
><TD
ALIGN="LEFT"
>2004-03-30</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added minor additions and corrected to amavisd-new, corrected cronjob-time for freshclam</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.5</TD
><TD
ALIGN="LEFT"
>2004-03-28</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added Anti-Virus and SPAM methods (amavisd-new, spamassassin, clamav), updated cyrus-imapd section with update instructions, added instruction to restrict imapd admin access.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.4</TD
><TD
ALIGN="LEFT"
>2003-11-30</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Input from English proofreading, minor correction and enhancements from user-input, updated software mentioned in the HOWTO</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.3</TD
><TD
ALIGN="LEFT"
>2003-03-24</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Some minor correction and enhancements from user-input, updated software mentioned in the HOWTO</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.2</TD
><TD
ALIGN="LEFT"
>2003-02-14</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Lots of grammar and typos fixed. Some corrections to the pam_mysql Makefile</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.1</TD
><TD
ALIGN="LEFT"
>2003-02-12</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Non-official test-release: Added lots of fixes and updates. Added OpenSSL and more pam related stuff.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.2.0</TD
><TD
ALIGN="LEFT"
>2002-10-16</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added lot of user requests, updated the software mentioned in the HOWTO</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.7</TD
><TD
ALIGN="LEFT"
>2002-10-15</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added Michael Muenz' hints for SMTP AUTH, corrected ca-cert related mistake, improved SGML code (more metadata), updated the software mentioned in the document.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.6</TD
><TD
ALIGN="LEFT"
>2002-06-14</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added sasl_mech_list: PLAIN to imapd.conf, added web-cyradm mailinglist, added more
		to web-cyradm</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.5</TD
><TD
ALIGN="LEFT"
>2002-06-11</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added new SQL query to initialize web-cyradm
		to have full data integrity in the MySQL Database, mysql-mydestination.cf reported to be operational as
		expected.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.4</TD
><TD
ALIGN="LEFT"
>2002-05-15</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added description what is needed in /etc/services
		Another fix for pam_mysql compile, updated software versions.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.3</TD
><TD
ALIGN="LEFT"
>2002-05-08</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added more description for web-cyradm, fix for wrong path of the saslauthdb-socket, Fix for
		wrong place of com_err.h, protection of the TLS/SSL private key.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.2</TD
><TD
ALIGN="LEFT"
>2002-04-29</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added description for Redhat users how to install the init scripts.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.1</TD
><TD
ALIGN="LEFT"
>2002-04-29</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Fixed bug in configuring cyrus-IMAP (disabled unused kerberos authentication)</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.1.0</TD
><TD
ALIGN="LEFT"
>2002-04-28</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Initial support for building cyrus from source, dropped binary installation
		for Cyrus, because configuration has changed with Release 2.1.x</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.0.2</TD
><TD
ALIGN="LEFT"
>2002-04-25</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added basic description for sieve and correct sender handling, minor fixes to db related 
		stuff, Added mysql-lookup for »mydestination« , fixed bug for building postfix 
		with mysql support.</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.0.1</TD
><TD
ALIGN="LEFT"
>2002-04-07</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Added an important fix for compiling pam_mysql</TD
></TR
><TR
><TD
ALIGN="LEFT"
>Revision 1.0.0</TD
><TD
ALIGN="LEFT"
>2002-04-07</TD
><TD
ALIGN="LEFT"
>Revised by: ldl</TD
></TR
><TR
><TD
ALIGN="LEFT"
COLSPAN="3"
>Initial Release</TD
></TR
></TABLE
></DIV
><DIV
><DIV
CLASS="ABSTRACT"
><A
NAME="AEN101"
></A
><P
></P
><P
>	This document guides you through the installation of the Postfix mail transportation agent (MTA), 
	the Cyrus IMAP server. The goal is a fully functional high-performance 
	mailsystem with user-administration with Web-cyradm, a webinterface. Data like virtualusers, 
	aliases etc. are stored in a mysql database.
    </P
><P
></P
></DIV
></DIV
><HR></DIV
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
>1. <A
HREF="#INTRO"
>Introduction</A
></DT
><DD
><DL
><DT
>1.1. <A
HREF="#AEN111"
>Contributors and Contacts</A
></DT
><DT
>1.2. <A
HREF="#AEN115"
>Why I wrote this document</A
></DT
><DT
>1.3. <A
HREF="#COPYRIGHT"
>Copyright Information</A
></DT
><DT
>1.4. <A
HREF="#DISCLAIMER"
>Disclaimer</A
></DT
><DT
>1.5. <A
HREF="#NEWVERSIONS"
>New Versions</A
></DT
><DT
>1.6. <A
HREF="#CREDITS"
>Credits</A
></DT
><DT
>1.7. <A
HREF="#FEEDBACK"
>Feedback</A
></DT
><DT
>1.8. <A
HREF="#TRANSLATIONS"
>Translations</A
></DT
></DL
></DD
><DT
>2. <A
HREF="#TECH"
>Technologies</A
></DT
><DD
><DL
><DT
>2.1. <A
HREF="#POSTFIX"
>The Postfix MTA</A
></DT
><DT
>2.2. <A
HREF="#CYRUS"
>Cyrus IMAP</A
></DT
><DT
>2.3. <A
HREF="#SASL"
>Cyrus SASL</A
></DT
><DT
>2.4. <A
HREF="#OPENSSL"
>OpenSSL</A
></DT
><DT
>2.5. <A
HREF="#MYSQL"
>MySQL Database</A
></DT
><DT
>2.6. <A
HREF="#PAM-MYSQL"
>pam_mysql</A
></DT
><DT
>2.7. <A
HREF="#WEB-CYRADM"
>Web-cyradm Webinterface</A
></DT
></DL
></DD
><DT
>3. <A
HREF="#INSTALL"
>Getting and installing the software</A
></DT
><DD
><DL
><DT
>3.1. <A
HREF="#MYSQL-INSTALL"
>Getting and installing MySQL</A
></DT
><DT
>3.2. <A
HREF="#BERKELEY-DB"
>Getting and installing Berkeley DB</A
></DT
><DT
>3.3. <A
HREF="#AEN301"
>Getting and installing OpenSSL</A
></DT
><DT
>3.4. <A
HREF="#CYRUS-INSTALL"
>Getting and installing Cyrus SASL and IMAP</A
></DT
><DT
>3.5. <A
HREF="#POSTFIX-INSTALL"
>Getting and installing Postfix</A
></DT
><DT
>3.6. <A
HREF="#PAM-INSTALL"
>Getting and installing PAM</A
></DT
><DT
>3.7. <A
HREF="#PAM-MYSQL-INSTALL"
>Getting and installing pam_mysql</A
></DT
><DT
>3.8. <A
HREF="#WEB-CYRADM-INSTALL"
>Getting and installing Web-cyradm</A
></DT
></DL
></DD
><DT
>4. <A
HREF="#MYSQL-CONFIG"
>Configuring MySQL</A
></DT
><DD
><DL
><DT
>4.1. <A
HREF="#MYSQL-CONFIG-SECURING"
>Securing MySQL</A
></DT
><DT
>4.2. <A
HREF="#MYSQL-RINETD"
>Setting up rinetd</A
></DT
></DL
></DD
><DT
>5. <A
HREF="#PAM-CONFIG"
>Configuring PAM</A
></DT
><DT
>6. <A
HREF="#POSTFIX-CONFIG"
>Configuring Postfix</A
></DT
><DD
><DL
><DT
>6.1. <A
HREF="#POSTFIX-MASTER"
>master.cf</A
></DT
><DT
>6.2. <A
HREF="#POSTFIX-MAIN"
>main.cf</A
></DT
><DT
>6.3. <A
HREF="#ANTISPAM"
>Fighting against SPAM</A
></DT
></DL
></DD
><DT
>7. <A
HREF="#CYRUS-CONFIG"
>Configuring Cyrus IMAP</A
></DT
><DD
><DL
><DT
>7.1. <A
HREF="#CYRUS-CONFIGFILES"
>Creating the config files</A
></DT
><DT
>7.2. <A
HREF="#CYRUS-DIRECTORIES"
>Creating the directories</A
></DT
><DT
>7.3. <A
HREF="#CH-ATTRIB"
>Changing the filesystem attributes</A
></DT
></DL
></DD
><DT
>8. <A
HREF="#WEB-CYRADM-CONFIG"
>Configuring Web-cyradm</A
></DT
><DD
><DL
><DT
>8.1. <A
HREF="#AEN645"
>Cyrus setup</A
></DT
><DT
>8.2. <A
HREF="#AEN649"
>Database setup</A
></DT
><DT
>8.3. <A
HREF="#AEN654"
>Default Quota</A
></DT
><DT
>8.4. <A
HREF="#AEN658"
>Crypted passwords</A
></DT
><DT
>8.5. <A
HREF="#AEN669"
>Usernames</A
></DT
></DL
></DD
><DT
>9. <A
HREF="#TEST"
>Testing the setup</A
></DT
><DD
><DL
><DT
>9.1. <A
HREF="#TEST-RUNNING"
>(Re-)Starting the daemons</A
></DT
><DT
>9.2. <A
HREF="#TESTING-WEB-CYRADM"
>Testing Web-cyradm</A
></DT
><DT
>9.3. <A
HREF="#TESTING-POSTFIX"
>Testing postfix</A
></DT
><DT
>9.4. <A
HREF="#TESTING-CYRUS"
>Testing the IMAP functionality</A
></DT
></DL
></DD
><DT
>10. <A
HREF="#SPAM-AND-VIRUS-INTRO"
>Fighting against Viruses and SPAM</A
></DT
><DD
><DL
><DT
>10.1. <A
HREF="#BRIEF-VIRUS"
>Brief introdcution to viruses</A
></DT
><DT
>10.2. <A
HREF="#BRIEF-SPAM"
>Brief introduction to SPAM</A
></DT
><DT
>10.3. <A
HREF="#STRATEGY-VIRUSES"
>Strategy against viruses</A
></DT
><DT
>10.4. <A
HREF="#STRATEGY-SPAM"
>Strategy against SPAM</A
></DT
></DL
></DD
><DT
>11. <A
HREF="#INSTALLING-ANTI-SPAM"
>The software needed against viruses and SPAM</A
></DT
><DD
><DL
><DT
>11.1. <A
HREF="#GET-CLAMAV"
>Getting and installing ClamAV</A
></DT
><DT
>11.2. <A
HREF="#RAZOR"
>Razor</A
></DT
><DT
>11.3. <A
HREF="#GET-SPAMASSASSIN"
>Getting and installing spamassassin</A
></DT
><DT
>11.4. <A
HREF="#AMAVIS-INSTALL"
>Getting and installing amavisd-new</A
></DT
><DT
>11.5. <A
HREF="#POSTFIX-SETUP"
>Setting up postfix</A
></DT
></DL
></DD
><DT
>12. <A
HREF="#MOREINFO"
>Further Information</A
></DT
><DD
><DL
><DT
>12.1. <A
HREF="#NEWSGROUPS"
>News groups</A
></DT
><DT
>12.2. <A
HREF="#MAILLISTS"
>Mailing Lists</A
></DT
><DT
>12.3. <A
HREF="#HOWTO"
>HOWTO</A
></DT
><DT
>12.4. <A
HREF="#EBOOKS"
>Ebooks</A
></DT
><DT
>12.5. <A
HREF="#LOCAL-RES"
>Local Resources</A
></DT
><DT
>12.6. <A
HREF="#WEB"
>Web Sites</A
></DT
></DL
></DD
><DT
>13. <A
HREF="#FAQ"
>Questions and Answers</A
></DT
></DL
></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="INTRO"
></A
>1. Introduction</H1
><P
>   The cyrus part is only valid for Cyrus-IMAP 2.1.x and Cyrus-SASL 2.1.x. If you plan to use Cyrus-IMAP 2.0.x
   then please consult the deprecated version 1.0.x of this HOWTO.</P
><P
>  I strongly recommend that you upgrade to Cyrus Version 2.1.x. If you do so, you will have a better ability to get
  valuable support from the user community</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN111"
></A
>1.1. Contributors and Contacts</H2
><P
>First I would thank all those people who sent questions and suggestions that made the
	further development of this document possible. It shows me that sharing knowledge is the right way.
	I would encourage you to send me more suggestion, just write me an email <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:luc at delouw.ch"
>luc at delouw.ch</A
>&#62;</TT
>
	</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN115"
></A
>1.2. Why I wrote this document</H2
><P
>There are different approaches on how to set up different mailsystems. Most documents that are available are
	related to Sendmail, procmail, WU-IMAPd and friends. These packages are very good but are unfortunately very
	inflexible in their user administration.
	</P
><P
>For a long time I was testing alternative MTA's like qmail, postfix and exim, in conjunction with IMAP/POP-servers like 
	Cyrus, vpopmail, Courier IMAP and others.</P
><P
>At the end of the day, from my point of view the couple Postfix/Cyrus seems to be the
	most flexible and best performing solution.</P
><P
>All these combinations of software had one thing in common: their was very little documentation available
	describing how these packages work  together with each other.
	To install the software, lot of effort has be spent to get all information needed to get all the 
	software running.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="COPYRIGHT"
></A
>1.3. Copyright Information</H2
><P
>    This document is copyrighted (c) 2002, 2003, 2004 Luc de Louw and is
    distributed under the terms of the Linux Documentation Project
    (LDP) license, stated below. 
   </P
><P
>    Unless otherwise stated, Linux HOWTO documents are
    copyrighted by their respective authors. Linux HOWTO documents may
    be reproduced and distributed in whole or in part, in any medium
    physical or electronic, as long as this copyright notice is
    retained on all copies. Commercial redistribution is allowed and
    encouraged; however, the author would like to be notified of any
    such distributions.
   </P
><P
>    All translations, derivative works, or aggregate works
    incorporating any Linux HOWTO documents must be covered under this
    copyright notice. That is, you may not produce a derivative work
    from a HOWTO and impose additional restrictions on its
    distribution. Exceptions to these rules may be granted under
    certain conditions; please contact the Linux HOWTO coordinator at
    the address given below.
   </P
><P
>    In short, we wish to promote dissemination of this
    information through as many channels as possible. However, we do
    wish to retain copyright on the HOWTO documents, and would like to
    be notified of any plans to redistribute the HOWTOs.
   </P
><P
>    If you have any questions, please contact 
    <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:linux-howto at metalab.unc.edu"
>linux-howto at metalab.unc.edu</A
>&#62;</TT
>
   </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="DISCLAIMER"
></A
>1.4. Disclaimer</H2
><P
>    No liability for the contents of this documents can be accepted.
    Use the concepts, examples and other content at your own risk.
    As this is a new edition of this document, there may be errors
    and inaccuracies, that may of course be damaging to your system.
    Proceed with caution, and although this is highly unlikely,
    the author(s) do not take any responsibility for that.
   </P
><P
>    All copyrights are held by their by their respective owners, unless
    specifically noted otherwise.  Use of a term in this document
    should not be regarded as affecting the validity of any trademark
    or service mark.
   </P
><P
>    Naming of particular products or brands should not be seen 
    as endorsements.
   </P
><P
>    You are strongly recommended to take a backup of your system 
    before major installation and backups at regular intervals.
   </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="NEWVERSIONS"
></A
>1.5. New Versions</H2
><P
>New version of this document are announced on freshmeat</P
><P
>    The latest version of this document can be obtained from
    <A
HREF="http://www.delouw.ch/linux"
TARGET="_top"
>http://www.delouw.ch/linux</A
> 
   </P
><P
>   <P
></P
><UL
><LI
><P
>      <A
HREF="http://www.delouw.ch/linux/Postfix-Cyrus-Web-cyradm-HOWTO/html/index.html"
TARGET="_top"
>HTML</A
>.
     </P
></LI
><LI
><P
>      <A
HREF="http://www.delouw.ch/linux/Postfix-Cyrus-Web-cyradm-HOWTO/Postfix-Cyrus-Web-cyradm-HOWTO.ps"
TARGET="_top"
>	Postscript (ISO A4 format)</A
>.
     </P
></LI
><LI
><P
>       <A
HREF="http://www.delouw.ch/linux/Postfix-Cyrus-Web-cyradm-HOWTO/Postfix-Cyrus-Web-cyradm-HOWTO.pdf"
TARGET="_top"
>Acrobat PDF</A
>.
     </P
></LI
><LI
><P
>       <A
HREF="http://www.delouw.ch/linux/Postfix-Cyrus-Web-cyradm-HOWTO/Postfix-Cyrus-Web-cyradm-HOWTO.sgml"
TARGET="_top"
>SGML Source</A
>.
     </P
></LI
><LI
><P
>      <A
HREF="http://www.delouw.ch/linux/Postfix-Cyrus-Web-cyradm-HOWTO/Postfix-Cyrus-Web-cyradm-HOWTO.tar.gz"
TARGET="_top"
>HTML gzipped tarball</A
>.
     </P
></LI
></UL
>
   </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="CREDITS"
></A
>1.6. Credits</H2
><P
></P
><UL
><LI
><P
>	Martynas Bieliauskas <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:martynas at inet.lt"
>martynas at inet.lt</A
>&#62;</TT
> submitted a good idea how to restrict the cyrus admin to localhost only.
	</P
></LI
><LI
><P
>	Michael Muenz <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:m.muenz at maxonline.de"
>m.muenz at maxonline.de</A
>&#62;</TT
> for his help with SMTP Authentication
	</P
></LI
><LI
><P
>	Ron Wheeler <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:rwheeler at artifact-software.com"
>rwheeler at artifact-software.com</A
>&#62;</TT
> for his help with editing for readability
	</P
></LI
><LI
><P
>    The nice people at <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto: discuss at tldp.org"
> discuss at tldp.org</A
>&#62;</TT
> for
    supporting me in writing the HOWTOs.
   </P
></LI
></UL
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="FEEDBACK"
></A
>1.7. Feedback</H2
><P
>    Feedback is most certainly welcome for this document. Without
    your submissions and input, this document wouldn't exist. Please
    send your additions, comments and criticisms to the following
    email address : <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:luc at delouw.ch"
>luc at delouw.ch</A
>&#62;</TT
>.
   </P
><P
>   Please understand, that I don't want to add Cyrus-IMAP 2.0.x related stuff in this document anymore.
   </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="TRANSLATIONS"
></A
>1.8. Translations</H2
><P
>     	At the moment no translations are available. A German translation is planned and would be
     	written by me as soon as I get the time. 
   </P
><P
>	Translations to other languages are always welcome. If you translate this document, please translate the
	SGML source. Please let me know if you begin to translate, so I can set a link here.
   </P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="TECH"
></A
>2. Technologies</H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="POSTFIX"
></A
>2.1. The Postfix MTA</H2
><A
NAME="AEN187"
></A
><TABLE
BORDER="0"
WIDTH="100%"
CELLSPACING="0"
CELLPADDING="0"
CLASS="BLOCKQUOTE"
><TR
><TD
WIDTH="10%"
VALIGN="TOP"
>&nbsp;</TD
><TD
WIDTH="80%"
VALIGN="TOP"
><P
>        Postfix attempts to be fast, easy to administer, and secure, while at the same time
        being sendmail compatible enough to not upset existing users. Thus, the outside has a
        sendmail-ish flavor, but the inside is completely different.</P
></TD
><TD
WIDTH="10%"
VALIGN="TOP"
>&nbsp;</TD
></TR
><TR
><TD
COLSPAN="2"
ALIGN="RIGHT"
VALIGN="TOP"
>--<SPAN
CLASS="ATTRIBUTION"
>www.postfix.org</SPAN
></TD
><TD
WIDTH="10%"
>&nbsp;</TD
></TR
></TABLE
><P
>		<DIV
CLASS="FIGURE"
><A
NAME="AEN191"
></A
><P
><B
>Figure 1. Postfix - the big picture</B
></P
><P
><IMG
SRC="big-picture.png"></P
></DIV
>
   	</P
><P
>Doesn't it look impressive? - It looks much more complicated than it is. Postfix is indeed nice
	      to configure and handle.</P
><P
>Unlike sendmail, postfix is not one monolithic program, it is a compilation of small programs, each of
	      which has a specialized function. 
	      At this point I don't what to go into details about what each program does what.
	      If you are interested how Postfix works, please see the documentation at 
	      <A
HREF="http://www.postfix.org/docs.html"
TARGET="_top"
>http://www.postfix.org/docs.html</A
>
	</P
><P
>In this document you will find the information needed to get the system running in conjunction with the other components of a full e-mail setup.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="CYRUS"
></A
>2.2. Cyrus IMAP</H2
><P
>Cyrus IMAP is developed and maintained by Carnegie Mellon University.</P
><P
>Unlike the WU-IMAPd package, Cyrus uses its own method to store the user's mail. 
	Each message is stored in its own file. 
	The benefit of using separate files is improved reliability since only one message is lost if there is a filesystem error.
	Metadata such as the status of a message (seen, etc) is stored in a database.
	Additionally, the messages are indexed to improve Cyrus performance, specially with lots of users and/or lots of big emails.
	There is nothing else as fast as the Cyrus IMAP-server.</P
><P
>	Another very important feature is that you don't need a local Un*x user for each account. All users are 
	authenticated by the IMAP-Server. This makes it a great solution when you have a really huge number of users.</P
><P
>	User administration is done by special IMAP-commands. This allows you to either use the commandline interface
	or use one of the available Web interfaces. This method is much more secure than a Webinterface to
	<TT
CLASS="FILENAME"
> /etc/passwd</TT
>.</P
><P
>Starting from Cyrus 2.1, SASL-lib version 2 is used for authentication. 
	For the setup described in this HOWTO, a tree-layer authentication is implemented.
	Cyrus authenticates with saslauthdaemon which forwards the request
	to pam_mysql which finally looks up the user information in the MySQL-table.</P
><P
>	Since CMU changed the license policy for Cyrus, this software is going to be used by many more users.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="SASL"
></A
>2.3. Cyrus SASL</H2
><P
>SASL means »Simple Authentication and Security Layer«. It is standardized by the IETF (Internet 
	Engineering Taskforce). SASL is used by network servers (in this case Cyrus-IMAP) to
	handle authentication requests from clients.</P
><P
>Cyrus SASL is a extensive software, and sometimes not	easy to understand.
	Even I have just the minimum knowledge needed to write this HOWTO.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="OPENSSL"
></A
>2.4. OpenSSL</H2
><P
>OpenSSL is a library needed by SASL for encryption of the data-stream. It is used by 
	almost all opensource software that need encryption.
	Most or all Un*x distributions come with a pre-installed OpenSSL.
	Be sure to also install the appropriate devel-package. If you like, you can 
	compile OpenSSL by yourself. This will be required if you need to fix a security hole.
	</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="MYSQL"
></A
>2.5. MySQL Database</H2
><P
>MySQL is a very fast, powerful and very easy to use database.</P
><P
>Since Cyrus can authenticate its users with pam, you can use pam_mysql as a connector to the
	user database stored in MySQL. This allows you to create a nice Webinterface for your users for changing 
	passwords, defining and deleting aliases and more.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="PAM-MYSQL"
></A
>2.6. pam_mysql</H2
><P
>pam means "Pluggable Authentication module" and was originally proposed by some people at Sun.
	In meantime a lot of modules have been developed. One of them is an interface to MySQL</P
><P
>With pam_mysql you store the users password in a MySQL database. Further, Postfix is able to
	lookup aliases from a MySQL-table. At the end of the day, you have a base for all administrative tasks
	to be done by the postmaster.</P
><P
>You will be able to delegate some tasks to powerusers. For example, tasks such as creating accounts, changing passwords and creating new aliases can be delegated to an administrator for a particular domain. 
	At the end of the day, you, as a sysadmin, will have the time to do some more productive tasks or write a HOWTO for the Linux Documentation Project.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="WEB-CYRADM"
></A
>2.7. Web-cyradm Webinterface</H2
><P
>                <DIV
CLASS="FIGURE"
><A
NAME="AEN226"
></A
><P
><B
>Figure 2. Web-cyradm Domain administration</B
></P
><P
><IMG
SRC="home.png"></P
></DIV
>
        </P
><P
>Web-cyradm is the webinterface that allows you to perform the administrative tasks required to maintain the mail system.
	This screenshot shows the domain administration part of Web-cyradm.</P
><P
>Web-cyradm is written in PHP, the most sophisticated html-preprocessor language.
        If you don't have a webserver with php installed, I would like to refer you to my
        <A
HREF="http://www.delouw.ch/linux/apache.phtml"
TARGET="_top"
>Apache-Compile-HOWTO</A
>.
        This document describes how to set up Apache with PHP and other modules.</P
><P
>Web-cyradm is under active development from people around the globe. The list of features grows
	with each release. If you would like to contribute to web-cyradm, or you have a nice idea, feel free to contact
	the mailinglist on <A
HREF="http://www.web-cyradm.org"
TARGET="_top"
>http://www.web-cyradm.org</A
>
	</P
><P
>	The following is a partial list of features:
	<P
></P
><UL
><LI
><P
>Administration of multiple virtual domains</P
></LI
><LI
><P
>Setting of quotas</P
></LI
><LI
><P
>Automatically creating usernames, either with a defined prefix, or the domainname</P
></LI
><LI
><P
>Delegation of tasks such as creating new users to »Domain Masters« </P
></LI
><LI
><P
>Mapping of user-accounts to email addresses</P
></LI
><LI
><P
>Forwarding of accounts to single aliases</P
></LI
><LI
><P
>Vacation functions for a single aliases</P
></LI
><LI
><P
>Support for SMTP Transport Tables</P
></LI
><LI
><P
>Support for MySQL and PostgreSQL</P
></LI
><LI
><P
>i18n (internationalization) support (including different charsets)</P
></LI
><LI
><P
>Translated into 18 Languages and growing</P
></LI
></UL
>
	</P
><P
>Web-cyradm supports different roles of its users. 
	If you plan to use it as a frontend for your powerusers, please notice 
	that security may be a problem. The role based stuff needs a security review.
	</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="INSTALL"
></A
>3. Getting and installing the software</H1
><P
>	Most of the software is included in your Linux distribution. I. e. SuSE is shipping Cyrus as 
	far as I know since 7.1.
	Since SuSE 8.1, cyrus-imap 2.1 and sasl2 is included, and works. It is still recommended to compile
	Cyrus by yourself. SuSE does not ship a MySQL enabled Postfix.
	</P
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.gif"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Deprecated packages for Debian stable and testing</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Debian users probably want to install packages provided by Debian. Unfortunately Debian stable (Woody) and testing (sarge) are using the deprecated version of the software used in this HOWTO. I tested the respective packages from Debian unstable (sid) and the are working. Please note, that the maintainers at Debian are very conservative. The software packages »postfix-mysql«, »libsasl2« and »cyrus21-imapd« are stable, even if they are only available in the »unstable« tree.</P
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="MYSQL-INSTALL"
></A
>3.1. Getting and installing MySQL</H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN267"
></A
>3.1.1. Download</H3
><P
>		Origin-Site: <A
HREF="http://www.mysql.com/downloads/"
TARGET="_top"
>http://www.mysql.com/downloads/</A
>
		</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN271"
></A
>3.1.2. Building and installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local
tar -xvzf mysql-4.0.18.tar.gz
cd mysql-4.0.18

./configure \
--prefix=/usr/local/mysql \
--enable-assembler \
--with-innodb \
--without-debug

make
make install

/usr/local/mysql/bin/mysql_install_db
echo /usr/local/mysql/lib/mysql &#62;&#62; /etc/ld.so.conf
ldconfig

ln -s /usr/local/mysql/include/mysql /usr/include/mysql
ln -s /usr/local/mysql/lib/mysql /usr/lib/mysql</PRE
></FONT
></TD
></TR
></TABLE
><P
>To improve security, add a mysql-user on your system i.e. »mysql«, then</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>chown -R mysql /usr/local/mysql/var</PRE
></FONT
></TD
></TR
></TABLE
><P
>	If you want to start MySQL automatically at boottime, copy 
	<TT
CLASS="FILENAME"
>/usr/local/mysql/share/mysql/mysql.server</TT
> to <TT
CLASS="FILENAME"
>/etc/init.d/</TT
>
	 for SuSE, for Redhat it is <TT
CLASS="FILENAME"
>/etc/rc.d/init.d</TT
> instead of <TT
CLASS="FILENAME"
>/etc/init.d/</TT
>. 
	Further you need to add symbolic links to <TT
CLASS="FILENAME"
>/etc/init.d/rc3.d</TT
> 
	for SuSE and <TT
CLASS="FILENAME"
>/etc/rc.d/rc3.d</TT
> for Redhat.
	</P
><P
>	The following example is for SuSE Linux and should be easily changed for Redhat and other Linux 
	distributions and commercial Unix systems.
	</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cp /usr/local/mysql/share/mysql/mysql.server /etc/init.d/
ln -s /etc/init.d/mysql.server /etc/init.d/rc3.d/S20mysql
ln -s /etc/init.d/mysql.server /etc/init.d/rc3.d/k08mysql</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="BERKELEY-DB"
></A
>3.2. Getting and installing Berkeley DB</H2
><P
>	The Berkeley DB is a requirement for building Cyrus-SASL and Cyrus-IMAP. Some Systems comes with 
	recent versions but without the header files installed. Please see your distributors CD/DVD 
	to see if you can install the header files from a package. Usually this package is called bdb-devel.
	</P
><P
>The version that comes with GNU/Debian Linux is out of date, you will need to compile the most 
	recent version instead. If you already installed Berkeley DB on your Debian Box, please 
	uninstall it to prevent conflicts.
	</P
><P
>It is also very important, that Cyrus-SASL and Cyrus-IMAP is compiled with the same version of 
	Berkeley DB or else you can run into problems.</P
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.gif"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Berkeley DB versions</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>I only tested version 4.0.x versions of bdb. Please let me know if you are successful with newer versions.</P
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN293"
></A
>3.2.1. Download Berkeley DB</H3
><P
>	Origin-Site: <A
HREF="http://www.sleepycat.com/update/snapshot/db-4.0.14.tar.gz"
TARGET="_top"
>	http://www.sleepycat.com/update/snapshot/db-4.0.14.tar.gz</A
>
	</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN297"
></A
>3.2.2. Building and installing Berkeley DB</H3
><P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd dist

./configure --prefix=/usr/local/bdb

make
make install

echo /usr/local/bdb/lib &#62;&#62; /etc/ld.so.conf
ldconfig</PRE
></FONT
></TD
></TR
></TABLE
>&#13;</P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN301"
></A
>3.3. Getting and installing OpenSSL</H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN303"
></A
>3.3.1. Download OpenSSL</H3
><P
>Origin-Site
<A
HREF="http://www.openssl.org"
TARGET="_top"
>http://www.openssl.org</A
></P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN307"
></A
>3.3.2. Building and installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local
tar -xvzf openssl-0.9.7d.tar.gz

cd openssl-0.9.7d

./config shared

make
make test
make install

echo "/usr/local/ssl/lib" &#62;&#62; /etc/ld.so.conf
ldconfig</PRE
></FONT
></TD
></TR
></TABLE
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.gif"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Select your CPU to improve speed</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>By default the Makefile generates code for the i486 CPU. You can change this by editing the
<TT
CLASS="FILENAME"
>Makefile</TT
> after running <B
CLASS="COMMAND"
>config </B
><TT
CLASS="OPTION"
>shared</TT
>.
Search for <TT
CLASS="OPTION"
>-m486</TT
> and replace it i.e with <TT
CLASS="OPTION"
>-march=athlon</TT
></P
></TD
></TR
></TABLE
></DIV
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="CYRUS-INSTALL"
></A
>3.4. Getting and installing Cyrus SASL and IMAP</H2
><P
>	Building Cyrus SASL and IMAP from source is not a easy task. There are some prerequisites to be 
	fulfilled, and lots of difficult authentication related stuff to be considered.
	</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN321"
></A
>3.4.1. Download Cyrus SASL and Cyrus IMAP</H3
><P
>	Origin-Site: <A
HREF="ftp://ftp.andrew.cmu.edu/pub/cyrus-mail/cyrus-sasl-2.1.18.tar.gz"
TARGET="_top"
>	ftp://ftp.andrew.cmu.edu/pub/cyrus-mail/cyrus-sasl-2.1.18.tar.gz</A
>
	</P
><P
>Origin-Site: <A
HREF="ftp://ftp.andrew.cmu.edu/pub/cyrus-mail/cyrus-imapd-2.2.3.tar.gz"
TARGET="_top"
>	ftp://ftp.andrew.cmu.edu/pub/cyrus-mail/cyrus-imapd-2.2.3.tar.gz</A
>

	</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN327"
></A
>3.4.2. Create the cyrus user</H3
><P
>On most systems there is no cyrus user and mailgroup by default. Check for a free UID, usually daemons are running with UIDs less that 100.
As example I am using UID 96 which is what SuSE has in the default <TT
CLASS="FILENAME"
>/etc/passwd</TT
>.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>groupadd mail
useradd -u 96 -d /usr/cyrus -g mail cyrus
passwd cyrus</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN332"
></A
>3.4.3. Building and installing Cyrus SASL</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>tar -xvzf cyrus-sasl-2.1.18.tar.gz
cd cyrus-sasl-2.1.18

./configure \
--enable-anon \
--enable-plain \
--enable-login \
--disable-krb4 \
--disable-otp \
--disable-cram \
--disable-digest \
--with-saslauthd=/var/run/saslauthd \
--with-pam=/lib/security \
--with-dblib=berkeley \
--with-bdb-libdir=/usr/local/bdb/lib \
--with-bdb-incdir=/usr/local/bdb/include \
--with-openssl=/usr/local/ssl \
--with-plugindir=/usr/local/lib/sasl2


make
make install

mkdir -p /var/run/saslauthd

cd saslauthd
make testsaslauthd
cp testsaslauthd /usr/local/bin

echo /usr/local/lib/sasl2 &#62;&#62; /etc/ld.so.conf
ldconfig</PRE
></FONT
></TD
></TR
></TABLE
><P
>The SASL library is installed in <TT
CLASS="FILENAME"
>/usr/local/lib/sasl2</TT
> but some programs are expecting SASL in 
<TT
CLASS="FILENAME"
>/usr/lib/sasl2</TT
>. So it is a good idea to create a symbolic link:
 <B
CLASS="COMMAND"
>ln -s /usr/local/lib/sasl2 /usr/lib/sasl2</B
>.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN339"
></A
>3.4.4. Building Cyrus-IMAP</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>tar -xvzf cyrus-imapd-2.2.3.tar.gz
cd cyrus-imapd-2.2.3

export CPPFLAGS="-I/usr/include/et" 

./configure \
--with-sasl=/usr/local/lib \
--with-perl \
--with-auth=unix \
--with-dbdir=/usr/local/bdb \
--with-bdb-libdir=/usr/local/bdb/lib \
--with-bdb-incdir=/usr/local/bdb/include \
--with-openssl=/usr/local/ssl \
--without-ucdsnmp \

make depend
make
make install</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="STARTUPSCRIPT"
></A
>3.4.5. Automatic startup script</H3
><P
>If you wish to start the Cyrus IMAP daemon automatically after booting, you need a startup script. 
Place the following script in <TT
CLASS="FILENAME"
>/etc/init.d/</TT
>. For Redhat, it is 
<TT
CLASS="FILENAME"
>/etc/rc.d/init.d</TT
> instead of <TT
CLASS="FILENAME"
>/etc/init.d/</TT
>.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>#!/bin/bash
#
# Cyrus startup script

case "$1" in
    start)
        # Starting SASL saslauthdaemon
        /usr/local/sbin/saslauthd -c -a pam&#38;

        # Starting Cyrus IMAP Server
        /usr/cyrus/bin/master &#38;
        ;;

    stop)

        # Stopping SASL saslauthdaemon
        killall saslauthd

        # Stopping Cyrus IMAP Server
        killall /usr/cyrus/bin/master

        ;;

    *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;

esac</PRE
></FONT
></TD
></TR
></TABLE
><P
>If I get the time, I will provide a more sophisticated script, but this script works.</P
><P
>Now create the Symlinks in the runlevel directory (SuSE):</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>ln -s /etc/init.d/cyrus /etc/init.d/rc3.d/S20
ln -s /etc/init.d/cyrus /etc/init.d/rc3.d/K10</PRE
></FONT
></TD
></TR
></TABLE
><P
>For Redhat:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>ln -s /etc/rc.d/init.d/cyrus /etc/rc.d/rc3.d/S20cyrus
ln -s /etc/rc.d/init.d/cyrus /etc/rc.d/rc3.d/K10cyrus</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="UPDATE-CYRUS"
></A
>3.4.6. Update Cyrus IMAPd</H3
><P
>This section describes HOWTO update the IMAPd from version 2.1.x to 2.2.x</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/caution.gif"
HSPACE="5"
ALT="Caution"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Update is critical and can mean complete data loss</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Please test this procedure on a test/pre-production server first. Also have close look to <TT
CLASS="FILENAME"
>install-upgrade.html</TT
> that comes with the cyrus-imapd distribution. Please note, that you shoud plan a downtime for the production server to have the time to solve problems. Also note, that nobody I cannot take responsibility for the update procedure provided here</P
></TD
></TR
></TABLE
></DIV
><P
>Cyrus changed the format of the dbd databases used for internal storage of mailboxlist flags etc.</P
><P
>A convert script comes with the distribution. The most important database is <TT
CLASS="FILENAME"
>/var/imap/mailboxes.db</TT
>. Without that database cyrus-imapd will NOT run. This requires a backup. Lets do a dump and a backup of the database.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>&#13;/etc/init.d/cyrus stop # be sure no cyrus process is running

lsof /var/imap/mailboxes.db # be sure NO process is accessing the mailbox file

su - cyrus
/usr/cyrus/bin/ctl_mboxlist -d &#62; /tmp/mailbox.db.dump
cp /var/imap/mailboxes.db /var/imap/mailboxes.db.old</PRE
></FONT
></TD
></TR
></TABLE
><P
>Convert the <TT
CLASS="FILENAME"
>/var/imap/mailboxes.db</TT
>

<TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>/usr/cyrus/bin/cvt_cyrusdb /var/imap/mailboxes.db berkeley /var/imap/mailboxes.db.new skiplist
mv /var/imap/mailboxes.db.new /var/imap/mailboxes.db</PRE
></FONT
></TD
></TR
></TABLE
>&#13;</P
><P
>Convert all the »seen« databases:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>find /var/imap/user -name \*.seen -exec /usr/cyrus/bin/cvt_cyrusdb \{\} flat \{\}.new skiplist \; -exec mv \{\}.new \{\} \;</PRE
></FONT
></TD
></TR
></TABLE
><P
>Converting the sieve scripts</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>/usr/local/cyrus-imapd-2.2.3/tools/masssievec /usr/cyrus/bin/sievec</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="POSTFIX-INSTALL"
></A
>3.5. Getting and installing Postfix</H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN374"
></A
>3.5.1. Download</H3
><P
>                Origin-Site: <A
HREF="http://www.postfix.org/ftp-sites.html"
TARGET="_top"
>http://www.postfix.org/ftp-sites.html</A
>
                </P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN378"
></A
>3.5.2. Creating a User-ID (UID) and Group-ID (GID) for postfix</H3
><P
>        Before you build and install postfix, be sure to create a »postfix« and a »postdrop« user and group if they do not exist on the system. 
		First check for the groups. You can check this by <B
CLASS="COMMAND"
>grep postfix /etc/group</B
> and
		<B
CLASS="COMMAND"
>grep maildrop /etc/group</B
>
        </P
><P
>        If there are no such groups and users, you just create them. Search for a free numeric UID and GID. In the
        following example I will use UID and GID 33333 for Postfix and 33335 for the maildrop UID and GID. These ID's
        correspond to other documents.
        </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>groupadd -g 33333 postfix
groupadd -g 33335 postdrop

useradd -u 33333 -g 33333 -d /dev/null -s /bin/false postfix</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN385"
></A
>3.5.3. Building and installing</H3
><P
>        The following section shows what you have to do if you installed MySQL from source as described above.
        If you installed MySQL from a binary package such as rpm or deb, then you have to change the
        include and library-flags to -I/usr/include/mysql and -L/usr/lib/mysql.
        </P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/caution.gif"
HSPACE="5"
ALT="Caution"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Old MTA needs to be uninstalled</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>It is important that you uninstall any sendmail version from RPM based systems.
	I suggest that you remove sendmail, and install Postfix instead. At least SuSE RPMs need a MTA.
	After installing the Postfix-RPM, just install Postfix over the RPM installation by following the HOWTO.</P
></TD
></TR
></TABLE
></DIV
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>tar -xvzf postfix-2.0.19.tar.gz

cd postfix-2.0.19

make makefiles 'CCARGS=-DHAS_MYSQL \
-I/usr/local/mysql/include/mysql -DUSE_SASL_AUTH \
-I/usr/local/include/sasl -I/usr/local/bdb/include' \
'AUXLIBS=-L/usr/local/mysql/lib/mysql \
-lmysqlclient -lz -lm -L/usr/local/lib -lsasl2 -L/usr/local/bdb/lib'
make
make install</PRE
></FONT
></TD
></TR
></TABLE
><P
>During <B
CLASS="COMMAND"
>make install</B
> a few question are asked. Just pressing 
	<B
CLASS="KEYCAP"
>Enter</B
> should match your needs. For Redhat users it could be useful to 
	enter <TT
CLASS="FILENAME"
>/usr/local/share/man</TT
></P
><P
>Now you need to create some symbolic links to start Postfix automatically on system startup. The sample is 
	for SuSE Linux, please consult your vendors manual for other distributions.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>ln -s /usr/sbin/postfix /etc/init.d/rc3.d/S14postfix
ln -s /usr/sbin/postfix /etc/init.d/rc3.d/K07postfix</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="PAM-INSTALL"
></A
>3.6. Getting and installing PAM</H2
><P
>PAM is installed by default on almost all Linux distributions. I am not describing how to compile PAM
        by yourself, because it could break your system. Instead, I will describe how to install the package. 
        </P
><P
>&#13;	</P
><P
>Users of a RPM based distribution can issue the following command:</P
><P
>&#13;<TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>rpm -i pam-devel.rpm</PRE
></FONT
></TD
></TR
></TABLE
>&#13;</P
><P
>Debian users can install the devel package with the following command:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>apt-get install libpam0g-dev</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="PAM-MYSQL-INSTALL"
></A
>3.7. Getting and installing pam_mysql</H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN409"
></A
>3.7.1. Download</H3
><P
>Origin-Site: <A
HREF="http://sourceforge.net/projects/pam-mysql/"
TARGET="_top"
>			http://sourceforge.net/projects/pam-mysql/</A
>
		</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN413"
></A
>3.7.2. Installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>tar -xvzf pam_mysql-0.5.tar.gz

cd pam_mysql</PRE
></FONT
></TD
></TR
></TABLE
><P
>If you have compiled mysql by yourself, 
	check the <TT
CLASS="FILENAME"
>Makefile</TT
> and enter the correct path to your mysql libs and add the 
	compiler flag <TT
CLASS="VARNAME"
>CFLAGS</TT
> <TT
CLASS="OPTION"
>-I/path/to/mysql/include</TT
>.
	</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>ifndef FULL_LINUX_PAM_SOURCE_TREE
export DYNAMIC=-DPAM_DYNAMIC
export CC=gcc
export CFLAGS=-O2 -Dlinux -DLINUX_PAM \
       -ansi -D_POSIX_SOURCE -Wall -Wwrite-strings \
       -Wpointer-arith -Wcast-qual -Wcast-align -Wtraditional \
       -Wstrict-prototypes -Wmissing-prototypes -Wnested-externs -Winline \
       -Wshadow -pedantic -fPIC -I/usr/local/mysql/include
export MKDIR=mkdir -p
export LD_D=gcc -shared -Xlinker -x -L/usr/local/mysql/lib/mysql -lz
endif</PRE
></FONT
></TD
></TR
></TABLE
><P
>After customizing that file you an go ahead with the pam_mysql compile.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>make

cp pam_mysql.so /lib/security

[[ ! -d /var/lib/mysql ]] &#38;&#38; mkdir /var/lib/mysql
ln -s /tmp/mysql.sock /var/lib/mysql/mysql.sock</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="WEB-CYRADM-INSTALL"
></A
>3.8. Getting and installing Web-cyradm</H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN425"
></A
>3.8.1. Download</H3
><P
>                Origin-Site: <A
HREF="http://www.web-cyradm.org"
TARGET="_top"
>http://www.web-cyradm.org</A
>
                </P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN429"
></A
>3.8.2. Installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local/apache/htdocs

tar -xvzf web-cyradm-0.5.4.tar.gz

touch /var/log/web-cyradm.log
chown nobody /var/log/web-cyradm.log</PRE
></FONT
></TD
></TR
></TABLE
><P
>After unpacking web-cyradm, move it to a place in your webserver's documentroot.</P
><P
>Thats all. Now you need to configure the whole bunch of software.</P
><P
>Web-cyradm 0.5.4 is considered stable, and was released on 2003-12-05</P
><P
>Since web-cyradm uses PEAR for its database abstraction layer, you also need a recent 
	copy of PEAR. This is included in recent PHP Versions. I strongly suggest to update PHP 
	to 4.3.4, because a lot of important bugs have been fixed.
	</P
><P
>A frequent mistake is to forget to touch the logfile and change the owner to the 
	Apache UID. This is usually »nobody« or »wwwrun«.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="MYSQL-CREATE-DB"
></A
>3.8.3. Create the databases and tables</H3
><P
>Now we need to create the database and tables for Postfix and Web-cyradm and add a user to the
                database.</P
><P
>                Web-cyradm comes with several MySQL scripts: <TT
CLASS="FILENAME"
>insertuser_mysql.sql</TT
> and
                <TT
CLASS="FILENAME"
>create_mysql.sql</TT
>.
                The first inserts the Database user to the database »mysql« and creates the database »mail«. The
                second creates the required tables and populates the database with an initial admin-user and the
                cyrus user.</P
><P
>The other scripts are used for incremental upgrading from older releases.</P
><P
>The password for the database user »mail« in this example is »secret«. Please insert whatever
                user and password you like.</P
><P
>The username for the initial superuser is »admin« with the password »test«.</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/caution.gif"
HSPACE="5"
ALT="Caution"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Change the default password!</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>If a malicious user wants to gain unauthorized access to a system, the first attempt is always
                the default username and password supplied by the vendor. It is IMPORTANT that you change them
                in the scripts before applying them.</P
></TD
></TR
></TABLE
></DIV
><P
>After customizing the username and password, apply the scripts:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>/usr/local/mysql/bin/mysql -u root -p &#60; \
/usr/local/apache/htdocs/web-cyradm/scripts/insertuser_mysql.sql

/usr/local/mysql/bin/mysql mail -u mail -p &#60; \
/usr/local/apache/htdocs/web-cyradm/scripts/create_mysql.sql</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="WEB-CYRADM-UPDATE"
></A
>3.8.4. Upgrading from 0.5.3 to 0.5.4</H3
><P
>In version 0.5.4 there is a small database enhancement. You can upgrade your database by
	issuing the MySQL script that comes with the distribution.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>mysql mail -u mail -p &#60; \ 
scripts/upgrade-0.5.3-to-0.5.4_mysql.sql</PRE
></FONT
></TD
></TR
></TABLE
><P
>Since Version 0.5.3 web-cyradm has full support for DES crypted passwords. You can use the php-script 
<TT
CLASS="FILENAME"
>migrate.php</TT
> to convert the users passwords from plain text to unix compatible crypt (DES).</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/caution.gif"
HSPACE="5"
ALT="Caution"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Migration from plain to crypt cannot be undone</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>Be sure to have a recent backup of your database before doing anything with the migration script.</P
></TD
></TR
></TABLE
></DIV
></DIV
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="MYSQL-CONFIG"
></A
>4. Configuring MySQL</H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="MYSQL-CONFIG-SECURING"
></A
>4.1. Securing MySQL</H2
><P
>Because you are using MySQL to authenticate users, you need to restrict network access 
	to port 3306.</P
><P
>The easiest way is to only bind MySQL to the loopback interface 127.0.0.1. 
	This makes sure nobody can connect to your MySQL daemon via the network.</P
><P
>	Edit <TT
CLASS="FILENAME"
>/etc/init.d/mysql.server</TT
> and change line 107 as following:</P
><P
>Original line:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$bindir/safe_mysqld --datadir=$datadir --pid-file=$pid_file&#38;</PRE
></FONT
></TD
></TR
></TABLE
><P
>Changed line:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$bindir/safe_mysqld --datadir=$datadir --pid-file=$pid_file \
--bind-address=127.0.0.1&#38;</PRE
></FONT
></TD
></TR
></TABLE
><P
>Restart your MySQL daemon by issuing the command<B
CLASS="COMMAND"
>/etc/init.d/mysql.server start</B
></P
><P
>To ensure the configuration change was successful, <B
CLASS="COMMAND"
>netstat -an|grep LISTEN</B
>. The 
	Output should be looking similar to this:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>bond:~ # netstat -an|grep LISTEN
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="MYSQL-RINETD"
></A
>4.2. Setting up rinetd</H2
><P
>This step is only necessary if you run the MySQL sever on host other than the mail server. This allows
	you to securely connect from another host since access is allowed only from pre-defined IP addresses.</P
><P
>The example used is from the view of the host serving the MySQL database. Lets assume your 
	mail server has the IP 192.168.0.100 and the MySQL host has 192.168.0.200</P
><P
>	Edit <TT
CLASS="FILENAME"
>/etc/rinetd.conf</TT
> and add:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>192.168.0.200 3306 127.0.0.1 3306
allow 192.168.0.100</PRE
></FONT
></TD
></TR
></TABLE
><P
>This means: The MySQL host is listening on 192.168.0.200 port 3306. If 192.168.0.100 
	attempts a connection, it is forwarded to 127.0.0.1:3306. All other hosts are rejected. </P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="PAM-CONFIG"
></A
>5. Configuring PAM</H1
><P
>Now we need to get sure that PAM knows how to authenticate the Cyrus users</P
><P
>You have to create the file <TT
CLASS="FILENAME"
>/etc/pam.d/imap</TT
> with the following entries:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>auth sufficient pam_mysql.so user=mail passwd=secret host=localhost db=mail table=accountuser usercolumn=username passwdcolumn=password crypt=1 logtable=log logmsgcolumn=msg logusercolumn=user loghostcolumn=host logpidcolumn=pid logtimecolumn=time

auth sufficient pam_unix_auth.so

account required pam_mysql.so user=mail passwd=secret host=localhost db=mail table=accountuser usercolumn=username passwdcolumn=password crypt=1 logtable=log logmsgcolumn=msg logusercolumn=user loghostcolumn=host logpidcolumn=pid logtimecolumn=time

account  sufficient       pam_unix_acct.so</PRE
></FONT
></TD
></TR
></TABLE
><P
>The lines containing <TT
CLASS="OPTION"
>pam_unix_auth.so</TT
> and <TT
CLASS="OPTION"
>pam_unix_acct.so</TT
>
	 are only needed if you are migrating from WU-IMAP to Cyrus. 
	This allows you to authenticate with its old unix-password AND its new mysql-based password.</P
><P
>To use the other services provided by cyrus and smtp-authtication you need to copy the file
	so that they match the service-ID</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cp /etc/pam.d/imap /etc/pam.d/pop
cp /etc/pam.d/imap /etc/pam.d/sieve
cp /etc/pam.d/imap /etc/pam.d/smtp</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="POSTFIX-CONFIG"
></A
>6. Configuring Postfix</H1
><P
>Postfix needs two major config files: <TT
CLASS="FILENAME"
>main.cf</TT
> and <TT
CLASS="FILENAME"
>master.cf</TT
>. 
	Both need your attention.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="POSTFIX-MASTER"
></A
>6.1. master.cf</H2
><P
>You need to change just one line:</P
><P
>old: </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>flags=R user=cyrus argv=/cyrus/bin/deliver -e -m ${extension} ${user}</PRE
></FONT
></TD
></TR
></TABLE
><P
>new: </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>flags= user=cyrus argv=/usr/cyrus/bin/deliver -r ${sender} -m ${extension} ${user}</PRE
></FONT
></TD
></TR
></TABLE
><P
>	What does that change affect?
	</P
><P
>	A look to the cyrus man-pages <B
CLASS="COMMAND"
>man deliver </B
>clears up that issue:
	</P
><P
>	The Postfix default setup uses a wrong path to cyrus deliver, this is the first change.
	The parameter »-r« inserts a proper return path. Without that, mail rejected/retured by sieve will 
	be sent to the cyrus user at yourdomain.
	</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="POSTFIX-MAIN"
></A
>6.2. main.cf</H2
><P
>Here you need to change some more things like hostname, relaying, alias-lookups etc.</P
><P
>First change the hostname:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>myhostname = foo.bar.org</PRE
></FONT
></TD
></TR
></TABLE
><P
>mydestination</P
><P
>Here you have to put all domainnames that are local (corresponding to sendmail's 
<TT
CLASS="FILENAME"
>/etc/mail/sendmail.cw)</TT
>. If you have multiple domains, separate them with comma.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>mydestination = foo.bar.org, example.com, furchbar-grausam.ch, 
 whatever.domain.tld, mysql:/etc/postfix/mysql-mydestination.cf</PRE
></FONT
></TD
></TR
></TABLE
><P
>Relayhost</P
><P
>Here you define where to deliver outgoing mails. If you do not provide any host, mail is delivered directly 
to the destination smtp host. Usually your relayhosts are your internet service provider's smtp server.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>relayhost = relay01.foobar.net relay02.foobar.net relay03.foobar.net</PRE
></FONT
></TD
></TR
></TABLE
><P
>Mailtransport</P
><P
>Here you define how the mails accepted for local delivery should be handled. In your situation, mail should be 
delivered by the cyrus delivery program.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>mailbox_transport = cyrus</PRE
></FONT
></TD
></TR
></TABLE
><P
>At the end of file you need to add:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>virtual_alias_maps = hash:/etc/postfix/virtual, mysql:/etc/postfix/mysql-virtual.cf</PRE
></FONT
></TD
></TR
></TABLE
><P
>If you don't want to have a overriding /etc/postfix/virtual, skip the hash entry</P
><P
>Outgoing addresses should be rewritten from test0002 at domain 
to user.name at virtualhost.com. This is important if you want to use a webmail interface.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>sender_canonical_maps = mysql:/etc/postfix/mysql-canonical.cf </PRE
></FONT
></TD
></TR
></TABLE
><P
>Now you need to create the file <TT
CLASS="FILENAME"
>/etc/postfix/mysql-virtual.cf</TT
>: </P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>#
# mysql config file for alias lookups on postfix
# comments are ok.
#

# the user name and password to log into the mysql server
hosts = localhost
user = mail
password = secret

# the database name on the servers
dbname = mail

# the table name
table = virtual

#
select_field = dest
where_field = alias
additional_conditions = and status = '1'</PRE
></FONT
></TD
></TR
></TABLE
><P
>The file <TT
CLASS="FILENAME"
>/etc/postfix/mysql-canonical.cf</TT
>:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
># mysql config file for canonical lookups on postfix
# comments are ok.
#

# the user name and password to log into the mysql server
hosts = localhost
user = mail
password = secret

# the database name on the servers
dbname = mail

# the table name
table = virtual
#
select_field = alias
where_field = username
# Return the first match only
additional_conditions = and status = '1' limit 1</PRE
></FONT
></TD
></TR
></TABLE
><P
>Finally the file <TT
CLASS="FILENAME"
>/etc/postfix/mysql-mydestination.cf</TT
>:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
># mysql config file for local domain (like sendmail's sendmail.cw) lookups on postfix
# comments are ok.
#

# the user name and password to log into the mysql server
hosts = localhost
user = mail
password = secret

# the database name on the servers
dbname = mail

# the table name
table = domain
#
select_field = domain_name
where_field = domain_name</PRE
></FONT
></TD
></TR
></TABLE
><P
>SMTP Authentication with SASL and PAM</P
><P
>Put the following in your <TT
CLASS="FILENAME"
>/etc/postfix/main.cf</TT
></P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>smtpd_sasl_auth_enable = yes
smtpd_recipient_restrictions = permit_sasl_authenticated, permit_mynetworks, reject_unauth_destination
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = 
broken_sasl_auth_clients = yes</PRE
></FONT
></TD
></TR
></TABLE
><P
>You also need to create the file <TT
CLASS="FILENAME"
>/usr/local/lib/sasl2/smtpd.conf</TT
> with
the following contents:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>pwcheck_method: saslauthd</PRE
></FONT
></TD
></TR
></TABLE
><P
>The next step is to tell postfix how to find the saslauthd socket:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>mv /var/run/sasl2 /var/run/sasl2-old
ln -s /var/run/saslauthd /var/run/sasl2</PRE
></FONT
></TD
></TR
></TABLE
><P
></P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="ANTISPAM"
></A
>6.3. Fighting against SPAM</H2
><P
>This section describes how to implement a basic SPAM protection setup with postfix. It does not use any external software like spamassassin, etc.</P
><P
>Postfix has some built-in filters that allow you to stop obvious SPAM attempts. In particular these are:</P
><P
></P
><UL
><LI
><P
>	smtpd_helo_required = yes
	</P
><P
>	This switch in <TT
CLASS="FILENAME"
>main.cf</TT
> means that SMTP clients connecting to your mail server must give 
	a »helo« when connecting.
	</P
></LI
><LI
><P
>	smtpd_recipient_restrictions
	</P
><P
>This option in <TT
CLASS="FILENAME"
>main.cf</TT
> lets you define different rules on the handling the acceptance 
	of mail. The following example simply rejects all invalid sender and recipient data. 
	Additionally it defines how to lookup known spammers from online blacklists.
	</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>smtpd_recipient_restrictions =
            reject_invalid_hostname,
            reject_non_fqdn_hostname,
            reject_non_fqdn_sender,
            reject_non_fqdn_recipient,
            reject_unknown_sender_domain,
            reject_unknown_recipient_domain,
            reject_unauth_pipelining,
            permit_mynetworks,
            reject_unauth_destination,
            reject_rbl_client zombie.dnsbl.sorbs.net,
            reject_rbl_client relays.ordb.org,
            reject_rbl_client opm.blitzed.org,
            reject_rbl_client list.dsbl.org,
            reject_rbl_client sbl.spamhaus.org,
            permit</PRE
></FONT
></TD
></TR
></TABLE
><P
></P
></LI
><LI
><P
>mime_header_checks=pcre:/etc/postfix/body_checks</P
><P
>MIME header checks let you reject mail which contains malicious MIME content, i.e dangerous 
	attachments such as Windows executables. Create the file <TT
CLASS="FILENAME"
>/etc/postfix/body_checks</TT
>. 
	The following example rejects all mail that contains potentially dangerous attachments. 
	In my experience, using this example would filter out most of viruses delivered by e-mail. 
	In any event, a virus scanner should always be installed.
	</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>	/^((Content-(Disposition: attachment;|Type:).*|\ +)| *)(file)?name\ *=\ *"?.*\.(lnk|asd|hlp|ocx|reg|bat|c[ho]m|cmd|exe|dll|vxd|pif|scr|hta|jse?|sh[mbs]|vb[esx]|ws[fh]|wmf)"?\ *$/      REJECT  attachment type not allowed
	</PRE
></FONT
></TD
></TR
></TABLE
></LI
></UL
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="CYRUS-CONFIG"
></A
>7. Configuring Cyrus IMAP</H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="CYRUS-CONFIGFILES"
></A
>7.1. Creating the config files</H2
><P
>You have to create <TT
CLASS="FILENAME"
>/etc/imapd.conf</TT
> and <TT
CLASS="FILENAME"
>/etc/cyrus.conf</TT
>
   </P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="ETC-SERVICES"
></A
>7.1.1. <TT
CLASS="FILENAME"
>/etc/services</TT
></H3
><P
>If you like to use sieve (a mail filtering language), you must change an entry
in <TT
CLASS="FILENAME"
>/etc/services</TT
>. With SuSE 8.0 take especially care about the port for sieve, 
they defined the wrong port. Add or change the following lines:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>pop3		110/tcp
imap		143/tcp
imaps           993/tcp
pop3s           995/tcp 
sieve           2000/tcp</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="ETC-IMAPD"
></A
>7.1.2. <TT
CLASS="FILENAME"
>/etc/imapd.conf</TT
></H3
><P
>Be sure »servername« contains your FQHN (Fully Qualified Hostname)</P
><P
>The parameter »unixhierarchysep: yes« is only used if you like to have usernames 
like »hans.mueller.somedomain.tld« see <A
HREF="#WEB-CYRADM-CONFIG"
>Section 8</A
> for more info.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>postmaster: postmaster
configdirectory: /var/imap
partition-default: /var/spool/imap
# admins: cyrus # no admins!
allowanonymouslogin: no
allowplaintext: yes
sasl_mech_list: PLAIN
servername: servername
autocreatequota: 10000
reject8bit: no
quotawarn: 90
timeout: 30
poptimeout: 10
dracinterval: 0
drachost: localhost
sasl_pwcheck_method: saslauthd
sievedir: /usr/sieve
sendmail: /usr/sbin/sendmail
sieve_maxscriptsize: 32
sieve_maxscripts: 5
#unixhierarchysep: yes</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="ETC-IMAPD-LOCAL"
></A
>7.1.3. <TT
CLASS="FILENAME"
>/etc/imapd-local.conf</TT
></H3
><P
>Be sure »servername« contains your FQHN (Fully Qualified Hostname)</P
><P
>The parameter »unixhierarchysep: yes« is only used if you like to have usernames 
like »hans.mueller.somedomain.tld« see <A
HREF="#WEB-CYRADM-CONFIG"
>Section 8</A
> for more info.</P
><P
>This second file ensures, that admin users only can connect via localhost. Decide by yourself if this additional security feature is needed for your site.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>postmaster: postmaster
configdirectory: /var/imap
partition-default: /var/spool/imap
admins: cyrus 
allowanonymouslogin: no
allowplaintext: yes
sasl_mech_list: PLAIN
servername: servername
autocreatequota: 10000
reject8bit: no
quotawarn: 90
timeout: 30
poptimeout: 10
dracinterval: 0
drachost: localhost
sasl_pwcheck_method: saslauthd
sievedir: /usr/sieve
sendmail: /usr/sbin/sendmail
sieve_maxscriptsize: 32
sieve_maxscripts: 5
#unixhierarchysep: yes</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="TLS"
></A
>7.1.4. Creating the TLS/SSL Certificate</H3
><P
>If you want to enable Cyrus' TLS/SSL facilities, you have to create a certificate first. This requires an 
OpenSSL installation</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>openssl req -new -nodes -out req.pem -keyout key.pem  
openssl rsa -in key.pem -out new.key.pem
openssl x509 -in req.pem -out ca-cert -req \
-signkey new.key.pem -days 999 

mkdir /var/imap

cp new.key.pem /var/imap/server.pem
rm new.key.pem
cat ca-cert &#62;&#62; /var/imap/server.pem

chown cyrus:mail /var/imap/server.pem
chmod 600 /var/imap/server.pem # Your key should be protected

echo tls_ca_file: /var/imap/server.pem &#62;&#62; /etc/imapd.conf
echo tls_cert_file: /var/imap/server.pem &#62;&#62; /etc/imapd.conf
echo tls_key_file: /var/imap/server.pem &#62;&#62; /etc/imapd.conf&#13;</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="ETC-CYRUS-CONF"
></A
>7.1.5. <TT
CLASS="FILENAME"
>/etc/cyrus.conf</TT
></H3
><P
>The other file you need to create is <TT
CLASS="FILENAME"
>/etc/cyrus.conf</TT
>
It is the configuration file for the Cyrus master process.  It defines the startup procedures, services
and events to be spawned by  process »master«.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
># standard standalone server implementation

START {
  # do not delete this entry!
  recover       cmd="ctl_cyrusdb -r"

  # this is only necessary if using idled for IMAP IDLE
#  idled                cmd="idled"
}

# UNIX sockets start with a slash and are put into /var/imap/socket
SERVICES {
  # add or remove based on preferences
  imap          cmd="imapd" listen="192.168.0.1:imap" prefork=0
  imaplocal     cmd="imapd -C /etc/imapd-local.conf" listen="127.0.0.1:imap" prefork=0
  imaps         cmd="imapd -s" listen="192.168.0.1:imaps" prefork=0
  imapslocal    cmd="imapd -C /etc/imapd-local.conf" listen="127.0.0.1:imaps" prefork=0
  pop3          cmd="pop3d" listen="pop3" prefork=0
  pop3s         cmd="pop3d -s" listen="pop3s" prefork=0
  sieve         cmd="timsieved" listen="192.168.0.1:sieve" prefork=0
  sievelocal    cmd="timsieved -C /etc/imapd-local.conf listen="127.0.0.1:sieve" prefork=0

  # at least one LMTP is required for delivery
#  lmtp         cmd="lmtpd" listen="lmtp" prefork=0
  lmtpunix      cmd="lmtpd" listen="/var/imap/socket/lmtp" prefork=0

  # this is only necessary if using notifications
#  notify       cmd="notifyd" listen="/var/imap/socket/notify" proto="udp" prefork=1
}

EVENTS {
  # this is required
  checkpoint    cmd="ctl_cyrusdb -c" period=30

  # this is only necessary if using duplicate delivery suppression
  delprune      cmd="ctl_deliver -E 3" period=1440

  # this is only necessary if caching TLS sessions
  tlsprune      cmd="tls_prune" period=1440
}</PRE
></FONT
></TD
></TR
></TABLE
><DIV
CLASS="TIP"
><P
></P
><TABLE
CLASS="TIP"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/tip.gif"
HSPACE="5"
ALT="Tip"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Please check your Systems IP address</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>In the example above the IP 192.168.0.1 is to be replaced with your systems external IP address.</P
></TD
></TR
></TABLE
></DIV
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="CYRUS-DIRECTORIES"
></A
>7.2. Creating the directories</H2
><P
>There must be created different directories. Additionally you should 
change some attributes of the filesystem</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="VAR-IMAP"
></A
>7.2.1. <TT
CLASS="FILENAME"
>/var/imap</TT
></H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /var
mkdir imap
chown cyrus:mail imap
chmod 750 imap</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="VAR-SPOOL-IMAP"
></A
>7.2.2. <TT
CLASS="FILENAME"
>/var/spool/imap</TT
></H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /var/spool
mkdir imap
chown cyrus:mail imap
chmod 750 imap</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="USR-SIEVE"
></A
>7.2.3. <TT
CLASS="FILENAME"
>/usr/sieve</TT
></H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr
mkdir sieve
chown cyrus:mail sieve
chmod 750 sieve</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="OTHER-DIRS"
></A
>7.2.4. The rest of the directories</H3
><P
>The rest of the directories can be created by the tool <B
CLASS="COMMAND"
>mkimap</B
></P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>su - cyrus
/usr/local/cyrus-imapd-2.1.12/tools/mkimap</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="CH-ATTRIB"
></A
>7.3. Changing the filesystem attributes</H2
><P
>When using the ext2 filesystem, you must set an attribute, that defines, that all changes 
are immediately committed to the disk. With todays journaling filesystems there is no need. 
If you are still running ext2 filesystems, I strongly suggest to switch to ext3 filesystems. 
Ext2 and ext3 are fully compatible to each other.</P
><P
>To check what type of filesystem is used for <TT
CLASS="FILENAME"
>/var</TT
> issue the
command <B
CLASS="COMMAND"
>mount</B
> or see your <TT
CLASS="FILENAME"
>/etc/fstab</TT
>. Please note
that the <TT
CLASS="FILENAME"
>/var</TT
> could also be a part of the root or other filesystem.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /var/imap

chattr +S user quota user/* quota/*
chattr +S /var/spool/imap /var/spool/imap/*</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="WEB-CYRADM-CONFIG"
></A
>8. Configuring Web-cyradm</H1
><P
>First copy the distribution's config file, and create the logfile. The logfile must be owned by the user
that runs the webserver. This is usually the user »nobody« or »wwwrun«.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local/apache/htdocs/web-cyradm/config

cp conf.php.dist conf.php

touch /var/log/web-cyradm-login.log
chown nobody /var/log/web-cyradm-login.log</PRE
></FONT
></TD
></TR
></TABLE
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN645"
></A
>8.1. Cyrus setup</H2
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>#The Cyrus login stuff
$CYRUS = array(
        'HOST'  =&#62; 'localhost',
        'PORT'  =&#62; 143,
        'ADMIN' =&#62; 'cyrus',
        'PASS'  =&#62; 'secret'
);</PRE
></FONT
></TD
></TR
></TABLE
><P
>This should be self-explanatory. Please note there is no support for SSL connections at the moment, 
this is especially important for users that would like to have web-cyradm on a different server
from the server running cyrus-imapd ..</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN649"
></A
>8.2. Database setup</H2
><P
>	Since version 0.5.2 web-cyradm uses PEAR as a database abstraction layer. This adds more flexibility. 
	MySQL and PostgreSQL are currently supported. Please note that a patch is required for PostgreSQL 
	because Postfix does not support PostgreSQL natively. I strongly suggest that you use MySQL.
        I know MySQL has some restrictions on transactions and stuff, but it is supported in the distributed Postfix code.
	</P
><P
>The entries should be self explanatory</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$DB = array(
        'TYPE'  =&#62; 'mysql',
        'USER'  =&#62; 'mail',
        'PASS'  =&#62; 'secret',
        'PROTO' =&#62; 'unix',      // set to "tcp" for TCP/IP
        'HOST'  =&#62; 'localhost',
        'NAME'  =&#62; 'mail'
);</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN654"
></A
>8.3. Default Quota</H2
><P
>	The default quota to be used is set in the variable <TT
CLASS="VARNAME"
>DEFAULT_QUOTA=20000</TT
> and is used when 
	creating a new domain</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN658"
></A
>8.4. Crypted passwords</H2
><P
>Web-cyradm supports the storage of encrypted passwords. I strongly suggest the use of encryption.
	There are three methods supported at the moment: Unix-compatible (crypt), md5 and MySQL.
	The Unix-compatible encryption allows you to import encrypted passwords from an 
	existing <TT
CLASS="FILENAME"
>/etc/shadow</TT
>. This is the preferred option.
	</P
><P
>	Unfortunately, MySQL uses a proprietary encryption method which is only available
	when using MySQL. I'm currently thinking about dropping support for MySQL crypt, because it only
	works with MySQL and makes a migration to another database impossible. As soon as there is a method available
	to re-engineer the MySQL crypt on PHP there will be a solution (Help needed in programming, legal constraints?)
	</P
><P
>Check the variable <TT
CLASS="VARNAME"
>$CRYPT</TT
> in the file <TT
CLASS="FILENAME"
>config.inc.php</TT
>. 
	Value »plain« means no encryption, »crypt« means Shadow compatible encryption, 
	mysql means MySQL encryption.</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/caution.gif"
HSPACE="5"
ALT="Caution"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Choose encryption method carefully</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>	Since the supported encryption methods are all one-way encryptions, there will be NO WAY to migrate from
	one to another. Note also, that this is a global variable, it is used for all passwords,
	including the password of the admin users. I STRONGLY suggest the use of Unix Shadow compatible encryption,
	because it makes you independent of any software vendor.
	</P
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AEN669"
></A
>8.5. Usernames</H2
><P
>	There are two username schemes supported which are defined in the variable »DOMAIN_AS_PREFIX«.
	The default is to have a defined prefix ($DOMAIN_AS_PREFIX=0), i.e. »test« for the domain »expample.com«.
	With this scheme, the first user gets the username test0001, the second test0002 and incrementing.
	</P
><P
>The other one is to have usernames like »hans.mueller.example.com«. 
	If that case set $DOMAIN_AS_PREFIX=1</P
><P
>At the moment you can not mix both schemas, evaluate carefully with scheme matches your needs best</P
><P
>If you choose to have $DOMAIN_AS_PREFIX=1, be sure you uncomment the 
	option <TT
CLASS="OPTION"
>unixhierarchysep: yes</TT
> like described in <A
HREF="#ETC-IMAPD"
>Section 7.1.2</A
></P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="TEST"
></A
>9. Testing the setup</H1
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="TEST-RUNNING"
></A
>9.1. (Re-)Starting the daemons</H2
><P
>Now all the software has been installed and configured. Lets do some testings now. 
First you have to (re-)start all the daemons affected </P
><P
></P
><UL
><LI
><P
>	<B
CLASS="COMMAND"
>postfix start</B
>
     </P
></LI
><LI
><P
>        <B
CLASS="COMMAND"
>/etc/init.d/cyrus start</B
>
     </P
></LI
><LI
><P
>        <B
CLASS="COMMAND"
>/etc/init.d/mysql.server start</B
>
     </P
></LI
><LI
><P
>        <B
CLASS="COMMAND"
>/usr/local/apache/bin/apachectl startssl</B
>
     </P
></LI
></UL
><P
>Hopefully all daemons started without any complaints. Note that this is assuming saslauthd is started 
in the cyrus startup script.</P
><P
>Now you can verify if the daemons are running properly by issuing 
<B
CLASS="COMMAND"
>netstat -an|grep LISTEN</B
></P
><P
>The output should look similar like that:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>bond:~ # netstat -an|grep LISTEN
tcp        0      0 0.0.0.0:993             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:995             0.0.0.0:*               LISTEN
tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:110             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:143             0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:2000            0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:25              0.0.0.0:*               LISTEN
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN</PRE
></FONT
></TD
></TR
></TABLE
><P
>The port are assigned like this:</P
><P
></P
><UL
><LI
><P
>	993	imap-ssl
     </P
></LI
><LI
><P
>        995     pop3-ssl
     </P
></LI
><LI
><P
>        3306     mysql
     </P
></LI
><LI
><P
>        110     pop3
     </P
></LI
><LI
><P
>        143     imap
     </P
></LI
><LI
><P
>        2000     sieve
     </P
></LI
><LI
><P
>        80     http
     </P
></LI
><LI
><P
>        25     smtp
     </P
></LI
><LI
><P
>        443     https
     </P
></LI
></UL
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="TESTING-WEB-CYRADM"
></A
>9.2. Testing Web-cyradm</H2
><P
>Now you should be able to connect to <A
HREF="http://localhost/web-cyradm/"
TARGET="_top"
>http://localhost/web-cyradm/</A
>
Login with the credentials defined before.</P
><P
>Define a domainname and some accounts. Be sure the domainname belongs to your server. 
If not you have to fake it by enter the domain in <TT
CLASS="FILENAME"
>/etc/hosts</TT
>. 
The domain must also be defined as local in 
<TT
CLASS="FILENAME"
>/etc/postfix/main.cf</TT
> (mydestination = domain)</P
><P
>Please be sure that you are providing a unique domain prefix when adding a new domain. I.e. test for the domain
test.org. If you don't provide such a prefix you will get a error message.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="TESTING-POSTFIX"
></A
>9.3. Testing postfix</H2
><P
>Now we are going to write a mail:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>telnet localhost 25
Trying ::1...
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mail ESMTP Postfix

helo localhost
250 mail
mail from: testing at example.com
250 Ok
rcpt to: tester at localhost
250 Ok

data
354 End data with &#60;CR&#62;&#60;LF&#62;.&#60;CR&#62;&#60;LF&#62;
some text
.
250 Ok: queued as B58E141D33

quit</PRE
></FONT
></TD
></TR
></TABLE
><P
>If you see such a message, then all seems to work fine. Be sure to specify a recipients 
address you previously defined in the web-cyradm database</P
><P
>If you get an error like this:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>rcpt to: tester at localhost
451 &#60;tester  at localhost&#62;: Temporary lookup failure</PRE
></FONT
></TD
></TR
></TABLE
><P
>Then either MySQL is not running, DB permission are not set properly or you 
miss-configured <TT
CLASS="FILENAME"
>/etc/postfix/main.cf</TT
></P
><P
>On any errors, I suggest to examine <TT
CLASS="FILENAME"
>/var/log/mail</TT
>. Often you will find 
some hints whats went wrong.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="TESTING-CYRUS"
></A
>9.4. Testing the IMAP functionality</H2
><P
>A lot of users like to test the cyrus-IMAPd with the Command Line Interface (CLI) »cyradm« and they are failing.
To be successful with cyradm, you will need to add the cyrus user to <TT
CLASS="FILENAME"
>/etc/sasldb2</TT
> 
because »cyradm« always authenticates against SASL AND IMAP.</P
><P
>To add the Cyrus user to the sasldb use the command:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>saslpasswd2 -c cyrus
Password: (enter your passwd)
Again (for verification): (enter your password)</PRE
></FONT
></TD
></TR
></TABLE
><P
>To use the »cyradm« CLI please take care that the tool does not recognize standard CLI-options 
like -u and similar. Please follow the syntax like described in the man page »cyradm 1« like the 
following example:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>bond:~ # cyradm --user cyrus --server localhost --auth plain
Password: # This is the SASL2 password
IMAP Password: # This is the IMAP password that you need to enter in the mysql-table »accountusers«
localhost&#62;</PRE
></FONT
></TD
></TR
></TABLE
><P
>With the Cyrus command <B
CLASS="COMMAND"
>help</B
> you will see all possible commands and its abbreviations.</P
><P
>To make that kind of tests. you just need a mailclient like kmail or netscape
(Yes of course, M$-Products are working as well) but in this example I'm using kmail.</P
><DIV
CLASS="FIGURE"
><A
NAME="AEN752"
></A
><P
><B
>Figure 3. Creating a new account</B
></P
><P
><IMG
SRC="imap-account.png"></P
></DIV
><P
>If you enabled TLS/SSL, you may wish to test also the following:</P
><DIV
CLASS="FIGURE"
><A
NAME="AEN756"
></A
><P
><B
>Figure 4. Testing TLS/SSL functionality</B
></P
><P
><IMG
SRC="imap-tls.png"></P
></DIV
><P
>If login fails, and you are sure, you typed the right password, take care that MySQL is running.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="SPAM-AND-VIRUS-INTRO"
></A
>10. Fighting against Viruses and SPAM</H1
><P
>This chapter is optional and describes HOWTO fight against Viruses and SPAM.</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="BRIEF-VIRUS"
></A
>10.1. Brief introdcution to viruses</H2
><P
>I think I do not need to explain how dangerous Viruses are. Unfortunately in the most recent attacks from SCO.A (aka MyDoom) also more or less experienced users get tricked by viruses. Most of todays viruses and worms comes via the internet, most of them via E-Mail. Needless to say, that viruses should be catched by the SMTP system if possible.</P
><DIV
CLASS="CAUTION"
><P
></P
><TABLE
CLASS="CAUTION"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
><IMG
SRC="../images/caution.gif"
HSPACE="5"
ALT="Caution"></TD
><TH
ALIGN="LEFT"
VALIGN="CENTER"
><B
>Not a substitute</B
></TH
></TR
><TR
><TD
>&nbsp;</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>A mailsystem that filters viruses is NEVER a substitute for a local installed anti-virus software. E-Mails are only one way how viruses can penetrate computers.</P
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="BRIEF-SPAM"
></A
>10.2. Brief introduction to SPAM</H2
><P
>The other harmless but unwanted and disturbing E-Mails are SPAM e-mails. SPAM is originally a disgusting canned meat. It is a synonym for UCE (Unsolicited Commercial Email) and UBE (Unsolicited Bulk Email).&#13;</P
><P
>Studies claim, that up to 60 percent of the worldwide e-mail traffic is SPAM. Before I installed the anti-SPAM filters on my SMTP servers, I received about 150 SPAMS's a day. One reason is this document. In ancient time, I noticed my real e-mail address unprotected. E-mail harvesters are scanning websites allover the world for addresses, and try to deliver its commercial, often illegal offers.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="STRATEGY-VIRUSES"
></A
>10.3. Strategy against viruses</H2
><P
>The strategy against viruses is pretty forward: Filtering viruses delivered via e-mail and having a localally installed anti-virus software.</P
><P
>Almost all vendors of anti-virus software have a up-to-date version for Linux and Unix Systems, because most SMTP servers are running on Unix. In this document I'll explain HOWTO implement <A
HREF="http://www.clamav.net"
TARGET="_top"
>clamav</A
>, a very active open source anti virus project.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="STRATEGY-SPAM"
></A
>10.4. Strategy against SPAM</H2
><P
>Fighting against SPAM is much more difficult than viruses. Why? It is because every virus has a unique signature. SPAM can contain arbitrary content. Some of the SPAM is in english, other is korean, other is in "you-name-it-language".</P
><P
>The best method how to prevent SPAM is to handle your e-mail address as your best treasured secret. NEVER put your address in a web-form or put it on your website. I know, that is against the idea of the internet. Information must be free. You can keep publishing your e-mail address if you implement the configuration further below.&#13;</P
><P
>In the beginning of SPAM, filtering for keywords like »viagra« was enough. Todays SPAM techniques are much more sophisticated. It is a war between users and spammers. The solution against sophisticated SPAM is even more sophisticated anti-spam software.Todays anti-spam software checks e-mail for more than just keywords. They are checking for specific mail-header data etc. Also a technique called <A
HREF="http://en.wikipedia.org/wiki/Epistemic_probability"
TARGET="_top"
>bayesian</A
> filters which can learn from particular input, distributed checksum networks etc.</P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="INSTALLING-ANTI-SPAM"
></A
>11. The software needed against viruses and SPAM</H1
><P
>This chapter describes how to install and handle the software against viruses and SPAM</P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="GET-CLAMAV"
></A
>11.1. Getting and installing ClamAV</H2
><DIV
CLASS="SECT3"
><H3
CLASS="SECT3"
><A
NAME="AEN789"
></A
>11.1.1. Download</H3
><P
>	Origin-Site: <A
HREF="http://prdownloads.sourceforge.net/clamav/clamav-0.68.tar.gz"
TARGET="_top"
>http://prdownloads.sourceforge.net/clamav/clamav-0.68.tar.gz</A
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN793"
></A
>11.1.2. Building and installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
># Adding a group for the clamav user
groupadd clamav

# Adding the clamav user to your system
useradd -g clamav -c "clamav user" clamav

cd /usr/local

tar -xvzf clamav-0.68.tar.gz
cd clamav-0.68

./configure

make &#38;&#38; make install</PRE
></FONT
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN796"
></A
>11.1.3. Testing and configuring</H3
><P
>To test the funtionality of clamav, you can run <B
CLASS="COMMAND"
>clamscan</B
> to get some results from the testpatterns that are included in the clamav distribution run <B
CLASS="COMMAND"
>clamscan -r -i /usr/local/clamav-0.68</B
></P
><P
>The output should look like this:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>/usr/local/clamav-0.68/test/test1: ClamAV-Test-Signature FOUND
/usr/local/clamav-0.68/test/test1.bz2: ClamAV-Test-Signature FOUND
/usr/local/clamav-0.68/test/test2.zip: ClamAV-Test-Signature FOUND
/usr/local/clamav-0.68/test/test2.badext: ClamAV-Test-Signature FOUND
/usr/local/clamav-0.68/contrib/clamdwatch/clamdwatch.tar.gz: Eicar-Test-Signature FOUND

----------- SCAN SUMMARY -----------
Known viruses: 20482
Scanned directories: 47
Scanned files: 406
Infected files: 5
Data scanned: 5.48 MB
I/O buffer size: 131072 bytes
Time: 2.706 sec (0 m 2 s)</PRE
></FONT
></TD
></TR
></TABLE
><P
>Next step is to setup the automated update of the virus database. This is a important step, because the speed of virus spreading is fast and would pick up even further.</P
><P
>Create the needed logfiles</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>touch /var/log/clam-update.log
chmod 600 /var/log/clam-update.log
chown clamav /var/log/clam-update.log</PRE
></FONT
></TD
></TR
></TABLE
><P
>I suggest to update the signatures with a hourly cronjob. To edit the crontab issue <B
CLASS="COMMAND"
>crontab -e</B
> and add the following line, and replace the »x« with a random value between 1 and 59. This is some kind of time based loadbalancing to ensure more people can fetch the updated.</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>#x * * * *       /usr/local/bin/freshclam --quiet -l /var/log/clam-update.log</PRE
></FONT
></TD
></TR
></TABLE
><P
>To test if the update process is working, please issue the command <B
CLASS="COMMAND"
>/usr/local/bin/freshclam -l /var/log/clam-update.log</B
> and have a look at the output.</P
><P
>The output should look similar to this:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>ClamAV update process started at Tue Mar 23 19:58:11 2004
Reading CVD header (main.cvd): OK
Downloading main.cvd [*]
main.cvd updated (version: 21, sigs: 20094, f-level: 1, builder: tkojm)
Reading CVD header (daily.cvd): OK
Downloading daily.cvd [*]
daily.cvd updated (version: 210, sigs: 596, f-level: 1, builder: acab)
Database updated (20690 signatures) from database.clamav.net (64.74.124.90).</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="RAZOR"
></A
>11.2. Razor</H2
><P
>Razor is one of the prerequisites of spamassassin.</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN816"
></A
>11.2.1. Download</H3
><P
>Origin-Site: <A
HREF="http://prdownloads.sourceforge.net/razor/razor-agents-sdk-2.03.tar.gz?download"
TARGET="_top"
>http://prdownloads.sourceforge.net/razor/razor-agents-sdk-2.03.tar.gz?download</A
></P
><P
>Origin-Site: <A
HREF="http://prdownloads.sourceforge.net/razor/razor-agents-2.40.tar.gz?download"
TARGET="_top"
>http://prdownloads.sourceforge.net/razor/razor-agents-2.40.tar.gz?download</A
>

<TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local

tar -xvzf razor-agents-sdk-2.03.tar.gz
cd razor-agents-sdk-2.03

perl Makefile.PL
make &#38;&#38; make install

cd /usr/local
tar -xvzf razor-agents-2.40.tar.gz
cd razor-agents-2.40/

perl Makefile.PL
make &#38;&#38; make install</PRE
></FONT
></TD
></TR
></TABLE
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN823"
></A
>11.2.2. Registering and setting up</H3
><P
>In order to use razor2 you need to register yourself as a user</P
><P
>Choose a unique username and password and issue <B
CLASS="COMMAND"
>razor-admin -register -user=some_user -pass=somepass</B
></P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="GET-SPAMASSASSIN"
></A
>11.3. Getting and installing spamassassin</H2
><P
>Spamassassin is the todays leading opensource project to fight against SPAM. To describe how spamassassin works would be too much for this document. For further information please consult <A
HREF="http://eu.spamassassin.org/doc.html"
TARGET="_top"
>http://eu.spamassassin.org/doc.html</A
></P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN832"
></A
>11.3.1. Download</H3
><P
>Origin-Site: <A
HREF="http://eu.spamassassin.org/released/Mail-SpamAssassin-2.63.tar.gz"
TARGET="_top"
>http://eu.spamassassin.org/released/Mail-SpamAssassin-2.63.tar.gz</A
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN836"
></A
>11.3.2. Prerequisites</H3
><P
>Spamassassin depends on a lot of prerequisites. The easiest way is using the CPAN repository. Issue the command <B
CLASS="COMMAND"
>perl -MCPAN -e shell</B
> and answer all questions as needed.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN840"
></A
>11.3.3. Building and installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local

tar -xvzf Mail-SpamAssassin-2.63.tar.gz

cd Mail-SpamAssassin-2.63

perl Makefile.PL

# You get prompted to run Razor tests which you should answer with "y"
Run Razor v2 tests (these may fail due to network problems)? (y/n) [n] y 

make &#38;&#38; make install</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="AMAVIS-INSTALL"
></A
>11.4. Getting and installing amavisd-new</H2
><P
>Amavisd-new is the software that glues all the software described above together to postfix</P
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN846"
></A
>11.4.1. Download</H3
><P
>Origin-Site: <A
HREF="http://www.ijs.si/software/amavisd/amavisd-new-20030616-p8.tar.gz"
TARGET="_top"
>http://www.ijs.si/software/amavisd/amavisd-new-20030616-p8.tar.gz</A
>&#13;</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN850"
></A
>11.4.2. Prerequisites</H3
><P
>Amavisd-new needs a lot of prerequisites.</P
><P
>Run <B
CLASS="COMMAND"
>perl -MCPAN -e shell</B
> and issue:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>install ExtUtils::MakeMaker
install HTML::Parser
install DB_File
install Digest::SHA1
install Archive::Tar
install Archive::Zip
install Compress::Zlib
install Convert::TNEF
install Convert::UUlib
install MIME::Base64
install MIME::Parser
install Mail::Internet
install Mail::SPF::Query
install Net::Server
install Net::SMTP
install Net::DNS
install Digest::MD5
install IO::Stringy
install Time::HiRes
install Unix::Syslog</PRE
></FONT
></TD
></TR
></TABLE
><P
>At the end run <B
CLASS="COMMAND"
>./amavisd</B
> and have a look at overseen prerequisites.</P
><P
>Edit <TT
CLASS="FILENAME"
>/etc/amavisd.conf</TT
> and change the variables <TT
CLASS="VARNAME"
>$daemon_user</TT
> to »amavis« and <TT
CLASS="VARNAME"
>$daemon_group</TT
> to »amavis«. Another variable to change is <TT
CLASS="VARNAME"
>$mydomain to match your domain.</TT
></P
><P
>Please also consider to change the default settings for virus and spam mails to avoid being notified about every intercepted mail</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>$final_virus_destiny      = D_DISCARD;  # (defaults to D_BOUNCE)
$final_spam_destiny       = D_DISCARD;  # (defaults to D_REJECT)</PRE
></FONT
></TD
></TR
></TABLE
><P
>In the beginning of SPAM filtering I recommend to set the kill-value to something higher until you tweaked the filters. Change the variable <TT
CLASS="VARNAME"
>$sa_kill_level_deflt</TT
> to 8 or even higher.</P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN867"
></A
>11.4.3. Building and installing</H3
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>cd /usr/local

tar -xvzf amavisd-new-20030616-p8.tar.gz

cd amavisd-new-20030616
cp amavisd /usr/local/sbin
cp amavisd.conf /etc
chown root /etc/amavisd.conf
chmod 644  /etc/amavisd.conf</PRE
></FONT
></TD
></TR
></TABLE
><P
>Now it is the the time to define a group and a user for amavisd-new</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>groupadd amavis
useradd -g amavis -c "Amavisd-new user" amavis</PRE
></FONT
></TD
></TR
></TABLE
><P
>Next you have to define a directory for the quarantined mail:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>mkdir /var/virusmails
chown amavis:amavis /var/virusmails
chmod 750 /var/virusmails
mkdir /var/amavis
chown amavis:amavis /var/amavis
chmod 750 /var/amavis</PRE
></FONT
></TD
></TR
></TABLE
><P
>The original init script in the amavisd-new distribution does only work work with Redhat. Other distributions need to install my quick and dirty init-script:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>#!/bin/bash
#
# Amavisd-new startup script

case "$1" in
    start)
        # Starting amavisd
        /usr/local/sbin/amavisd
        ;;

    stop)

	# follows later

        ;;

    *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;

esac</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="POSTFIX-SETUP"
></A
>11.5. Setting up postfix</H2
><P
>Postfix needs to be configured to send each mail to amavis-new in order to get sanitized.</P
><P
>You need to add the following line to <TT
CLASS="FILENAME"
>/etc/postfix/main.cf</TT
></P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>content_filter = smtp-amavis:127.0.0.1:10024</PRE
></FONT
></TD
></TR
></TABLE
><P
>The <TT
CLASS="FILENAME"
>/etc/postfix/master.cf</TT
> needs also some adjustments to return the results from amavisd-new to the mailingsystem.</P
><P
>Please add the following lines to your configuration:</P
><TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>smtp-amavis unix - - y - 2 smtp -o smtp_data_done_timeout=1200

127.0.0.1:10025 inet n  -       n       -       -  smtpd
    -o content_filter=
    -o local_recipient_maps=
    -o relay_recipient_maps=
    -o smtpd_restriction_classes=
    -o smtpd_client_restrictions=
    -o smtpd_helo_restrictions=
    -o smtpd_sender_restrictions=
    -o smtpd_recipient_restrictions=permit_mynetworks,reject
    -o mynetworks=127.0.0.0/8
    -o strict_rfc821_envelopes=yes
    -o smtpd_error_sleep_time=0
    -o smtpd_soft_error_limit=1001
    -o smtpd_hard_error_limit=1000</PRE
></FONT
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="MOREINFO"
></A
>12. Further Information</H1
><P
>	Here you will find some other resources available in the internet.
  </P
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="NEWSGROUPS"
></A
>12.1. News groups</H2
><P
>Some of the most interesting news groups are:

    <P
></P
><UL
><LI
><P
>       <A
HREF="news:alt.comp.mail.postfix"
TARGET="_top"
>alt.comp.mail.postfix</A
>
      </P
><P
>This is low traffic group.</P
></LI
><LI
><P
>       <A
HREF="news:comp.mail.imap"
TARGET="_top"
>comp.mail.imap</A
>
      </P
></LI
></UL
>
   </P
><P
>Maybe you also check out your country newsgroups e.g ch.comp.os.linux</P
><P
>    Most newsgroups have their own FAQ that are designed to answer most
    of your questions, as the name Frequently Asked Questions indicate.
    Fresh versions should be posted regularly to the relevant newsgroups.
    If you cannot find it in your news spool you could go directly to the
    <A
HREF="ftp://rtfm.mit.edu/"
TARGET="_top"
>FAQ main archive FTP site</A
>.
    The WWW versions can be browsed at the 
    <A
HREF="http://www.cis.ohio-state.edu/hypertext/faq/usenet/FAQ-List.html"
TARGET="_top"
>FAQ
    main archive WWW site</A
>.
   </P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="MAILLISTS"
></A
>12.2. Mailing Lists</H2
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN912"
></A
>12.2.1. <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:postfix-users at postfix.org"
>postfix-users at postfix.org</A
>&#62;</TT
></H3
><P
>   Send an mail to <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:majordomo at postfix.org"
>majordomo at postfix.org</A
>&#62;</TT
> with the content (not subject):
<TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>subscribe postfix-users</PRE
></FONT
></TD
></TR
></TABLE
> </P
><P
>Before writing to the list, check out the archive: <A
HREF="http://www.deja.com/group/mailing.postfix.users"
TARGET="_top"
>   http://www.deja.com/group/mailing.postfix.users</A
></P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN920"
></A
>12.2.2. <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:info-cyrus at lists.andrew.cmu.edu"
>info-cyrus at lists.andrew.cmu.edu</A
>&#62;</TT
></H3
><P
>Send an mail to <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:majordomo at lists.andrew.cmu.edu"
>majordomo at lists.andrew.cmu.edu</A
>&#62;</TT
> with the content (not subject):
<TABLE
BORDER="1"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><FONT
COLOR="#000000"
><PRE
CLASS="SCREEN"
>subscribe info-cyrus</PRE
></FONT
></TD
></TR
></TABLE
> </P
><P
>Before writing to the list, check out the archive: 
   <A
HREF="http://asg.web.cmu.edu/archive/index.php?mailbox=archive.info-cyrus"
TARGET="_top"
>   http://asg.web.cmu.edu/archive/index.php?mailbox=archive.info-cyrus </A
></P
></DIV
><DIV
CLASS="SECT3"
><HR><H3
CLASS="SECT3"
><A
NAME="AEN928"
></A
>12.2.3. <TT
CLASS="EMAIL"
>&#60;<A
HREF="mailto:web-cyradm at web-cyradm.org"
>web-cyradm at web-cyradm.org</A
>&#62;</TT
></H3
><P
>   Subscription can be done trough the webinterface <A
HREF="http://www.web-cyradm.org/mailman/listinfo/web-cyradm"
TARGET="_top"
>	http://www.web-cyradm.org/mailman/listinfo/web-cyradm</A
>

   </P
><P
>Before writing to the list, check out the archive for similar incidents:
   <A
HREF="http://www.web-cyradm.org/pipermail/web-cyradm/"
TARGET="_top"
>http://www.web-cyradm.org/pipermail/web-cyradm/
	</A
>

  </P
></DIV
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="HOWTO"
></A
>12.3. HOWTO</H2
><P
>    This are intended as the primary starting points to get the
    background information as well as show you how to solve a
    specific problem. Some relevant HOWTOs are
    <TT
CLASS="LITERAL"
><A
HREF="http://www.tldp.org/HOWTO/Cyrus-IMAP.html"
TARGET="_top"
>Cyrus-IMAP</A
></TT
> and 
    <TT
CLASS="LITERAL"
><A
HREF="http://www.tldp.org/HOWTO/Apache-Compile-HOWTO/index.html"
TARGET="_top"
>	Apache-Compile-HOWTO</A
></TT
>.  The main site for these is the
    <A
HREF="http://www.tldp.org/"
TARGET="_top"
>LDP archive</A
>.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="EBOOKS"
></A
>12.4. Ebooks</H2
><P
>There a few other HOWTOs and freely available documentations outside of the TLDP.org</P
><P
>IBM recently released a new Redbook:
	<TT
CLASS="LITERAL"
><A
HREF="http://www.redbooks.ibm.com/redbooks/pdfs/sg247034.pdf"
TARGET="_top"
>BladeCenter, Linux, and Open Source: Blueprint for e-business on demand</A
>.</TT
>Especially chapter 6 is interesting when looking for email solutions.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="LOCAL-RES"
></A
>12.5. Local Resources</H2
><P
>	Usually distributions installs some documentation to your system. As a standard they are
	located in <TT
CLASS="FILENAME"
>/usr/share/doc/packages</TT
></P
><P
>The SuSE rpms of Cyrus contains a lot a such documentation.</P
><P
>Postfix has some html-files in the source directory <TT
CLASS="FILENAME"
>/usr/local/postfix-2.0.16/html</TT
></P
><P
>PAM comes also with lots of documentation in <TT
CLASS="FILENAME"
>/usr/share/doc/packages/pam</TT
></P
><P
>The pam_mysql module has a README with the incredible size of 1670 bytes.</P
></DIV
><DIV
CLASS="SECT2"
><HR><H2
CLASS="SECT2"
><A
NAME="WEB"
></A
>12.6. Web Sites</H2
><P
>    There are a huge number of informative web sites available. By
    their very nature they change quickly so do not be surprised
    if these links become quickly outdated.
   </P
><P
>    A good starting point is of course the 
    <A
HREF="http://www.tldp.org/"
TARGET="_top"
>Linux Documentation
    Project</A
> home page, an information central for
    documentation, project pages and much more.
   </P
><P
>	To get more deepened information about Postfix, then <A
HREF="http://www.postfix.org"
TARGET="_top"
>www.postfix.org</A
>
	would be the starting point.
   </P
><P
>    Please let me know if you have any other leads that can be 
    of interest.
   </P
></DIV
></DIV
><DIV
CLASS="SECT1"
><HR><H1
CLASS="SECT1"
><A
NAME="FAQ"
></A
>13. Questions and Answers</H1
><P
>	Here I answer the questions which I got from users. If you don't find an answer feel free to contact me</P
><DIV
CLASS="QANDASET"
><DL
><DT
>1. <A
HREF="#AEN979"
>FAQ</A
></DT
><DD
><DL
><DT
>13.1.1. <A
HREF="#AEN982"
>Does web-cyradm only support users like »test0001« ? I'd like to have a more descriptive username</A
></DT
><DT
>13.1.2. <A
HREF="#AEN988"
>	Messages are bouncing. Postfix/pipe complains that "Mailbox does not exist". Whats wrong?
	</A
></DT
><DT
>13.1.3. <A
HREF="#AEN993"
>	web-cyradm complains about »Fatal error: Call to undefined function: bindtextdomain()
 	in /www/web-cyradm-0.5.3/index.php on line 46«, whats wrong?
     </A
></DT
><DT
>13.1.4. <A
HREF="#AEN1000"
>	I got a error from Web-cyradm like this »Fatal error: Call to undefined function: query() in
	/usr/local/httpd/htdocs/web-cyradm/auth.inc.php on line 17«
	</A
></DT
><DT
>13.1.5. <A
HREF="#AEN1006"
>      Why MySQL and not LDAP?
     </A
></DT
><DT
>13.1.6. <A
HREF="#AEN1011"
>      Why Postfix and not Qmail?
     </A
></DT
><DT
>13.1.7. <A
HREF="#AEN1016"
>      I got a Error: "Temporary lookup failure"
     </A
></DT
><DT
>13.1.8. <A
HREF="#AEN1023"
>      For what platforms does this HOWTO work?
     </A
></DT
></DL
></DD
></DL
><DIV
CLASS="QANDADIV"
><H3
><A
NAME="AEN979"
></A
>1. FAQ</H3
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN982"
></A
><B
>13.1.1. </B
>Does web-cyradm only support users like »test0001« ? I'd like to have a more descriptive username</P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>	web-cyradm does also support usernames like »user.name.example.com« if you configure it.
	Your need to change config.inc.php and change the value of DOMAIN_AS_PREFIX to 1. then you need to add
	»unixhierarchysep: yes« to your <TT
CLASS="FILENAME"
>/etc/imapd.conf</TT
>
	</P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN988"
></A
><B
>13.1.2. </B
>	Messages are bouncing. Postfix/pipe complains that "Mailbox does not exist". Whats wrong?
	</P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>	Check that the cyrus login on web-cyradm (config.inc.php) is correct.
	The username and password must exist in MySQL on table accountuser. 
	Web-cyradm will not complain if the cyrus login info is incorrect.
	</P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN993"
></A
><B
>13.1.3. </B
>	web-cyradm complains about »Fatal error: Call to undefined function: bindtextdomain()
 	in /www/web-cyradm-0.5.3/index.php on line 46«, whats wrong?
     </P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>	Web-cyradm needs gettext enabled PHP. Please compile PHP with the configure-option --with-gettext.
	</P
><P
>	
	gettext is needed for NLS (Native Language Support) which means
	contributors can easily translate web-cyradm to there language. Fill in your Language in the file
	<TT
CLASS="FILENAME"
>/usr/local/apache/htdocs/web-cyradm/locale/templates/web-cyradm.pot</TT
> and send me
	the file, then your language will be supported in the next CVS snapshot</P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN1000"
></A
><B
>13.1.4. </B
>	I got a error from Web-cyradm like this »Fatal error: Call to undefined function: query() in
	/usr/local/httpd/htdocs/web-cyradm/auth.inc.php on line 17«
	</P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>	Web-cyradm depends on PEAR for database abstraction. PEAR is included in recent PHP versions. Often
	PEAR is a separate package, check out the package base of your distribution. I strongly suggest to update
	to the most recent version of PHP anyway, because a lot of bugs have been fixed.</P
><P
>Another reason could be an authentication error with MySQL. Be sure the user »mail« has enough
	rights to access the database and tables.</P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN1006"
></A
><B
>13.1.5. </B
>      Why MySQL and not LDAP?
     </P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>      Good question. LDAP is role-based and it would be indeed a better solution for such applications. 
      Unfortunately LDAP is very hard to set up. You have to make proper schemes etc. MySQL is the 
      way strait ahead, it is very easy to handle and versatile. There is a PAM module available 
      for LDAP, feel free to use it.
     </P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN1011"
></A
><B
>13.1.6. </B
>      Why Postfix and not Qmail?
     </P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>      Lots of people like to see such a setup with Qmail. The reason why is, Mysql-support is a hack and not in the
      included in the main source-tree. This could end up in a bad situation. Think if a security-hole is found in qmail
      and the patch does not work with the corrected version. Postfix is supporting MySQL natively. 
      Another (personal) reason is that I find Postfix more sympatic (I don't know why)
     </P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN1016"
></A
><B
>13.1.7. </B
>      I got a Error: "Temporary lookup failure"
     </P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>      Postfix cannot look up the alias table. Must common failure is that MySQL is not running, 
      or there is a authentication Error. Check <TT
CLASS="FILENAME"
>/var/log/mail</TT
> and 
      <TT
CLASS="FILENAME"
>/usr/local/mysql/var/&#60;hostname&#62;.err</TT
> to track the error.
     </P
></DIV
></DIV
><DIV
CLASS="QANDAENTRY"
><DIV
CLASS="QUESTION"
><P
><A
NAME="AEN1023"
></A
><B
>13.1.8. </B
>      For what platforms does this HOWTO work?
     </P
></DIV
><DIV
CLASS="ANSWER"
><P
><B
> </B
>      It is primarily for Linux. Until now I only tested it on Linux/IA32. Most probably it will also work on other 
      architectures.
      FreeBSD is reported working fine. AIX has problems with at least PHP. Please report if you got it running 
      on other platform, so I can update this section.
     </P
></DIV
></DIV
></DIV
></DIV
></DIV
></DIV
></BODY
></HTML
>